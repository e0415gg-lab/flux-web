<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Flux v4.2 Stable (Poop Only Gate)</title>

  <style>
    :root{
      --bg1:#eaf0ff;
      --bg2:#f7f7ff;
      --text:#111;
      --muted:#6b7280;
      --card:#ffffffcc;
      --border:#e5e7eb;
      --shadow:0 20px 60px rgba(0,0,0,.08);
      --primary:#111;
      --primaryText:#fff;
      --danger:#b91c1c;
      --warn:#a16207;
      --ok:#166534;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 30% 0%, #dfeaff 0%, transparent 60%),
        radial-gradient(1200px 700px at 80% 70%, #e9fff6 0%, transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .app{
      width:min(460px, 100%);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(8px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid var(--border);
      background:#ffffffb3;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .brand .dot{
      width:10px;height:10px;border-radius:50%;
      background:linear-gradient(135deg,#111,#666);
    }
    .iconBtn{
      width:40px;height:40px;border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      display:grid;place-items:center;
      cursor:pointer;
    }
    .iconBtn:active{transform:scale(.98);}
    .content{padding:18px;}

    .hero{
      text-align:center;
      padding:8px 8px 6px;
    }
    .hero .hello{
      font-size:28px;
      font-weight:900;
      margin:6px 0 6px;
    }
    .hero .sub{
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
      margin:0 0 14px;
    }

    .bigCircle{
      margin:12px auto 14px;
      width:220px;height:220px;
      border-radius:999px;
      border:1px solid var(--border);
      background:radial-gradient(circle at 50% 40%, #fff, #f4f6ff);
      display:grid;
      place-items:center;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .bigCircle:active{transform:scale(.99);}
    .bigCircle .ring{
      position:absolute;
      width:100%;
      height:100%;
      border-radius:999px;
      box-shadow:inset 0 0 0 16px rgba(0,0,0,.03);
    }
    .bigCircle .cam{
      font-size:52px;
      opacity:.95;
    }
    .bigCircle .label{
      position:absolute;
      bottom:18px;
      font-size:13px;
      color:var(--muted);
    }

    .row{
      display:flex;
      gap:10px;
    }
    .btn{
      flex:1;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      font-size:15px;
      font-weight:700;
      cursor:pointer;
    }
    .btn.primary{
      background:var(--primary);
      color:var(--primaryText);
      border-color:var(--primary);
    }
    .btn:active{transform:scale(.985);}
    .hint{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
      line-height:1.5;
    }

    .nav{
      display:flex;
      gap:8px;
      padding:10px 12px 14px;
      border-top:1px solid var(--border);
      background:#ffffffb3;
    }
    .tab{
      flex:1;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      color:#111;
    }
    .tab.active{
      background:#111;
      border-color:#111;
      color:#fff;
    }

    .panelTitle{
      font-size:18px;
      font-weight:900;
      margin:4px 0 12px;
    }

    .card{
      border:1px solid var(--border);
      background:#fff;
      border-radius:20px;
      padding:16px;
    }

    .resultWrap{
      text-align:center;
      padding:10px 8px 0;
    }
    .emoji{
      font-size:56px;
      margin-top:6px;
    }
    .score{
      font-size:72px;
      font-weight:900;
      margin:8px 0 6px;
      letter-spacing:.5px;
    }
    .msg{
      font-size:15px;
      color:#111;
      font-weight:800;
      margin:0 0 6px;
    }
    .desc{
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
      margin:0;
    }
    .disclaimer{
      margin-top:14px;
      font-size:12px;
      color:#9ca3af;
      text-align:center;
      line-height:1.5;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
    }
    .item .left{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
    }
    .pill{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fafafa;
      color:#111;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .input{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--border);
      font-size:16px;
      background:#fff;
      outline:none;
    }
    .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }

    .modalMask{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:min(460px, 100%);
      background:#0b0b0bcc;
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      padding:18px;
      color:#fff;
      backdrop-filter: blur(10px);
    }
    .modalTitle{
      text-align:center;
      font-weight:900;
      font-size:18px;
      margin:4px 0 14px;
    }
    .modalText{
      text-align:center;
      color:rgba(255,255,255,.75);
      font-size:13px;
      line-height:1.6;
      margin:0 0 16px;
    }
    .modalRow{
      display:flex;
      gap:12px;
      margin-top:10px;
    }
    .mBtn{
      flex:1;
      padding:14px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:#fff;
      font-size:15px;
      font-weight:900;
      cursor:pointer;
    }
    .mBtn:active{transform:scale(.985);}
    .closeX{
      position:absolute;
      left:18px;
      top:18px;
      width:40px;height:40px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:#fff;
      display:grid;place-items:center;
      cursor:pointer;
    }

    .hidden{display:none !important;}
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand"><span class="dot"></span> Flux</div>
      <button class="iconBtn" id="gearBtn" title="è¨­å®š">âš™ï¸</button>
    </div>

    <div class="content">

      <!-- TODAY -->
      <section id="pageToday">
        <div class="hero">
          <div class="hello" id="helloText">æ—©å®‰ï¼Œåˆ©è“‰ã€‚</div>
          <p class="sub" id="todaySubtitle">æœ€è¿‘æ•´é«”ç‹€æ…‹å¾ˆç©©å®šã€‚</p>

          <div class="bigCircle" id="bigCircle">
            <div class="ring"></div>
            <div class="cam">ğŸ“·</div>
            <div class="label" id="circleHint">æ‹ä¸‹ä»Šå¤©çš„ç‹€æ…‹</div>
          </div>

          <div class="row">
            <button class="btn primary" id="btnChoose">é¸æ“‡æ–¹å¼</button>
            <button class="btn" id="btnGallery">å¾ç›¸ç°¿é¸æ“‡</button>
          </div>

          <div class="hint" id="hintText">
            ç¬¬ä¸€æ¬¡éœ€è¦å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚<br/>
            âš ï¸ åƒ…æ¥å—ã€Œç›®æ¨™ç‰©ç…§ç‰‡ã€ï¼Œéç›®æ¨™ç‰©æœƒé¡¯ç¤ºã€Œæ¨£æœ¬ç„¡æ•ˆã€ã€‚
          </div>
        </div>
      </section>

      <!-- RESULT -->
      <section id="pageResult" class="hidden">
        <div class="panelTitle">ä»Šæ—¥ç‹€æ…‹</div>
        <div class="card">
          <div class="resultWrap">
            <div class="emoji" id="resEmoji">ğŸ¥º</div>
            <div class="score" id="resScore">--</div>
            <div class="msg" id="resMsg">æ¨£æœ¬ç„¡æ•ˆ</div>
            <p class="desc" id="resDesc">è«‹æ‹æ”ç›®æ¨™ç‰©ï¼ˆå…‰ç·šå……è¶³ã€æ¸…æ™°ï¼‰ã€‚</p>

            <div class="row" style="margin-top:14px;">
              <button class="btn primary" id="btnAgain">å†æ¸¬ä¸€æ¬¡</button>
              <button class="btn" id="btnHome">è¿”å›</button>
            </div>

            <div class="disclaimer">
              æ­¤ App åƒ…ç”¨æ–¼æ—¥å¸¸è§€å¯Ÿèˆ‡è¨˜éŒ„ï¼Œä¸ä»£è¡¨å¥åº·æˆ–é†«ç™‚åˆ¤æ–·ã€‚
            </div>
          </div>
        </div>
      </section>

      <!-- RECORDS -->
      <section id="pageRecords" class="hidden">
        <div class="panelTitle">æˆ‘çš„ç´€éŒ„</div>
        <div class="list" id="recordList"></div>
        <div class="hint">ï¼ˆæœ¬æ©Ÿå„²å­˜ï¼Œä¸ä¸Šå‚³ä¼ºæœå™¨ï¼‰</div>
      </section>

      <!-- INSIGHTS -->
      <section id="pageInsights" class="hidden">
        <div class="panelTitle">æ´å¯Ÿ</div>
        <div class="card">
          <div style="font-weight:900;font-size:16px;margin-bottom:6px;" id="insTitle">æœ¬é€±æ´å¯Ÿ</div>
          <div style="color:var(--muted);font-size:13px;line-height:1.6;" id="insBody">
            æ¯ 7 å¤©æœ€å¤šç”Ÿæˆä¸€æ¬¡æ´å¯Ÿï¼Œé¿å…éåº¦è§£è®€ã€‚
          </div>
          <div class="row" style="margin-top:14px;">
            <button class="btn primary" id="btnInsight">ç”¢ç”Ÿæ´å¯Ÿ</button>
            <button class="btn" id="btnClear">æ¸…é™¤è³‡æ–™</button>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="pageSettings" class="hidden">
        <div class="panelTitle">è¨­å®š</div>

        <div class="card">
          <div class="field">
            <div style="font-weight:900;">ç¨±å‘¼æ–¹å¼</div>
            <input class="input" id="nameInput" placeholder="ä¾‹å¦‚ï¼šåˆ©è“‰ / Lily" />
            <div class="small">ç”¨æ–¼é¦–é å•å€™ï¼Œå¯ç•™ç©ºã€‚</div>
            <button class="btn primary" id="btnSaveName">ä¿å­˜</button>
          </div>
        </div>

        <div style="height:12px;"></div>

        <div class="card">
          <div style="font-weight:900;margin-bottom:6px;">éš±ç§èˆ‡è³‡æ–™</div>
          <div class="small">
            æœ¬ App ä¸æœƒä¸Šå‚³ç…§ç‰‡ã€‚åƒ…ä½¿ç”¨ã€Œæª”æ¡ˆç‰¹å¾µï¼ˆaHashï¼‰ã€ç”Ÿæˆç©©å®šåˆ†æ•¸ä¸¦å¯«å…¥æœ¬æ©Ÿç´€éŒ„ã€‚
          </div>
        </div>

        <div style="height:12px;"></div>

        <div class="card">
          <div style="font-weight:900;margin-bottom:6px;">èªè¨€ / Language</div>
          <div class="row">
            <button class="btn" data-lang="zh">ä¸­æ–‡</button>
            <button class="btn" data-lang="en">English</button>
            <button class="btn" data-lang="ja">æ—¥æœ¬èª</button>
          </div>
        </div>

        <div style="height:12px;"></div>

        <div class="card">
          <div style="font-weight:900;margin-bottom:6px;">é—œæ–¼ Flux</div>
          <div class="small" id="aboutText">
            Flux v4.2 Stableï¼ˆPoop-only Gateï¼‰<br/>
            Hybrid Input Onlyï¼šä½¿ç”¨ç³»çµ±ç›¸æ©Ÿ / ç›¸ç°¿ï¼Œé¿å… WebView é»‘å±å•é¡Œã€‚
          </div>
        </div>
      </section>

      <!-- Hidden Inputs -->
      <input id="cameraInput" type="file" accept="image/*" capture="environment" class="hidden" />
      <input id="galleryInput" type="file" accept="image/*" class="hidden" />

    </div>

    <div class="nav">
      <button class="tab active" id="tabToday">â— ä»Šå¤©</button>
      <button class="tab" id="tabRecords">ğŸ“… ç´€éŒ„</button>
      <button class="tab" id="tabInsights">âœ¨ æ´å¯Ÿ</button>
    </div>
  </div>

  <!-- Choose Modal -->
  <div class="modalMask" id="modalMask">
    <div class="modal" style="position:relative;">
      <button class="closeX" id="modalClose">âœ•</button>
      <div class="modalTitle" id="modalTitle">é¸æ“‡æ–¹å¼</div>
      <div class="modalText" id="modalText">ä½ è¦æ‹ç…§ï¼Œé‚„æ˜¯å¾ç›¸ç°¿é¸ä¸€å¼µï¼Ÿ</div>
      <div class="modalRow">
        <button class="mBtn" id="modalCamera">ğŸ“· æ‹ç…§</button>
        <button class="mBtn" id="modalGallery">ğŸ–¼ï¸ ç›¸ç°¿</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // i18n
    // =========================
    const I18N = {
      zh: {
        today: "ä»Šå¤©",
        records: "ç´€éŒ„",
        insights: "æ´å¯Ÿ",
        settings: "è¨­å®š",
        hello: (name)=> `æ—©å®‰ï¼Œ${name || "ä½ "}ã€‚`,
        stable: "æœ€è¿‘æ•´é«”ç‹€æ…‹å¾ˆç©©å®šã€‚",
        takeToday: "æ‹ä¸‹ä»Šå¤©çš„ç‹€æ…‹",
        needPerm: "ç¬¬ä¸€æ¬¡éœ€è¦å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚",
        onlyTarget: "âš ï¸ åƒ…æ¥å—ã€Œç›®æ¨™ç‰©ç…§ç‰‡ã€ï¼Œéç›®æ¨™ç‰©æœƒé¡¯ç¤ºã€Œæ¨£æœ¬ç„¡æ•ˆã€ã€‚",
        choose: "é¸æ“‡æ–¹å¼",
        fromGallery: "å¾ç›¸ç°¿é¸æ“‡",
        modalQ: "ä½ è¦æ‹ç…§ï¼Œé‚„æ˜¯å¾ç›¸ç°¿é¸ä¸€å¼µï¼Ÿ",
        camera: "æ‹ç…§",
        gallery: "ç›¸ç°¿",
        todayState: "ä»Šæ—¥ç‹€æ…‹",
        again: "å†æ¸¬ä¸€æ¬¡",
        back: "è¿”å›",
        invalid: "æ¨£æœ¬ç„¡æ•ˆ",
        invalidDesc: "è«‹æ‹æ”ç›®æ¨™ç‰©ï¼ˆå…‰ç·šå……è¶³ã€æ¸…æ™°ï¼‰ã€‚",
        disclaimer: "æ­¤ App åƒ…ç”¨æ–¼æ—¥å¸¸è§€å¯Ÿèˆ‡è¨˜éŒ„ï¼Œä¸ä»£è¡¨å¥åº·æˆ–é†«ç™‚åˆ¤æ–·ã€‚",
        recTitle: "æˆ‘çš„ç´€éŒ„",
        recEmpty: "ç›®å‰æ²’æœ‰ç´€éŒ„",
        weekTitle: "æœ¬é€±æ´å¯Ÿ",
        weekBody: "æ¯ 7 å¤©æœ€å¤šç”Ÿæˆä¸€æ¬¡æ´å¯Ÿï¼Œé¿å…éåº¦è§£è®€ã€‚",
        genInsight: "ç”¢ç”Ÿæ´å¯Ÿ",
        clear: "æ¸…é™¤è³‡æ–™",
        cleared: "å·²æ¸…é™¤è³‡æ–™",
        nameLabel: "ç¨±å‘¼æ–¹å¼",
        nameHint: "ç”¨æ–¼é¦–é å•å€™ï¼Œå¯ç•™ç©ºã€‚",
        save: "ä¿å­˜",
        saved: "å·²ä¿å­˜",
        privacyTitle: "éš±ç§èˆ‡è³‡æ–™",
        privacyBody: "æœ¬ App ä¸æœƒä¸Šå‚³ç…§ç‰‡ã€‚åƒ…ä½¿ç”¨ã€Œæª”æ¡ˆç‰¹å¾µï¼ˆaHashï¼‰ã€ç”Ÿæˆç©©å®šåˆ†æ•¸ä¸¦å¯«å…¥æœ¬æ©Ÿç´€éŒ„ã€‚",
        about: "é—œæ–¼ Flux",
        aboutBody: "Flux v4.2 Stableï¼ˆPoop-only Gateï¼‰\nHybrid Input Onlyï¼šä½¿ç”¨ç³»çµ±ç›¸æ©Ÿ / ç›¸ç°¿ï¼Œé¿å… WebView é»‘å±å•é¡Œã€‚",
        nonImage: "è«‹ä¸Šå‚³æœ‰æ•ˆç…§ç‰‡",
        lowSample: "æ¨£æœ¬ç„¡æ•ˆï¼ˆè«‹æ‹æ”ç›®æ¨™ç‰©ï¼‰",
        scoreLow: "ç›®å‰ç‹€æ…‹åä½ï¼Œå»ºè­°æŒçºŒè§€å¯Ÿè®ŠåŒ–ã€‚",
        scoreMid: "ç›®å‰ç‹€æ…‹æ­£å¸¸ã€‚",
        scoreHigh: "ç›®å‰ç‹€æ…‹è‰¯å¥½ã€‚"
      },
      en: {
        today: "Today",
        records: "Records",
        insights: "Insights",
        settings: "Settings",
        hello: (name)=> `Good day, ${name || "there"}.`,
        stable: "Overall state looks stable recently.",
        takeToday: "Capture today's state",
        needPerm: "First time requires camera permission.",
        onlyTarget: "âš ï¸ Target-only: non-target photos will show â€œInvalid sampleâ€.",
        choose: "Choose",
        fromGallery: "From gallery",
        modalQ: "Take a photo or pick one from your gallery?",
        camera: "Camera",
        gallery: "Gallery",
        todayState: "Today's Result",
        again: "Try again",
        back: "Back",
        invalid: "Invalid sample",
        invalidDesc: "Please capture the target clearly with good lighting.",
        disclaimer: "This app is for daily observation/recording only. Not medical advice.",
        recTitle: "My Records",
        recEmpty: "No records yet",
        weekTitle: "Weekly Insight",
        weekBody: "At most once every 7 days to avoid over-interpretation.",
        genInsight: "Generate insight",
        clear: "Clear data",
        cleared: "Data cleared",
        nameLabel: "Display name",
        nameHint: "Shown on the home greeting. Optional.",
        save: "Save",
        saved: "Saved",
        privacyTitle: "Privacy",
        privacyBody: "No photo uploads. We generate a stable score from file hash (aHash) and store records locally.",
        about: "About Flux",
        aboutBody: "Flux v4.2 Stable (Poop-only Gate)\nHybrid Input Only: system camera/gallery to avoid WebView black screen.",
        nonImage: "Please choose a valid image",
        lowSample: "Invalid sample (please capture the target)",
        scoreLow: "State is low. Keep observing.",
        scoreMid: "State looks normal.",
        scoreHigh: "State is good."
      },
      ja: {
        today: "ä»Šæ—¥",
        records: "è¨˜éŒ²",
        insights: "æ´å¯Ÿ",
        settings: "è¨­å®š",
        hello: (name)=> `ãŠã¯ã‚ˆã†ã€${name || "ã‚ãªãŸ"}ã€‚`,
        stable: "æœ€è¿‘ã®çŠ¶æ…‹ã¯å®‰å®šã—ã¦ã„ã¾ã™ã€‚",
        takeToday: "ä»Šæ—¥ã®çŠ¶æ…‹ã‚’æ’®å½±",
        needPerm: "åˆå›ã¯ã‚«ãƒ¡ãƒ©è¨±å¯ãŒå¿…è¦ã§ã™ã€‚",
        onlyTarget: "âš ï¸ å¯¾è±¡ç‰©ã®ã¿ï¼šå¯¾è±¡å¤–å†™çœŸã¯ã€Œç„¡åŠ¹ã€ã¨è¡¨ç¤ºã—ã¾ã™ã€‚",
        choose: "é¸æŠ",
        fromGallery: "ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰",
        modalQ: "æ’®å½±ã—ã¾ã™ã‹ï¼Ÿã‚¢ãƒ«ãƒãƒ ã‹ã‚‰é¸ã³ã¾ã™ã‹ï¼Ÿ",
        camera: "æ’®å½±",
        gallery: "ã‚¢ãƒ«ãƒãƒ ",
        todayState: "ä»Šæ—¥ã®çµæœ",
        again: "ã‚‚ã†ä¸€åº¦",
        back: "æˆ»ã‚‹",
        invalid: "ç„¡åŠ¹",
        invalidDesc: "å¯¾è±¡ç‰©ã‚’æ˜ã‚‹ãã€ã¯ã£ãã‚Šæ’®å½±ã—ã¦ãã ã•ã„ã€‚",
        disclaimer: "æœ¬ã‚¢ãƒ—ãƒªã¯æ—¥å¸¸è¦³å¯Ÿãƒ»è¨˜éŒ²ç”¨ã§ã‚ã‚Šã€åŒ»ç™‚åˆ¤æ–­ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
        recTitle: "ç§ã®è¨˜éŒ²",
        recEmpty: "è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“",
        weekTitle: "é€±é–“æ´å¯Ÿ",
        weekBody: "7æ—¥ã”ã¨ã«æœ€å¤§1å›ã¾ã§ï¼ˆéåº¦è§£é‡ˆã‚’é˜²ãï¼‰ã€‚",
        genInsight: "æ´å¯Ÿã‚’ç”Ÿæˆ",
        clear: "ãƒ‡ãƒ¼ã‚¿å‰Šé™¤",
        cleared: "å‰Šé™¤ã—ã¾ã—ãŸ",
        nameLabel: "å‘¼ã³å",
        nameHint: "ãƒ›ãƒ¼ãƒ ã®æŒ¨æ‹¶ã«è¡¨ç¤ºï¼ˆä»»æ„ï¼‰ã€‚",
        save: "ä¿å­˜",
        saved: "ä¿å­˜ã—ã¾ã—ãŸ",
        privacyTitle: "ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼",
        privacyBody: "å†™çœŸã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã›ã‚“ã€‚aHashã§å®‰å®šã‚¹ã‚³ã‚¢ã‚’ç”Ÿæˆã—ã€ç«¯æœ«å†…ã«ä¿å­˜ã—ã¾ã™ã€‚",
        about: "Fluxã«ã¤ã„ã¦",
        aboutBody: "Flux v4.2 Stableï¼ˆPoop-only Gateï¼‰\nHybrid Input Onlyï¼šWebViewé»’ç”»é¢å›é¿ã®ãŸã‚ã‚·ã‚¹ãƒ†ãƒ ã‚«ãƒ¡ãƒ©/ã‚¢ãƒ«ãƒãƒ ã‚’ä½¿ç”¨ã€‚",
        nonImage: "æœ‰åŠ¹ãªç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„",
        lowSample: "ç„¡åŠ¹ï¼ˆå¯¾è±¡ç‰©ã‚’æ’®å½±ã—ã¦ãã ã•ã„ï¼‰",
        scoreLow: "çŠ¶æ…‹ãŒä½ã‚ã§ã™ã€‚è¦³å¯Ÿã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚",
        scoreMid: "çŠ¶æ…‹ã¯æ­£å¸¸ã§ã™ã€‚",
        scoreHigh: "çŠ¶æ…‹ã¯è‰¯å¥½ã§ã™ã€‚"
      }
    };

    // =========================
    // State + Storage
    // =========================
    const LS = {
      lang: "flux_lang",
      name: "flux_name",
      records: "flux_records_v1",
      insightTs: "flux_insight_ts"
    };

    const state = {
      lang: localStorage.getItem(LS.lang) || "zh",
      name: localStorage.getItem(LS.name) || "åˆ©è“‰"
    };

    function t(){ return I18N[state.lang] || I18N.zh; }

    function loadRecords(){
      try{
        return JSON.parse(localStorage.getItem(LS.records) || "[]");
      }catch(e){
        return [];
      }
    }
    function saveRecords(arr){
      localStorage.setItem(LS.records, JSON.stringify(arr));
    }

    // =========================
    // UI Helpers
    // =========================
    const $ = (id)=> document.getElementById(id);

    function setActiveTab(tab){
      ["tabToday","tabRecords","tabInsights"].forEach(id=>$(id).classList.remove("active"));
      $(tab).classList.add("active");
    }
    function showPage(pageId){
      ["pageToday","pageRecords","pageInsights","pageSettings","pageResult"].forEach(id=>$(id).classList.add("hidden"));
      $(pageId).classList.remove("hidden");
    }

    function renderTexts(){
      const i = t();
      $("tabToday").innerText = "â— " + i.today;
      $("tabRecords").innerText = "ğŸ“… " + i.records;
      $("tabInsights").innerText = "âœ¨ " + i.insights;

      $("helloText").innerText = i.hello(state.name);
      $("todaySubtitle").innerText = i.stable;
      $("circleHint").innerText = i.takeToday;

      $("btnChoose").innerText = i.choose;
      $("btnGallery").innerText = i.fromGallery;

      $("hintText").innerHTML = `${i.needPerm}<br/>${i.onlyTarget}`;

      $("modalTitle").innerText = i.choose;
      $("modalText").innerText = i.modalQ;
      $("modalCamera").innerText = "ğŸ“· " + i.camera;
      $("modalGallery").innerText = "ğŸ–¼ï¸ " + i.gallery;

      $("btnAgain").innerText = i.again;
      $("btnHome").innerText = i.back;

      // Settings page texts
      // (labels are inside markup; we only update about text)
      $("aboutText").innerHTML = i.aboutBody.replaceAll("\n","<br/>");

      // Insights page
      $("insTitle").innerText = i.weekTitle;
      $("insBody").innerText = i.weekBody;
      $("btnInsight").innerText = i.genInsight;
      $("btnClear").innerText = i.clear;
    }

    // =========================
    // Modal
    // =========================
    function openModal(){ $("modalMask").style.display = "flex"; }
    function closeModal(){ $("modalMask").style.display = "none"; }

    // =========================
    // Poop-only Gate (Lightweight)
    // =========================
    // NOTE: Pure client-side, no real ML. We add guardrails so random photos won't be "analyzed".
    // Strategy:
    // 1) Reject non-image.
    // 2) Reject too-small files (often icons/screenshots/random).
    // 3) Quick visual heuristic: detect large low-saturation "scene" photos by downsampling and measuring color variance.
    //    If it looks like scenery/pet/indoor scene -> mark invalid.
    //    If it looks like close-up with strong chroma/contrast -> allow.
    //
    // This is NOT medical. It's just a "target-only gate" to stop obvious misuse.

    function loadImageFromFile(file){
      return new Promise((resolve,reject)=>{
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = ()=>{
          URL.revokeObjectURL(url);
          resolve(img);
        };
        img.onerror = (e)=>{
          URL.revokeObjectURL(url);
          reject(e);
        };
        img.src = url;
      });
    }

    function downsampleToCanvas(img, maxW=96, maxH=96){
      const c = document.createElement("canvas");
      const ctx = c.getContext("2d", { willReadFrequently: true });
      const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
      const w = Math.max(1, Math.round(img.width * ratio));
      const h = Math.max(1, Math.round(img.height * ratio));
      c.width = w; c.height = h;
      ctx.drawImage(img, 0, 0, w, h);
      return { c, ctx, w, h };
    }

    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function rgbToHsv(r,g,b){
      r/=255; g/=255; b/=255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b);
      const d = max - min;
      let h = 0;
      if(d !== 0){
        if(max === r) h = ((g - b) / d) % 6;
        else if(max === g) h = (b - r) / d + 2;
        else h = (r - g) / d + 4;
        h *= 60;
        if(h < 0) h += 360;
      }
      const s = max === 0 ? 0 : d / max;
      const v = max;
      return {h,s,v};
    }

    // returns {ok:boolean, reason:string}
    async function targetGate(file){
      const i = t();

      if(!file || !file.type || !file.type.startsWith("image/")){
        return { ok:false, reason:i.nonImage };
      }

      // Size guard: reject tiny images (icons/screenshots/exports)
      if(file.size < 90_000){
        return { ok:false, reason:i.lowSample };
      }

      // Dimension / color heuristic
      let img;
      try{
        img = await loadImageFromFile(file);
      }catch(e){
        return { ok:false, reason:i.lowSample };
      }

      // extremely small dimensions are suspicious
      if(img.width < 400 || img.height < 400){
        return { ok:false, reason:i.lowSample };
      }

      const { ctx, w, h } = downsampleToCanvas(img, 96, 96);
      const data = ctx.getImageData(0,0,w,h).data;

      let satSum=0, valSum=0;
      let valSq=0;
      let edgeLike=0;
      let prevV=null;

      // sample stride for speed
      const stride = 4 * 2; // every 2 pixels roughly
      for(let p=0; p<data.length; p+=stride){
        const r = data[p], g = data[p+1], b = data[p+2];
        const {s,v} = rgbToHsv(r,g,b);
        satSum += s;
        valSum += v;
        valSq += v*v;
        if(prevV !== null){
          const dv = Math.abs(v - prevV);
          if(dv > 0.22) edgeLike += 1;
        }
        prevV = v;
      }
      const n = Math.max(1, Math.floor(data.length / stride));
      const satAvg = satSum / n;
      const valAvg = valSum / n;
      const valVar = (valSq / n) - (valAvg*valAvg);
      const edgeRate = edgeLike / n;

      // Heuristic intuition:
      // - Close-up target shots tend to have: higher contrast variance (valVar), noticeable edges (edgeRate),
      //   and not too low saturation (satAvg).
      // - Scene photos/pets often have smoother gradients / broader composition -> lower edgeRate in downsample.
      //
      // We tune for "stop obvious random photos", not perfect classification.

      const scoreLike = 0.45*clamp01((valVar - 0.02)/0.08) + 0.35*clamp01((edgeRate - 0.10)/0.20) + 0.20*clamp01((satAvg - 0.10)/0.35);

      // If it looks like a generic scene, reject.
      if(scoreLike < 0.38){
        return { ok:false, reason:i.lowSample };
      }

      return { ok:true, reason:"ok" };
    }

    // =========================
    // aHash (stable) for score
    // =========================
    function aHashFromCanvas(ctx, w, h){
      // grayscale -> 8x8 -> average -> bitstring
      const size = 8;
      const c = document.createElement("canvas");
      const cctx = c.getContext("2d", { willReadFrequently: true });
      c.width = size; c.height = size;
      cctx.drawImage(ctx.canvas, 0,0,w,h, 0,0,size,size);
      const d = cctx.getImageData(0,0,size,size).data;

      let gray = new Array(size*size);
      let sum = 0;
      for(let i=0;i<size*size;i++){
        const r=d[i*4], g=d[i*4+1], b=d[i*4+2];
        const y = (r*0.299 + g*0.587 + b*0.114);
        gray[i]=y; sum+=y;
      }
      const avg = sum/(size*size);

      // build bits
      let bits = "";
      for(let i=0;i<gray.length;i++){
        bits += (gray[i] >= avg) ? "1" : "0";
      }

      // convert bits to int-like rolling hash
      let hash = 0;
      for(let i=0;i<bits.length;i++){
        hash = (hash*31 + (bits[i]==="1"?1:0)) >>> 0;
      }
      return hash;
    }

    async function stableScoreFromFile(file){
      const img = await loadImageFromFile(file);
      const { ctx, w, h } = downsampleToCanvas(img, 256, 256);
      const h32 = aHashFromCanvas(ctx, w, h);
      // map to 0..100
      const score = (h32 % 101); // 0-100
      return score;
    }

    // =========================
    // Result mapping + record
    // =========================
    function mapScore(score){
      const i = t();
      let emoji="ğŸ˜€", msg=i.scoreMid, desc="";

      if(score <= 30){
        emoji="ğŸ¥º"; msg=i.scoreLow;
      }else if(score <= 60){
        emoji="ğŸ˜€"; msg=i.scoreMid;
      }else{
        emoji="ğŸ˜†"; msg=i.scoreHigh;
      }
      desc = "";
      return {emoji, msg, desc};
    }

    function showResult({emoji, scoreText, msg, desc}){
      $("resEmoji").innerText = emoji;
      $("resScore").innerText = scoreText;
      $("resMsg").innerText = msg;
      $("resDesc").innerText = desc;

      showPage("pageResult");
      // keep bottom nav selection on Today for result
      setActiveTab("tabToday");
    }

    function addRecord(entry){
      const records = loadRecords();
      records.unshift(entry);
      saveRecords(records.slice(0, 120)); // cap
    }

    function renderRecords(){
      const i = t();
      const list = $("recordList");
      list.innerHTML = "";
      const records = loadRecords();

      if(!records.length){
        const empty = document.createElement("div");
        empty.className = "card";
        empty.style.textAlign = "center";
        empty.style.color = "var(--muted)";
        empty.style.fontWeight = "800";
        empty.innerText = i.recEmpty;
        list.appendChild(empty);
        return;
      }

      records.forEach(r=>{
        const row = document.createElement("div");
        row.className = "item";
        const left = document.createElement("div");
        left.className = "left";
        left.innerHTML = `<span style="font-size:20px;">${r.emoji}</span><span>${r.date}</span>`;
        const pill = document.createElement("div");
        pill.className = "pill";
        pill.innerText = (typeof r.score === "number") ? String(r.score) : "--";
        row.appendChild(left);
        row.appendChild(pill);
        list.appendChild(row);
      });
    }

    // =========================
    // Analyze pipeline (with Gate)
    // =========================
    async function analyzeFile(file){
      const i = t();
      if(!file) return;

      // Show "loading" quick
      showResult({
        emoji:"â³",
        scoreText:"--",
        msg:"åˆ†æä¸­â€¦",
        desc:""
      });

      // 1) Gate
      const gate = await targetGate(file);
      if(!gate.ok){
        showResult({
          emoji:"âš ï¸",
          scoreText:"--",
          msg:i.invalid,
          desc:gate.reason
        });
        return;
      }

      // 2) Stable score
      let score;
      try{
        score = await stableScoreFromFile(file);
      }catch(e){
        showResult({
          emoji:"âš ï¸",
          scoreText:"--",
          msg:i.invalid,
          desc:i.lowSample
        });
        return;
      }

      // 3) Map
      const mapped = mapScore(score);

      // 4) Save record (date)
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const dateStr = `${yyyy}-${mm}-${dd}`;

      addRecord({
        date: dateStr,
        score,
        emoji: mapped.emoji,
        ts: Date.now()
      });

      // 5) Render and show
      renderRecords();
      showResult({
        emoji: mapped.emoji,
        scoreText: `${score}`,
        msg: mapped.msg,
        desc: mapped.desc || ""
      });
    }

    // =========================
    // Weekly insight cooldown
    // =========================
    function canGenerateInsight(){
      const last = Number(localStorage.getItem(LS.insightTs) || "0");
      const now = Date.now();
      const sevenDays = 7 * 24 * 60 * 60 * 1000;
      return (now - last) >= sevenDays;
    }

    function setInsightTs(){
      localStorage.setItem(LS.insightTs, String(Date.now()));
    }

    function generateInsightText(){
      const i = t();
      const records = loadRecords();
      if(!records.length) return i.weekBody;

      // last 7 days
      const now = Date.now();
      const seven = 7*24*60*60*1000;
      const recent = records.filter(r => (now - (r.ts||0)) <= seven).slice(0, 30);

      if(!recent.length) return i.weekBody;

      const avg = recent.reduce((a,b)=>a+(b.score||0),0)/recent.length;
      const rounded = Math.round(avg);

      if(rounded <= 35) return `${i.weekTitle}ï¼šå¹³å‡ç´„ ${rounded}ã€‚å»ºè­°è¦å¾‹ä½œæ¯ã€æŒçºŒè§€å¯Ÿè¶¨å‹¢ã€‚`;
      if(rounded <= 65) return `${i.weekTitle}ï¼šå¹³å‡ç´„ ${rounded}ã€‚ç‹€æ…‹ç©©å®šï¼Œç¶­æŒç›®å‰ç¯€å¥ã€‚`;
      return `${i.weekTitle}ï¼šå¹³å‡ç´„ ${rounded}ã€‚ç‹€æ…‹è‰¯å¥½ï¼Œæ³¨æ„ä¸è¦éåº¦è§£è®€å–®æ¬¡æ³¢å‹•ã€‚`;
    }

    // =========================
    // Events
    // =========================
    function openCamera(){
      // IMPORTANT: must be triggered by user gesture
      $("cameraInput").value = "";
      $("cameraInput").click();
    }
    function openGallery(){
      $("galleryInput").value = "";
      $("galleryInput").click();
    }

    // Bottom tabs
    $("tabToday").addEventListener("click", ()=>{
      setActiveTab("tabToday");
      showPage("pageToday");
    });
    $("tabRecords").addEventListener("click", ()=>{
      setActiveTab("tabRecords");
      showPage("pageRecords");
      renderRecords();
    });
    $("tabInsights").addEventListener("click", ()=>{
      setActiveTab("tabInsights");
      showPage("pageInsights");
    });

    // Gear -> settings
    $("gearBtn").addEventListener("click", ()=>{
      showPage("pageSettings");
      // deactivate all tabs
      ["tabToday","tabRecords","tabInsights"].forEach(id=>$(id).classList.remove("active"));
      // fill input
      $("nameInput").value = state.name || "";
    });

    // Today interactions
    $("bigCircle").addEventListener("click", ()=>{
      // open camera directly for fastest
      openCamera();
    });
    $("btnChoose").addEventListener("click", openModal);
    $("btnGallery").addEventListener("click", openGallery);

    // Modal actions
    $("modalClose").addEventListener("click", closeModal);
    $("modalMask").addEventListener("click", (e)=>{
      if(e.target === $("modalMask")) closeModal();
    });
    $("modalCamera").addEventListener("click", ()=>{
      closeModal();
      openCamera();
    });
    $("modalGallery").addEventListener("click", ()=>{
      closeModal();
      openGallery();
    });

    // File inputs
    $("cameraInput").addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      analyzeFile(file);
    });
    $("galleryInput").addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      analyzeFile(file);
    });

    // Result buttons
    $("btnAgain").addEventListener("click", ()=>{
      // choose again
      openModal();
    });
    $("btnHome").addEventListener("click", ()=>{
      showPage("pageToday");
    });

    // Insights
    $("btnInsight").addEventListener("click", ()=>{
      const i = t();
      if(!canGenerateInsight()){
        $("insBody").innerText = "æœ¬é€±æ´å¯Ÿå·²ç”Ÿæˆï¼Œè«‹ 7 å¤©å¾Œå†è©¦ã€‚";
        return;
      }
      $("insBody").innerText = generateInsightText();
      setInsightTs();
    });

    $("btnClear").addEventListener("click", ()=>{
      const i = t();
      localStorage.removeItem(LS.records);
      localStorage.removeItem(LS.insightTs);
      renderRecords();
      $("insBody").innerText = i.cleared;
      alert(i.cleared);
    });

    // Settings: save name
    $("btnSaveName").addEventListener("click", ()=>{
      const i = t();
      state.name = ($("nameInput").value || "").trim() || "";
      localStorage.setItem(LS.name, state.name);
      $("helloText").innerText = i.hello(state.name);
      alert(i.saved);
    });

    // Settings: language
    document.querySelectorAll('[data-lang]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const lang = btn.getAttribute("data-lang");
        state.lang = lang;
        localStorage.setItem(LS.lang, lang);
        renderTexts();
        renderRecords();
      });
    });

    // Init
    renderTexts();
    renderRecords();
    showPage("pageToday");
  </script>
</body>
</html>
