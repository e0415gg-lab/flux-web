<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Flux</title>
  <style>
    :root{ --text:#333; --muted:#666; --line:rgba(0,0,0,.06); }
    *{box-sizing:border-box}
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; background:#fff; color:var(--text); }

    @keyframes fluxSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes fluxFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fluxPulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

    /* App wrapper */
    .app{ min-height:100vh; position:relative; overflow:hidden; }

    .page{
      position:absolute; inset:0; background:#fff;
      display:flex; flex-direction:column; z-index:10;
      animation: fluxFadeIn .18s ease-out;
    }
    .content{ flex:1; overflow:auto; padding:24px; padding-bottom:100px; }

    /* Home glow */
    .glowBg{
      position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(210,226,255,0.55), rgba(255,255,255,0) 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(255,220,210,0.45), rgba(255,255,255,0) 55%),
        radial-gradient(900px 700px at 50% 80%, rgba(220,245,235,0.40), rgba(255,255,255,0) 60%);
    }

    .topBar{
      height:56px; padding:0 18px;
      display:flex; align-items:center; justify-content:space-between;
      position:relative; z-index:20;
    }
    .brand{ font-size:18px; font-weight:700; letter-spacing:.5px; }
    .iconBtn{
      width:40px; height:40px; border-radius:999px;
      border:none; background:transparent; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
    }

    .center{
      flex:1; display:flex; flex-direction:column; align-items:center;
      padding-top:40px; position:relative;
    }
    .todayLabel{ font-size:12px; letter-spacing:1.5px; font-weight:700; color:#999; margin-bottom:8px; }
    .greetingTitle{ font-size:28px; font-weight:700; margin-bottom:6px; text-align:center; padding:0 18px; }
    .greetingSub{ font-size:15px; color:#666; margin-bottom:40px; text-align:center; padding:0 18px; }

    .bigCircleBtn{
      width:220px; height:220px; border-radius:999px;
      border:1px solid rgba(255,255,255,.75);
      background:rgba(255,255,255,.35);
      box-shadow:0 26px 60px rgba(0,0,0,.08);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .circleRing{ position:absolute; inset:16px; border-radius:999px; border:1px solid rgba(0,0,0,.06); pointer-events:none; }
    .camIcon{ opacity:.75; display:flex; align-items:center; justify-content:center; font-size:54px; }
    .spinner{ width:24px; height:24px; border:2px solid #ddd; border-top-color:#333; border-radius:50%; animation:fluxSpin 1s linear infinite; }

    .cta{ margin-top:24px; font-size:16px; font-weight:700; opacity:.9; color:#111; }
    .homeHint{ margin-top:8px; font-size:13px; opacity:.45; color:#000; text-align:center; padding:0 18px; }

    /* Tabs */
    .tabBar{
      position:absolute; left:0; right:0; bottom:0; height:86px;
      background:rgba(255,255,255,.85);
      border-top:1px solid rgba(0,0,0,.06);
      backdrop-filter: blur(12px);
      display:flex; align-items:center; justify-content:space-around;
      z-index:9998; padding-bottom:20px;
    }
    .tabItem{ display:flex; flex-direction:column; align-items:center; gap:4px; color:#999; cursor:pointer; font-size:10px; font-weight:600; user-select:none; }
    .tabItem.active{ color:#111; }
    .tabIcon{ opacity:.9; font-size:18px; }
    .tabLabel{ font-size:11px; font-weight:700; }

    /* Nav */
    .navBar{
      height:56px; display:flex; align-items:center; justify-content:space-between;
      padding:0 8px; border-bottom:1px solid #f5f5f5;
    }
    .navTitle{ font-size:16px; font-weight:600; }

    /* Result */
    .scoreCard{ text-align:center; padding:32px; background:#fafafa; border-radius:24px; margin-bottom:24px; }
    .emoji{ font-size:64px; margin-bottom:12px; }
    .scoreNum{ font-size:56px; font-weight:700; line-height:1; }
    .scoreLabel{ font-size:12px; font-weight:700; color:#999; letter-spacing:1px; margin-top:4px; }
    .scoreMsg{ font-size:16px; color:#444; margin-top:16px; line-height:1.5; max-width:240px; margin-inline:auto; }

    .insightBox{ background:#fff; border:1px solid #eee; border-radius:16px; padding:20px; margin-bottom:24px; }
    .insightHead{ display:flex; align-items:center; gap:8px; font-size:13px; font-weight:700; color:#888; margin-bottom:8px; text-transform:uppercase; }
    .insightBody{ font-size:15px; line-height:1.6; color:#333; }
    .insightNote{ font-size:12px; color:#bbb; margin-top:12px; }
    .disclaimer{ font-size:12px; color:#ccc; text-align:center; line-height:1.4; padding:0 20px; }

    .footer{ padding:24px; background:#fff; border-top:1px solid #f5f5f5; }
    .primaryBtn{
      width:100%; padding:16px; border-radius:16px;
      background:#111; color:#fff; font-size:16px; font-weight:600;
      border:none; cursor:pointer;
    }

    /* Settings */
    .menuItem{
      width:100%;
      display:flex; justify-content:space-between; align-items:center;
      padding:16px 8px; border:none; background:transparent;
      border-bottom:1px solid #f9f9f9; cursor:pointer;
      font-size:16px; color:#222;
    }
    .menuLeft{ display:flex; gap:12px; align-items:center; }
    .divider{ height:8px; background:#f9f9f9; margin:0 -24px 16px; }
    .sectionLabel{ font-size:12px; font-weight:700; color:#999; margin-left:12px; margin-bottom:8px; text-transform:uppercase; }

    .field{ margin-bottom:24px; }
    .label{ font-size:14px; font-weight:500; color:#333; margin-bottom:8px; }
    input.text{
      width:100%; padding:14px; border-radius:12px; border:1px solid #eee;
      font-size:16px; outline:none;
    }
    .inputHint{ font-size:12px; color:#999; margin-top:6px; }

    .card{ padding:20px; background:#f9f9f9; border-radius:16px; font-size:15px; line-height:1.6; color:#444; }
    .dangerBtn{
      width:100%; padding:14px; border-radius:12px;
      background:#fff0f0; color:#d00;
      font-size:15px; font-weight:500;
      border:1px solid #ffd0d0;
      display:flex; align-items:center; justify-content:center; gap:8px;
      cursor:pointer;
    }
    .confirmBox{ padding:16px; background:#f9f9f9; border-radius:12px; margin-top:12px; }
    .confirmTitle{ font-weight:600; margin-bottom:8px; }
    .confirmRow{ display:flex; gap:10px; justify-content:flex-end; }
    .btn{ padding:8px 16px; border-radius:8px; background:#fff; color:#333; border:1px solid #ddd; font-size:14px; cursor:pointer; }

    .list{ display:flex; flex-direction:column; }
    .row{ display:flex; justify-content:space-between; align-items:center; padding:16px 0; border-bottom:1px solid #f0f0f0; }
    .rowDate{ font-size:16px; font-weight:500; }
    .rowSub{ font-size:12px; color:#999; margin-top:4px; }
    .rowScore{ font-size:18px; font-weight:600; color:#333; }
    .empty{ text-align:center; margin-top:80px; color:#999; }

    .centerContent{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; }
    .logo{
      width:64px; height:64px; background:#111; color:#fff;
      border-radius:16px; display:flex; align-items:center; justify-content:center;
      font-size:32px; font-weight:700; margin-bottom:20px;
    }

    /* Toast */
    .toast{
      position:fixed; bottom:40px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.85); color:#fff;
      padding:10px 20px; border-radius:30px; font-size:14px;
      z-index:9999;
    }

    /* Pick page */
    .camPage{ position:absolute; inset:0; background:#000; z-index:999; display:flex; flex-direction:column; }
    .camHeader{
      height:60px; display:flex; align-items:center; justify-content:space-between;
      padding:0 20px; color:#fff; position:relative; z-index:2;
    }
    .iconBtnWhite{ background:none; border:none; color:#fff; cursor:pointer; padding:8px; font-size:18px; }
    .camTitle{ font-size:16px; font-weight:600; }
    .camView{ flex:1; background:#111; display:flex; align-items:center; justify-content:center; }
    .camPlaceholder{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; pointer-events:none; }
    .pickDesc{ color:rgba(255,255,255,.6); font-size:14px; margin-top:20px; text-align:center; padding:0 18px; }
    .camFooter{ height:160px; display:flex; align-items:center; justify-content:center; background:#000; }
    .pickRow{ display:flex; gap:24px; }
    .pickAction{ display:flex; flex-direction:column; align-items:center; gap:12px; background:none; border:none; cursor:pointer; }
    .pickIconCircle{ width:72px; height:72px; border-radius:50%; background:#222; color:#fff; display:flex; align-items:center; justify-content:center; font-size:28px; }

    /* Small helpers */
    .muted{ color:#999; }
    .right{ color:#ccc; font-weight:700; }
  </style>
</head>

<body>
  <div id="app" class="app"></div>

  <script>
    /* =========================
       1) i18n & CONFIG (v4.0.1 Stable)
    ========================= */
    const LS_KEYS = {
      LANG: "flux.lang_v4",
      NAME: "flux.name_v4",
      HISTORY: "flux.history_v4",
      INSIGHT_CLOCK: "flux.insight_clock_v4",
    };

    const I18N = {
      "zh-TW": {
        APP_NAME: "Flux",
        BTN_BACK: "è¿”å›ž",
        BTN_CLOSE: "é—œé–‰",
        BTN_DONE: "å®Œæˆ",
        BTN_CLEAR: "æ¸…ç©º",
        BTN_CANCEL: "å–æ¶ˆ",

        HOME_TODAY: "TODAY",
        HOME_GREET: "æ—©å®‰",
        HOME_GREET_SUB: "æœ€è¿‘æ•´é«”ç‹€æ…‹å¾ˆç©©å®šã€‚",
        HOME_CTA: "æ‹ä¸‹ä»Šå¤©çš„ç‹€æ…‹",
        HOME_HINT: "ç¬¬ä¸€æ¬¡éœ€è¦å…è¨±ç›¸æ©Ÿæ¬Šé™",
        HOME_ALBUM: "æ”¹ç”¨ç…§ç‰‡",

        TAB_TODAY: "ä»Šå¤©",
        TAB_HISTORY: "ç´€éŒ„",
        TAB_INSIGHT: "æ´žå¯Ÿ",

        ANALYZING: "åˆ†æžä¸­â€¦",
        ERROR_READ: "è®€å–ç…§ç‰‡å¤±æ•—ï¼Œè«‹é‡è©¦",

        RESULT_TITLE: "ä»Šæ—¥ç‹€æ…‹",
        SCORE_LABEL: "Flux Score",
        DISCLAIMER: "æ­¤ App åƒ…ç”¨æ–¼æ—¥å¸¸è§€å¯Ÿèˆ‡è¨˜éŒ„ï¼Œä¸ä»£è¡¨å¥åº·æˆ–é†«ç™‚åˆ¤æ–·ã€‚",

        INSIGHT_TITLE: "æœ¬é€±æ‘˜è¦",
        INSIGHT_STABLE: "é€™é€±æ•´é«”ç‹€æ…‹å¾ˆç©©å®šï¼Œä¿æŒç›®å‰çš„ç¯€å¥å³å¯ã€‚",
        INSIGHT_MIXED: "é€™é€±æœ‰ä¸€äº›èµ·ä¼ï¼Œä»åœ¨å¯è§€å¯Ÿç¯„åœå…§ã€‚",
        INSIGHT_VARIABLE: "é€™é€±è®ŠåŒ–è¼ƒå¤šï¼Œä¸æ€¥è‘—ä¸‹çµè«–ï¼ŒæŒçºŒè§€å¯Ÿå°±å¥½ã€‚",
        INSIGHT_NOTE: "æ´žå¯Ÿæ¯ 7 å¤©æœ€å¤šå‡ºç¾ä¸€æ¬¡ã€‚",

        SETTINGS_TITLE: "è¨­å®š",
        SET_NAME_LABEL: "ç¨±å‘¼æ–¹å¼",
        SET_NAME_DESC: "ä½ å¸Œæœ›æˆ‘æ€Žéº¼ç¨±å‘¼ä½ ",
        SET_NAME_PLACEHOLDER: "ä¾‹å¦‚ï¼šAlex",
        SET_NAME_HINT: "ç”¨æ–¼é¦–é å•å€™ï¼Œå¯ç•™ç©º",

        SET_SEC_DATA: "å¸³æˆ¶èˆ‡è³‡æ–™",
        SET_SEC_APP: "é—œæ–¼",
        SET_HISTORY: "æˆ‘çš„ç´€éŒ„",
        SET_PRIVACY: "éš±ç§èˆ‡è³‡æ–™",
        SET_LANG: "èªžè¨€ / Language",
        SET_ABOUT: "é—œæ–¼ Flux",

        PRIVACY_TITLE: "éš±ç§èˆ‡è³‡æ–™",
        PRIVACY_DESC: "Flux åªå°‡è³‡æ–™å„²å­˜åœ¨ä½ çš„æ‰‹æ©Ÿï¼ˆLocalStorageï¼‰ã€‚æˆ‘å€‘ç„¡æ³•å­˜å–ä½ çš„ç…§ç‰‡æˆ–ç´€éŒ„ã€‚ä½ å¯ä»¥éš¨æ™‚æ¸…ç©ºã€‚",
        PRIVACY_CLEAR: "æ¸…ç©ºæ‰€æœ‰è³‡æ–™",
        PRIVACY_CONFIRM_TITLE: "ç¢ºå®šè¦æ¸…ç©ºå—Žï¼Ÿ",
        PRIVACY_CONFIRM_MSG: "é€™å°‡åˆªé™¤æ‰€æœ‰æ­·å²ç´€éŒ„èˆ‡è¨­å®šï¼Œç„¡æ³•å¾©åŽŸã€‚",
        TOAST_CLEARED: "å·²æ¸…ç©ºæ‰€æœ‰ç´€éŒ„",

        HISTORY_TITLE: "æˆ‘çš„ç´€éŒ„",
        HISTORY_EMPTY: "ç›®å‰é‚„æ²’æœ‰ç´€éŒ„ã€‚",

        ABOUT_SLOGAN: "ä¸€å€‹å®‰éœçš„æ—¥å¸¸è§€å¯Ÿå¤¥ä¼´ã€‚",

        PICK_TITLE: "é¸æ“‡æ–¹å¼",
        PICK_DESC: "ä½ è¦æ‹ç…§ï¼Œé‚„æ˜¯å¾žç›¸ç°¿é¸ä¸€å¼µï¼Ÿ",
        BTN_CAMERA: "æ‹ç…§",
        BTN_GALLERY: "ç›¸ç°¿",
      },

      en: {
        APP_NAME: "Flux",
        BTN_BACK: "Back",
        BTN_CLOSE: "Close",
        BTN_DONE: "Done",
        BTN_CLEAR: "Clear",
        BTN_CANCEL: "Cancel",

        HOME_TODAY: "TODAY",
        HOME_GREET: "Good morning",
        HOME_GREET_SUB: "Your rhythm is stable recently.",
        HOME_CTA: "Capture today",
        HOME_HINT: "Camera permission needed",
        HOME_ALBUM: "Select Photo",

        TAB_TODAY: "Today",
        TAB_HISTORY: "History",
        TAB_INSIGHT: "Insights",

        ANALYZING: "Analyzingâ€¦",
        ERROR_READ: "Failed to read image",

        RESULT_TITLE: "Today",
        SCORE_LABEL: "Flux Score",
        DISCLAIMER: "For personal observation only. Not medical advice.",

        INSIGHT_TITLE: "Weekly Summary",
        INSIGHT_STABLE: "Your state has been consistent this week.",
        INSIGHT_MIXED: "Some fluctuations this week, within range.",
        INSIGHT_VARIABLE: "More variations this week. Just keep observing.",
        INSIGHT_NOTE: "Insights appear at most once a week.",

        SETTINGS_TITLE: "Settings",
        SET_NAME_LABEL: "Your Name",
        SET_NAME_DESC: "How should I call you?",
        SET_NAME_PLACEHOLDER: "e.g. Alex",
        SET_NAME_HINT: "Used for greetings. Optional.",

        SET_SEC_DATA: "Data",
        SET_SEC_APP: "App",

        SET_HISTORY: "History",
        SET_PRIVACY: "Privacy & Data",
        SET_LANG: "Language",
        SET_ABOUT: "About Flux",

        PRIVACY_TITLE: "Privacy & Data",
        PRIVACY_DESC: "Flux stores data locally on your device. We cannot access your photos or records. Clear anytime.",
        PRIVACY_CLEAR: "Clear All Data",
        PRIVACY_CONFIRM_TITLE: "Clear everything?",
        PRIVACY_CONFIRM_MSG: "This deletes all history and settings. Cannot be undone.",
        TOAST_CLEARED: "All data cleared",

        HISTORY_TITLE: "History",
        HISTORY_EMPTY: "No records yet.",

        ABOUT_SLOGAN: "A quiet companion for daily observation.",

        PICK_TITLE: "Choose",
        PICK_DESC: "Take a photo, or pick from gallery?",
        BTN_CAMERA: "Camera",
        BTN_GALLERY: "Gallery",
      },

      ja: {
        APP_NAME: "Flux",
        BTN_BACK: "æˆ»ã‚‹",
        BTN_CLOSE: "é–‰ã˜ã‚‹",
        BTN_DONE: "å®Œäº†",
        BTN_CLEAR: "å‰Šé™¤",
        BTN_CANCEL: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",

        HOME_TODAY: "TODAY",
        HOME_GREET: "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™",
        HOME_GREET_SUB: "æœ€è¿‘ã®ãƒªã‚ºãƒ ã¯å®‰å®šã—ã¦ã„ã¾ã™ã€‚",
        HOME_CTA: "ä»Šæ—¥ã®çŠ¶æ…‹ã‚’è¨˜éŒ²",
        HOME_HINT: "ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¿…è¦ã§ã™",
        HOME_ALBUM: "å†™çœŸã‚’é¸ã¶",

        TAB_TODAY: "ä»Šæ—¥",
        TAB_HISTORY: "è¨˜éŒ²",
        TAB_INSIGHT: "æ´žå¯Ÿ",

        ANALYZING: "åˆ†æžä¸­â€¦",
        ERROR_READ: "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ",

        RESULT_TITLE: "ä»Šæ—¥ã®çŠ¶æ…‹",
        SCORE_LABEL: "Flux Score",
        DISCLAIMER: "æ—¥ã€…ã®è¦³å¯Ÿç”¨ã§ã‚ã‚Šã€åŒ»ç™‚çš„ãªåˆ¤æ–­ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",

        INSIGHT_TITLE: "ä»Šé€±ã®ã¾ã¨ã‚",
        INSIGHT_STABLE: "ä»Šé€±ã¯å…¨ä½“çš„ã«å®‰å®šã—ã¦ã„ã¾ã™ã€‚",
        INSIGHT_MIXED: "å°‘ã—å¤‰åŒ–ãŒã‚ã‚Šã¾ã—ãŸãŒã€ç¯„å›²å†…ã§ã™ã€‚",
        INSIGHT_VARIABLE: "å¤‰åŒ–ãŒå¤šã„é€±ã§ã—ãŸã€‚ç„¦ã‚‰ãšè¦³å¯Ÿã—ã¾ã—ã‚‡ã†ã€‚",
        INSIGHT_NOTE: "æ´žå¯Ÿã¯é€±ã«1å›žã¾ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚",

        SETTINGS_TITLE: "è¨­å®š",
        SET_NAME_LABEL: "ãŠåå‰",
        SET_NAME_DESC: "ä½•ã¨ãŠå‘¼ã³ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ",
        SET_NAME_PLACEHOLDER: "ä¾‹ï¼šAlex",
        SET_NAME_HINT: "æŒ¨æ‹¶ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆçœç•¥å¯ï¼‰",

        SET_SEC_DATA: "ãƒ‡ãƒ¼ã‚¿",
        SET_SEC_APP: "ã‚¢ãƒ—ãƒª",

        SET_HISTORY: "è¨˜éŒ²",
        SET_PRIVACY: "ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼",
        SET_LANG: "è¨€èªž / Language",
        SET_ABOUT: "Fluxã«ã¤ã„ã¦",

        PRIVACY_TITLE: "ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼",
        PRIVACY_DESC: "Fluxã¯ãƒ‡ãƒ¼ã‚¿ã‚’ç«¯æœ«å†…ï¼ˆLocalStorageï¼‰ã«ã®ã¿ä¿å­˜ã—ã¾ã™ã€‚ã„ã¤ã§ã‚‚å‰Šé™¤å¯èƒ½ã§ã™ã€‚",
        PRIVACY_CLEAR: "ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤",
        PRIVACY_CONFIRM_TITLE: "å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
        PRIVACY_CONFIRM_MSG: "å±¥æ­´ã¨è¨­å®šãŒã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚",
        TOAST_CLEARED: "å‰Šé™¤ã—ã¾ã—ãŸ",

        HISTORY_TITLE: "è¨˜éŒ²",
        HISTORY_EMPTY: "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",

        ABOUT_SLOGAN: "é™ã‹ãªæ—¥å¸¸ã®è¦³å¯Ÿãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã€‚",

        PICK_TITLE: "é¸æŠž",
        PICK_DESC: "æ’®å½±ã—ã¾ã™ã‹ï¼Ÿå†™çœŸã‚’é¸ã³ã¾ã™ã‹ï¼Ÿ",
        BTN_CAMERA: "æ’®å½±",
        BTN_GALLERY: "å†™çœŸ",
      }
    };

    function t(lang, key){
      return (I18N[lang] && I18N[lang][key]) || (I18N["zh-TW"] && I18N["zh-TW"][key]) || key;
    }

    function detectLanguage(){
      try{
        const saved = localStorage.getItem(LS_KEYS.LANG);
        if (saved && I18N[saved]) return saved;
        const sys = navigator.language || "";
        if (sys.startsWith("en")) return "en";
        if (sys.startsWith("ja")) return "ja";
        return "zh-TW";
      }catch{
        return "zh-TW";
      }
    }

    /* =========================
       2) Score messages & Logic
    ========================= */
    const SCORE_MESSAGES = {
      "zh-TW": {
        range_70: [
          "ä»Šå¤©çš„ç‹€æ…‹çœ‹èµ·ä¾†ç›¸å°ç©©å®šã€‚",
          "æ•´é«”è¡¨ç¾å¹³ç©©ï¼Œå¯ä»¥æŒçºŒè§€å¯Ÿã€‚",
          "ç›®å‰ç‹€æ…‹ç¶­æŒåœ¨ä¸éŒ¯çš„å€é–“ã€‚",
          "ä»Šå¤©çš„ç‹€æ…‹ç›¸å°å®‰å®šï¼Œè¨˜éŒ„ä¸‹ä¾†å³å¯ã€‚",
        ],
        range_50: [
          "ä»Šå¤©çš„ç‹€æ…‹æœ‰äº›è®ŠåŒ–ï¼Œå±¬æ–¼å¯è§€å¯Ÿçš„ç¯„åœã€‚",
          "ç›®å‰ç‹€æ…‹è½åœ¨ä¸­æ®µï¼Œè¨˜éŒ„ä¸‹ä¾†è§€å¯Ÿè¶¨å‹¢ã€‚",
          "ä»Šå¤©çš„ç‹€æ…‹ç•¥æœ‰èµ·ä¼ï¼ŒæŒçºŒè¨˜éŒ„æœƒæ›´æ¸…æ¥šã€‚",
          "ç‹€æ…‹è™•æ–¼ä¸­é–“å€é–“ï¼Œç•™æ„è¿‘æœŸçš„è®ŠåŒ–å³å¯ã€‚",
        ],
        range_30: [
          "ä»Šå¤©çš„ç‹€æ…‹ç•¥ä½Žï¼Œå…ˆè¨˜éŒ„ä¸‹ä¾†ã€‚",
          "ç‹€æ…‹è½åœ¨åä½Žå€é–“ï¼ŒæŒçºŒè§€å¯Ÿå³å¯ã€‚",
          "ä»Šå¤©çš„ç‹€æ…‹é¡¯å¾—æ¯”è¼ƒå®‰éœã€‚",
          "ç›®å‰ç‹€æ…‹è¼ƒä½Žï¼Œä¹‹å¾Œçš„è®ŠåŒ–æœƒæ›´é‡è¦ã€‚",
        ],
        range_0: [
          "ä»Šå¤©çš„ç‹€æ…‹èˆ‡å¹³æ™‚ä¸åŒï¼Œå…ˆè¨˜éŒ„ä¸‹ä¾†ã€‚",
          "ç›®å‰ç‹€æ…‹åä½Žï¼Œå»ºè­°æŒçºŒè§€å¯Ÿè®ŠåŒ–ã€‚",
          "ä»Šå¤©çš„ç‹€æ…‹è¼ƒç‚ºç‰¹æ®Šï¼Œå¾ŒçºŒç´€éŒ„æœƒæœ‰å¹«åŠ©ã€‚",
          "ç‹€æ…‹é¡¯ç¤ºæœ‰æ˜Žé¡¯è®ŠåŒ–ï¼Œç•™æ„å¾ŒçºŒè¨˜éŒ„ã€‚",
        ],
      },
      en: {
        range_70: ["State looks stable today.","Overall consistent, keep observing.","Maintaining a good range.","Stable today, just record it."],
        range_50: ["Some variations today, within observable range.","In the middle range, let's track the trend.","Slight fluctuations, recording helps.","Mid-range state, just notice the changes."],
        range_30: ["State is a bit low, recording it.","In the lower range, keep observing.","A quieter state today.","Lower than usual, future trends matter."],
        range_0:  ["Different from usual, recording it.","Low range, suggest observing changes.","Unique state today, records help.","Noticeable change, keep tracking."],
      },
      ja: {
        range_70: ["ä»Šæ—¥ã¯æ¯”è¼ƒçš„å®‰å®šã—ã¦ã„ã¾ã™ã€‚","å…¨ä½“çš„ã«è½ã¡ç€ã„ã¦ã„ã¾ã™ã€‚","è‰¯ã„ç¯„å›²ã‚’ç¶­æŒã—ã¦ã„ã¾ã™ã€‚","å®‰å®šã—ã¦ã„ã¾ã™ã€‚è¨˜éŒ²ã—ã¾ã—ã‚‡ã†ã€‚"],
        range_50: ["å°‘ã—å¤‰åŒ–ãŒè¦‹ã‚‰ã‚Œã¾ã™ãŒã€è¦³å¯Ÿç¯„å›²å†…ã§ã™ã€‚","ä¸­é–“ã®ç¯„å›²ã§ã™ã€‚å‚¾å‘ã‚’è¦‹ã¾ã—ã‚‡ã†ã€‚","ã‚ãšã‹ãªå¤‰å‹•ã§ã™ã€‚è¨˜éŒ²ãŒå½¹ç«‹ã¡ã¾ã™ã€‚","å¤‰åŒ–ã«æ°—ä»˜ãã ã‘ã§ååˆ†ã§ã™ã€‚"],
        range_30: ["å°‘ã—ä½Žã‚ã§ã™ã€‚è¨˜éŒ²ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚","ä½Žã‚ã®ç¯„å›²ã§ã™ã€‚è¦³å¯Ÿã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚","ä»Šæ—¥ã¯é™ã‹ãªçŠ¶æ…‹ã§ã™ã€‚","æ™®æ®µã‚ˆã‚Šä½Žã‚ã§ã™ã€‚ä»Šå¾Œã®å¤‰åŒ–ãŒå¤§åˆ‡ã§ã™ã€‚"],
        range_0:  ["æ™®æ®µã¨é•ã„ã¾ã™ã€‚è¨˜éŒ²ã—ã¾ã—ã‚‡ã†ã€‚","ä½Žã‚ã§ã™ã€‚å¤‰åŒ–ã‚’è¦‹å®ˆã‚Šã¾ã—ã‚‡ã†ã€‚","ç‰¹ç•°ãªçŠ¶æ…‹ã§ã™ã€‚è¨˜éŒ²ãŒå½¹ç«‹ã¡ã¾ã™ã€‚","å¤‰åŒ–ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚è¨˜éŒ²ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚"],
      }
    };

    function getScoreBucket(score){
      if (score >= 70) return "range_70";
      if (score >= 50) return "range_50";
      if (score >= 30) return "range_30";
      return "range_0";
    }

    function pickMessageForScore(lang, score, seedInt){
      const pool = SCORE_MESSAGES[lang] || SCORE_MESSAGES.en;
      const bucket = getScoreBucket(score);
      const messages = pool[bucket] || [];
      if (!messages.length) return "";
      const idx = Math.abs(seedInt) % messages.length;
      return messages[idx];
    }

    /* =========================
       3) Storage
    ========================= */
    function loadRecords(){
      try{
        const raw = localStorage.getItem(LS_KEYS.HISTORY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveRecords(records){
      try{ localStorage.setItem(LS_KEYS.HISTORY, JSON.stringify(records)); }catch{}
    }
    function clearFluxData(){
      try{
        Object.keys(localStorage).filter(k => k.startsWith("flux.")).forEach(k => localStorage.removeItem(k));
      }catch{}
    }
    function resetInsightClock(){
      try{ localStorage.removeItem(LS_KEYS.INSIGHT_CLOCK); }catch{}
    }
    function loadUserName(){
      try{ return localStorage.getItem(LS_KEYS.NAME) || ""; }catch{ return ""; }
    }
    function saveUserName(name){
      try{ localStorage.setItem(LS_KEYS.NAME, name); }catch{}
    }

    /* =========================
       4) Date & Insight Logic
    ========================= */
    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function daysSince(isoDate){
      if (!isoDate) return Infinity;
      const [y,m,d] = isoDate.split("-").map(Number);
      const past = new Date(y, m-1, d);
      const now = new Date();
      const pastMid = new Date(past.getFullYear(), past.getMonth(), past.getDate()).getTime();
      const nowMid  = new Date(now.getFullYear(),  now.getMonth(),  now.getDate()).getTime();
      return Math.floor((nowMid - pastMid) / (1000*60*60*24));
    }

    function shouldShowWeeklyInsight(records, currentView){
      if (currentView !== "RESULT") return false;
      if (!Array.isArray(records) || records.length < 3) return false;
      const lastAt = localStorage.getItem(LS_KEYS.INSIGHT_CLOCK);
      if (daysSince(lastAt) < 7) return false;
      return true;
    }
    function markInsightShown(){
      localStorage.setItem(LS_KEYS.INSIGHT_CLOCK, todayISO());
    }

    function classifyWeeklyTrend(records){
      const recent = records.slice(0,7);
      if (recent.length < 3) return "VARIABLE";
      const lowCount = recent.filter(r => r.confidence === "low").length;
      if (lowCount / recent.length > 0.5) return "VARIABLE";
      const scores = recent.map(r => r.score).filter(s => typeof s === "number");
      if (scores.length < 2) return "VARIABLE";
      const min = Math.min(...scores);
      const max = Math.max(...scores);
      const diff = max - min;
      if (diff <= 12) return "STABLE";
      if (diff <= 24) return "MIXED";
      return "VARIABLE";
    }

    function getWeeklyInsightText(lang, trend){
      if (trend === "STABLE") return t(lang, "INSIGHT_STABLE");
      if (trend === "MIXED") return t(lang, "INSIGHT_MIXED");
      return t(lang, "INSIGHT_VARIABLE");
    }

    function getEmoji(score){
      if (score <= 30) return "ðŸ¥º";
      if (score <= 60) return "ðŸ˜€";
      return "ðŸ˜†";
    }

    /* =========================
       5) Image Utils & Stable Scoring
    ========================= */
    function loadImageFromBlob(blob){
      return new Promise((resolve,reject)=>{
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }

    function fnv1aHash(u8){
      let h = 0x811c9dc5;
      for (let i=0;i<u8.length;i++){
        h ^= u8[i];
        h = (h + ((h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24))) >>> 0;
      }
      return h >>> 0;
    }
    function stableScoreFromHash(hash){
      return hash % 101;
    }

    async function analyzeImageStable(jpegBlob){
      await new Promise(r => setTimeout(r, 600));
      const ab = await jpegBlob.arrayBuffer();
      const u8 = new Uint8Array(ab);
      const hash = fnv1aHash(u8);
      const score = stableScoreFromHash(hash);
      const confidence = (hash % 10 === 0) ? "low" : "normal";
      const emoji = getEmoji(score);
      const msgSeed = (hash ^ (hash >>> 16)) >>> 0;
      return { score, confidence, emoji, hash, msgSeed };
    }

    async function compressImage(fileOrBlob, { maxEdge=1280, quality=0.85 } = {}){
      const img = await loadImageFromBlob(fileOrBlob);
      const iw = img.width, ih = img.height;
      const scale = Math.min(1, maxEdge / Math.max(iw, ih));
      const w = Math.round(iw * scale);
      const h = Math.round(ih * scale);
      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      if (!ctx) throw new Error("NO_CANVAS_CTX");
      ctx.drawImage(img, 0, 0, w, h);
      const blob = await new Promise(resolve => canvas.toBlob(b => resolve(b), "image/jpeg", quality));
      if (!blob) throw new Error("COMPRESS_FAILED");
      return blob;
    }

    /* =========================
       6) App State + Renderer
    ========================= */
    const state = {
      lang: detectLanguage(),
      userName: loadUserName(),
      page: "home",      // home | pick | result | history | settings | name | language | privacy | about
      toast: "",
      records: loadRecords(),
      todayResult: null,
      isAnalyzing: false,
      confirmClear: false,
    };

    const appEl = document.getElementById("app");

    function setToast(msg){
      state.toast = msg || "";
      render();
      if (state.toast){
        setTimeout(()=>{
          state.toast = "";
          render();
        }, 2000);
      }
    }

    function setPage(p){
      state.page = p;
      state.confirmClear = false;
      render();
    }

    function handleSetLang(l){
      state.lang = l;
      try{ localStorage.setItem(LS_KEYS.LANG, l); }catch{}
      render();
    }

    function handleSetName(n){
      state.userName = n;
      saveUserName(n);
      render();
    }

    function handleClearData(){
      clearFluxData();
      resetInsightClock();
      state.records = [];
      state.userName = "";
      state.todayResult = null;
      setToast(t(state.lang, "TOAST_CLEARED"));
      setPage("home");
    }

    async function ingestAndAnalyzeImage(fileOrBlob){
      state.isAnalyzing = true;
      setPage("home");
      render();
      try{
        const compressed = await compressImage(fileOrBlob, { maxEdge: 1280, quality: 0.85 });
        const { score, confidence, emoji, msgSeed } = await analyzeImageStable(compressed);
        const rec = {
          id: Date.now(),
          createdAt: todayISO(),
          score,
          confidence,
          emoji,
          msgSeed,
        };
        const next = [rec, ...state.records].slice(0, 200);
        state.records = next;
        saveRecords(next);
        state.todayResult = rec;
        setPage("result");
      }catch(e){
        console.error(e);
        setToast(t(state.lang, "ERROR_READ"));
        setPage("home");
      }finally{
        state.isAnalyzing = false;
        render();
      }
    }

    /* =========================
       7) UI Builders
    ========================= */
    function el(tag, attrs={}, children=[]){
      const node = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs || {})){
        if (k === "class") node.className = v;
        else if (k === "style") node.setAttribute("style", v);
        else if (k.startsWith("on") && typeof v === "function") node.addEventListener(k.slice(2).toLowerCase(), v);
        else if (k === "html") node.innerHTML = v;
        else node.setAttribute(k, v);
      }
      (children || []).forEach(c => node.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
      return node;
    }

    function icon(sym){ return el("span", {}, [sym]); }

    function NavBar({ left, title, right }){
      return el("div", { class:"navBar" }, [
        left || el("div", {}, [" "]),
        el("div", { class:"navTitle" }, [title || " "]),
        right || el("div", {}, [" "]),
      ]);
    }

    function MenuItemRow({ leftIcon, label, onClick, rightText }){
      return el("button", { class:"menuItem", onclick:onClick }, [
        el("div", { class:"menuLeft" }, [
          el("span", { class:"muted" }, [leftIcon || "â€¢"]),
          el("span", {}, [label]),
        ]),
        el("span", { class:"right" }, [rightText || "â€º"]),
      ]);
    }

    function HomeView(){
      const lang = state.lang;
      const greetingBase = t(lang, "HOME_GREET");
      let greetingFull = `${greetingBase}ã€‚`;
      if (state.userName){
        if (lang === "en") greetingFull = `${greetingBase}, ${state.userName}.`;
        else if (lang === "ja") greetingFull = `${greetingBase}ã€${state.userName}ã•ã‚“ã€‚`;
        else greetingFull = `${greetingBase}ï¼Œ${state.userName}ã€‚`;
      }

      const btn = el("button", {
        class:"bigCircleBtn",
        "aria-label":"capture",
        onclick: state.isAnalyzing ? null : () => setPage("pick")
      }, [
        el("div", { class:"circleRing" }),
        el("div", { class:"camIcon" }, [
          state.isAnalyzing ? el("div", { class:"spinner" }) : "ðŸ“·"
        ])
      ]);

      const tabToday = el("div", { class:"tabItem active" }, [
        el("div", { class:"tabIcon" }, ["âœ¨"]),
        el("div", { class:"tabLabel" }, [t(lang, "TAB_TODAY")]),
      ]);

      const tabHistory = el("div", { class:"tabItem", role:"button", tabindex:"0", onclick:()=>setPage("history") }, [
        el("div", { class:"tabIcon" }, ["ðŸ“…"]),
        el("div", { class:"tabLabel" }, [t(lang, "TAB_HISTORY")]),
      ]);

      const tabInsight = el("div", { class:"tabItem", role:"button", tabindex:"0", onclick:()=>setPage("settings") }, [
        el("div", { class:"tabIcon" }, ["âš™ï¸"]),
        el("div", { class:"tabLabel" }, [t(lang, "TAB_INSIGHT")]),
      ]);

      return el("div", { class:"page" }, [
        el("div", { class:"glowBg" }),
        el("div", { class:"topBar" }, [
          el("div", { class:"brand" }, [t(lang, "APP_NAME")]),
          el("button", { class:"iconBtn", onclick:()=>setPage("settings"), "aria-label":"settings" }, ["âš™ï¸"])
        ]),
        el("div", { class:"center" }, [
          el("div", { class:"todayLabel" }, [t(lang, "HOME_TODAY")]),
          el("div", { class:"greetingTitle" }, [greetingFull]),
          el("div", { class:"greetingSub" }, [t(lang, "HOME_GREET_SUB")]),
          btn,
          el("div", { class:"cta" }, [state.isAnalyzing ? t(lang, "ANALYZING") : t(lang, "HOME_CTA")]),
          state.isAnalyzing ? el("div") : el("div", { class:"homeHint" }, [t(lang, "HOME_HINT")]),
        ]),
        el("div", { class:"tabBar" }, [tabToday, tabHistory, tabInsight])
      ]);
    }

    function PickView(){
      const lang = state.lang;

      const camInput = el("input", {
        type:"file", accept:"image/*", capture:"environment",
        style:"display:none"
      });
      const galInput = el("input", { type:"file", accept:"image/*", style:"display:none" });

      function onFileChange(e){
        const f = e.target.files && e.target.files[0];
        if (f) ingestAndAnalyzeImage(f);
        e.target.value = "";
      }
      camInput.addEventListener("change", onFileChange);
      galInput.addEventListener("change", onFileChange);

      return el("div", { class:"camPage" }, [
        el("div", { class:"camHeader" }, [
          el("button", { class:"iconBtnWhite", onclick:()=>setPage("home"), "aria-label":"back" }, ["âœ–ï¸"]),
          el("div", { class:"camTitle" }, [t(lang, "PICK_TITLE")]),
          el("div", { style:"width:24px" })
        ]),
        el("div", { class:"camView" }, [
          el("div", { class:"camPlaceholder" }, [
            el("div", {}, [
              el("div", { class:"pickDesc" }, [t(lang, "PICK_DESC")])
            ])
          ])
        ]),
        camInput, galInput,
        el("div", { class:"camFooter" }, [
          el("div", { class:"pickRow" }, [
            el("button", { class:"pickAction", onclick:()=>camInput.click(), "aria-label":"camera" }, [
              el("div", { class:"pickIconCircle" }, ["ðŸ“·"]),
              el("span", { style:"color:#fff" }, [t(lang, "BTN_CAMERA")])
            ]),
            el("button", { class:"pickAction", onclick:()=>galInput.click(), "aria-label":"gallery" }, [
              el("div", { class:"pickIconCircle" }, ["ðŸ–¼ï¸"]),
              el("span", { style:"color:#fff" }, [t(lang, "BTN_GALLERY")])
            ])
          ])
        ])
      ]);
    }

    function ResultView(){
      const lang = state.lang;
      const result = state.todayResult;
      if (!result) return HomeView();

      const { score, emoji, msgSeed } = result;
      const msg = pickMessageForScore(lang, score, msgSeed);

      const showInsight = shouldShowWeeklyInsight(state.records, "RESULT");
      let insightBox = el("div");
      if (showInsight){
        // mark once per render cycle (safe)
        markInsightShown();
        const trend = classifyWeeklyTrend(state.records);
        const insightText = getWeeklyInsightText(lang, trend);
        insightBox = el("div", { class:"insightBox" }, [
          el("div", { class:"insightHead" }, ["âœ¨ ", el("span", {}, [t(lang, "INSIGHT_TITLE")])]),
          el("div", { class:"insightBody" }, [insightText]),
          el("div", { class:"insightNote" }, [t(lang, "INSIGHT_NOTE")]),
        ]);
      }

      return el("div", { class:"page" }, [
        NavBar({
          left: el("div"),
          title: t(lang, "RESULT_TITLE"),
          right: el("button", { class:"iconBtn", onclick:()=>setPage("home"), "aria-label":"close" }, ["âœ–ï¸"])
        }),
        el("div", { class:"content" }, [
          el("div", { class:"scoreCard" }, [
            el("div", { class:"emoji" }, [emoji]),
            el("div", { class:"scoreNum" }, [String(score)]),
            el("div", { class:"scoreLabel" }, ["/ 100"]),
            el("div", { class:"scoreMsg" }, [msg]),
          ]),
          insightBox,
          el("div", { class:"disclaimer" }, [t(lang, "DISCLAIMER")])
        ]),
        el("div", { class:"footer" }, [
          el("button", { class:"primaryBtn", onclick:()=>setPage("home") }, [t(lang, "BTN_DONE")])
        ])
      ]);
    }

    function HistoryView(){
      const lang = state.lang;
      const list = (state.records || []);
      const body = list.length === 0
        ? el("div", { class:"empty" }, [t(lang, "HISTORY_EMPTY")])
        : el("div", { class:"list" }, list.map(r =>
            el("div", { class:"row" }, [
              el("div", {}, [
                el("div", { class:"rowDate" }, [r.createdAt]),
                el("div", { class:"rowSub" }, [getEmoji(r.score)]),
              ]),
              el("div", { class:"rowScore" }, [String(r.score)])
            ])
          ));

      return el("div", { class:"page" }, [
        NavBar({
          left: el("button", { class:"iconBtn", onclick:()=>setPage("home"), "aria-label":"back" }, ["â€¹"]),
          title: t(lang, "HISTORY_TITLE"),
          right: el("div", { style:"width:24px" })
        }),
        el("div", { class:"content" }, [body])
      ]);
    }

    function SettingsView(){
      const lang = state.lang;

      return el("div", { class:"page" }, [
        NavBar({
          left: el("button", { class:"iconBtn", onclick:()=>setPage("home"), "aria-label":"back" }, ["â€¹"]),
          title: t(lang, "SETTINGS_TITLE"),
          right: el("div", { style:"width:24px" })
        }),
        el("div", { class:"content" }, [
          MenuItemRow({ leftIcon:"ðŸ‘¤", label:t(lang,"SET_NAME_LABEL"), onClick:()=>setPage("name") }),
          el("div", { class:"divider" }),
          el("div", { class:"sectionLabel" }, [t(lang,"SET_SEC_DATA")]),
          MenuItemRow({ leftIcon:"ðŸ“…", label:t(lang,"SET_HISTORY"), onClick:()=>setPage("history") }),
          MenuItemRow({ leftIcon:"ðŸ›¡ï¸", label:t(lang,"SET_PRIVACY"), onClick:()=>setPage("privacy") }),
          el("div", { class:"sectionLabel", style:"margin-top:10px" }, [t(lang,"SET_SEC_APP")]),
          MenuItemRow({ leftIcon:"ðŸŒ", label:t(lang,"SET_LANG"), onClick:()=>setPage("language") }),
          MenuItemRow({ leftIcon:"â„¹ï¸", label:t(lang,"SET_ABOUT"), onClick:()=>setPage("about") }),
        ])
      ]);
    }

    function NameView(){
      const lang = state.lang;
      const input = el("input", {
        class:"text",
        value: state.userName || "",
        placeholder: t(lang,"SET_NAME_PLACEHOLDER")
      });
      input.addEventListener("input", (e)=>handleSetName(e.target.value));

      return el("div", { class:"page" }, [
        NavBar({
          left: el("button", { class:"iconBtn", onclick:()=>setPage("settings"), "aria-label":"back" }, ["â€¹"]),
          title: t(lang, "SET_NAME_LABEL"),
          right: el("div", { style:"width:24px" })
        }),
        el("div", { class:"content" }, [
          el("div", { class:"field" }, [
            el("div", { class:"label" }, [t(lang,"SET_NAME_DESC")]),
            input,
            el("div", { class:"inputHint" }, [t(lang,"SET_NAME_HINT")])
          ])
        ])
      ]);
    }

    function LanguageView(){
      const lang = state.lang;

      function langRow(label, code){
        const active = (lang === code);
        return el("button", { class:"menuItem", onclick:()=>handleSetLang(code) }, [
          el("span", {}, [label]),
          el("span", {}, [active ? "âœ…" : ""])
        ]);
      }

      return el("div", { class:"page" }, [
        NavBar({
          left: el("button", { class:"iconBtn", onclick:()=>setPage("settings"), "aria-label":"back" }, ["â€¹"]),
          title: t(lang, "SET_LANG"),
          right: el("div", { style:"width:24px" })
        }),
        el("div", { class:"content" }, [
          langRow("ç¹é«”ä¸­æ–‡", "zh-TW"),
          langRow("English", "en"),
          langRow("æ—¥æœ¬èªž", "ja"),
        ])
      ]);
    }

    function PrivacyView(){
      const lang = state.lang;

      const block = !state.confirmClear
        ? el("button", { class:"dangerBtn", onclick:()=>{ state.confirmClear = true; render(); } }, ["ðŸ—‘ï¸ ", t(lang,"PRIVACY_CLEAR")])
        : el("div", { class:"confirmBox" }, [
            el("div", { class:"confirmTitle" }, [t(lang,"PRIVACY_CONFIRM_TITLE")]),
            el("div", { style:"font-size:13px;color:#666;margin-bottom:12px" }, [t(lang,"PRIVACY_CONFIRM_MSG")]),
            el("div", { class:"confirmRow" }, [
              el("button", { class:"btn", onclick:()=>{ state.confirmClear=false; render(); } }, [t(lang,"BTN_CANCEL")]),
              el("button", { class:"dangerBtn", onclick:handleClearData }, [t(lang,"BTN_CLEAR")]),
            ])
          ]);

      return el("div", { class:"page" }, [
        NavBar({
          left: el("button", { class:"iconBtn", onclick:()=>setPage("settings"), "aria-label":"back" }, ["â€¹"]),
          title: t(lang, "PRIVACY_TITLE"),
          right: el("div", { style:"width:24px" })
        }),
        el("div", { class:"content" }, [
          el("div", { class:"card" }, [t(lang,"PRIVACY_DESC")]),
          el("div", { class:"divider" }),
          block
        ])
      ]);
    }

    function AboutView(){
      const lang = state.lang;
      return el("div", { class:"page" }, [
        NavBar({
          left: el("button", { class:"iconBtn", onclick:()=>setPage("settings"), "aria-label":"back" }, ["â€¹"]),
          title: t(lang, "SET_ABOUT"),
          right: el("div", { style:"width:24px" })
        }),
        el("div", { class:"centerContent" }, [
          el("div", { class:"logo" }, ["F"]),
          el("h2", { style:"font-size:20px;font-weight:700;margin-top:16px" }, ["Flux"]),
          el("p", { style:"color:#999;font-size:14px;margin-bottom:32px" }, ["v4.0.1"]),
          el("p", { style:"text-align:center;line-height:1.8;color:#555" }, [t(lang,"ABOUT_SLOGAN")]),
        ])
      ]);
    }

    function render(){
      appEl.innerHTML = "";
      let pageNode;
      switch(state.page){
        case "home": pageNode = HomeView(); break;
        case "pick": pageNode = PickView(); break;
        case "result": pageNode = ResultView(); break;
        case "history": pageNode = HistoryView(); break;
        case "settings": pageNode = SettingsView(); break;
        case "name": pageNode = NameView(); break;
        case "language": pageNode = LanguageView(); break;
        case "privacy": pageNode = PrivacyView(); break;
        case "about": pageNode = AboutView(); break;
        default: pageNode = HomeView();
      }
      appEl.appendChild(pageNode);

      if (state.toast){
        appEl.appendChild(el("div", { class:"toast" }, [state.toast]));
      }
    }

    // Boot
    render();
  </script>
</body>
</html>
