<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>Flux Companion Â· Your Gentle AI Listener</title>
  <style>
    :root{
      --bg0:#070a14;
      --bg1:#0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --good:#31d07d;
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --blue:#5aa2ff;
      --btn:#4b7dff;
      --btn2: rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 26px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, "PingFang TC", "Microsoft JhengHei", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(108,99,255,.28), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(58,157,255,.20), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      padding: 18px 16px 28px;
      max-width: 980px;
      margin: 0 auto;
    }

    /* Top bar */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 4px 2px 16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #b6a7ff, #5aa2ff 70%, #2b4cff);
      box-shadow: 0 0 18px rgba(90,162,255,.35);
      flex: 0 0 auto;
    }
    .brandText{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .brandTitle{
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 16px;
      line-height: 1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandSub{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .rightTools{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .badgeDot{width:8px;height:8px;border-radius:50%}
    .gear{
      width:40px;height:40px;border-radius:14px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.12);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .gear:active{transform:scale(.98)}
    .gear svg{opacity:.9}

    /* Main card */
    .hero{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      position:relative;
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute; inset:-80px -120px auto auto;
      width:260px;height:260px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(90,162,255,.30), transparent 65%);
      filter: blur(0px);
      pointer-events:none;
    }
    .todayRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .today{
      font-size: 12px;
      letter-spacing: .6px;
      color: var(--muted2);
    }
    .hello{
      margin-top: 6px;
      font-size: clamp(28px, 4vw, 42px);
      font-weight: 900;
      letter-spacing: .2px;
    }
    .desc{
      margin-top: 8px;
      color: var(--muted);
      line-height: 1.5;
      max-width: 52ch;
    }

    .centerCircle{
      margin-top: 16px;
      height: clamp(230px, 38vw, 360px);
      display:grid;
      place-items:center;
      position:relative;
      border-radius: 22px;
      background:
        radial-gradient(circle at 50% 45%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(circle at 50% 55%, rgba(90,162,255,.12), transparent 55%);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .rings{
      position:absolute;
      inset:-40px;
      background:
        radial-gradient(circle at 50% 50%, transparent 0 40%, rgba(255,255,255,.08) 40% 40.5%, transparent 41%),
        radial-gradient(circle at 50% 50%, transparent 0 54%, rgba(255,255,255,.06) 54% 54.5%, transparent 55%),
        radial-gradient(circle at 50% 50%, transparent 0 68%, rgba(255,255,255,.05) 68% 68.5%, transparent 69%);
      opacity:.9;
      pointer-events:none;
    }
    .camBtn{
      width:96px;height:96px;border-radius: 22px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.14);
      cursor:pointer;
      user-select:none;
      position:relative;
      z-index:2;
    }
    .camBtn:active{transform:scale(.99)}
    .camBtn svg{opacity:.9}
    .preview{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1;
      pointer-events:none;
      opacity:0;
      transition: opacity .18s ease;
    }
    .preview img{
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      border-radius: 22px;
      filter: saturate(1.02);
    }
    .preview.show{opacity:1}

    .actions{
      display:flex;
      gap:12px;
      margin-top: 14px;
      flex-wrap:wrap;
    }
    .btn{
      flex:1 1 160px;
      height: 54px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      cursor:pointer;
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(107,99,255,.95), rgba(90,162,255,.95));
      color: #fff;
      border-color: rgba(255,255,255,.08);
    }
    .btnGhost{
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
    }
    .hint{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.45;
    }

    /* Side info card (desktop) */
    .grid{
      display:grid;
      grid-template-columns: 1.4fr .9fr;
      gap: 14px;
      margin-top: 14px;
      align-items:start;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns: 1fr}
    }
    .panel{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.11);
      border-radius: 22px;
      padding: 14px 14px 12px;
    }
    .panelTitle{
      font-weight: 900;
      margin: 2px 0 6px;
      font-size: 14px;
    }
    .panelText{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 10px;
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.11);
      color: rgba(255,255,255,.78);
      font-size: 12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill b{color:#fff}

    /* Modal */
    .modalWrap{
      position:fixed;
      inset:0;
      display:none;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      z-index: 50;
      padding: 14px;
    }
    .modalWrap.show{display:flex}
    .modal{
      width:min(680px, 100%);
      margin:auto;
      background: rgba(12,16,32,.92);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 24px;
      box-shadow: 0 28px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalHeader h3{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .close{
      width:38px;height:38px;border-radius: 14px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.12);
      cursor:pointer;
    }
    .modalBody{
      padding: 14px 16px 16px;
    }
    .field{
      margin-top: 12px;
    }
    .label{
      font-size: 12px;
      color: var(--muted2);
      margin-bottom: 6px;
    }
    .input{
      width:100%;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 0 12px;
      outline:none;
      font-size: 14px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .smallBtn{
      flex: 1 1 140px;
      height: 46px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.07);
      color: rgba(255,255,255,.9);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }
    .smallBtn.primary{
      background: linear-gradient(135deg, rgba(107,99,255,.92), rgba(90,162,255,.92));
      border-color: rgba(255,255,255,.10);
    }

    /* Result card */
    .resultCard{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      padding: 14px;
      margin-top: 12px;
    }
    .resultTop{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .emoji{
      width:46px;height:46px;border-radius: 16px;
      display:grid;place-items:center;
      font-size: 24px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.12);
      flex: 0 0 auto;
    }
    .resultText{
      margin-top: 10px;
      color: rgba(255,255,255,.90);
      line-height: 1.65;
      font-size: 14px;
      white-space:pre-wrap;
    }
    .footerBtns{
      display:flex;
      gap:10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }

    /* History */
    .history{
      margin-top: 12px;
    }
    .histTitle{
      font-weight: 900;
      font-size: 14px;
      margin: 0 0 8px;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 46vh;
      overflow:auto;
      padding-right:4px;
    }
    .item{
      padding: 12px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.11);
      cursor:pointer;
    }
    .itemTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .itemWhen{font-size: 12px; color: var(--muted2)}
    .itemTag{
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.80);
      white-space:nowrap;
    }
    .itemText{
      margin-top: 6px;
      color: rgba(255,255,255,.86);
      font-size: 13px;
      line-height: 1.5;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(10,12,22,.88);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 18px 60px rgba(0,0,0,.40);
      display:none;
      z-index: 80;
      font-size: 13px;
      max-width: 92vw;
      text-align:center;
    }
    .toast.show{display:block}

    /* Hidden file inputs */
    input[type="file"]{display:none}
  </style>
</head>

<body>
  <div class="wrap" id="app">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div class="brandText">
          <div class="brandTitle" id="appTitle">Flux Companion</div>
          <div class="brandSub" id="appSub">Your Gentle AI Listener</div>
        </div>
      </div>
      <div class="rightTools">
        <div class="badge" id="badgeBrowser">
          <span class="badgeDot" id="dotBrowser"></span>
          <span id="txtBrowser">Browser: ...</span>
        </div>
        <div class="badge" id="badgeHttps">
          <span class="badgeDot" id="dotHttps"></span>
          <span id="txtHttps">HTTPS: ...</span>
        </div>
        <div class="gear" id="btnSettings" title="è¨­å®š">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="rgba(255,255,255,.9)" stroke-width="2"/>
            <path d="M19.4 15a7.96 7.96 0 0 0 .1-1 7.96 7.96 0 0 0-.1-1l2-1.6-2-3.4-2.4 1a8.2 8.2 0 0 0-1.7-1l-.4-2.6H9.1l-.4 2.6a8.2 8.2 0 0 0-1.7 1l-2.4-1-2 3.4 2 1.6a7.96 7.96 0 0 0-.1 1 7.96 7.96 0 0 0 .1 1l-2 1.6 2 3.4 2.4-1c.5.4 1.1.7 1.7 1l.4 2.6h5.8l.4-2.6c.6-.3 1.2-.6 1.7-1l2.4 1 2-3.4-2-1.6Z" stroke="rgba(255,255,255,.7)" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="hero">
        <div class="todayRow">
          <div>
            <div class="today">TODAY</div>
            <div class="hello" id="helloText">ä»Šå¤©çš„ä½ ï¼Œé‚„å¥½å—ï¼Ÿ</div>
            <div class="desc" id="descText">æˆ‘åœ¨é€™è£¡é™ªä½ ã€‚æ‹ä¸€å¼µç…§ç‰‡æˆ–é¸ä¸€å¼µç…§ç‰‡ï¼Œæˆ‘æœƒç”¨æº«æŸ”çš„æ–¹å¼å›æ‡‰ä½ ç•¶ä¸‹çš„æƒ…å¢ƒã€‚</div>
          </div>
        </div>

        <div class="centerCircle" id="tapZone">
          <div class="rings"></div>
          <div class="preview" id="previewBox"><img id="previewImg" alt="preview"/></div>
          <div class="camBtn" id="btnUploadCenter" title="ä¸Šå‚³ä¸€å¼µç…§ç‰‡">
            <svg width="34" height="34" viewBox="0 0 24 24" fill="none">
              <path d="M4 7h3l2-2h6l2 2h3v12H4V7Z" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linejoin="round"/>
              <path d="M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="rgba(255,255,255,.8)" stroke-width="2"/>
            </svg>
          </div>
        </div>

        <div class="actions">
          <div class="btn btnPrimary" id="btnCamera">æ‹ç…§</div>
          <div class="btn btnGhost" id="btnAlbum">ç›¸ç°¿</div>
        </div>
        <div class="hint" id="hintText">
          è‹¥åœ¨æŸäº› App å…§å»ºç€è¦½å™¨å—é™ï¼Œå»ºè­°ç”¨ Chrome / Safari é–‹å•Ÿï¼›æœ¬é æœƒè‡ªå‹•æ”¹ç”¨ç›¸ç°¿é¿å…å¡æ­»ã€‚
        </div>

        <!-- file inputs -->
        <input id="inCamera" type="file" accept="image/*" capture="environment" />
        <input id="inAlbum" type="file" accept="image/*" />
      </div>

      <div class="panel">
        <div class="panelTitle">ä½ çš„é™ªä¼´è¨­å®š</div>
        <div class="panelText">
          é€™å€‹ç‰ˆæœ¬æœƒæŠŠç…§ç‰‡çš„ã€Œå…‰ç·š / è‰²èª¿ / å°æ¯”ã€åšæˆæƒ…å¢ƒç·šç´¢ï¼Œç„¶å¾Œç”¨ <b>A + B</b> çš„æ–¹å¼å›è¦†ä½ ï¼š<br/>
          Aï¼šæ„Ÿæ€§ç†è§£ï¼ˆè½ä½ ï¼‰<br/>
          Bï¼šä¸€å€‹å¾ˆå°ã€ä½ åšå¾—åˆ°çš„ä¸‹ä¸€æ­¥ï¼ˆé™ªä½ èµ°ï¼‰
        </div>
        <div class="pillRow" id="pillRow">
          <div class="pill"><b>å›è¦†ï¼š</b> A + B</div>
          <div class="pill" id="pillEnv">ç’°å¢ƒï¼šæª¢æ¸¬ä¸­â€¦</div>
        </div>

        <div class="history">
          <div class="histTitle">æœ€è¿‘çš„ç´€éŒ„</div>
          <div class="list" id="historyList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modalWrap" id="modalWrap">
    <div class="modal" id="modal">
      <div class="modalHeader">
        <h3 id="modalTitle">è¨­å®š</h3>
        <div class="close" id="btnCloseModal" title="é—œé–‰">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6 6 18" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
      </div>
      <div class="modalBody" id="modalBody">
        <!-- dynamic -->
      </div>
    </div>
  </div>

  <div class="toast" id="toast">å·²å„²å­˜</div>

  <script>
    (function(){
      "use strict";

      // ---------- State ----------
      const LS_KEY = "flux_companion_records_v1";
      const LS_CFG = "flux_companion_cfg_v1";

      const state = {
        cfg: {
          appTitle: "Flux Companion",
          appSub: "Your Gentle AI Listener",
          hello: "ä»Šå¤©çš„ä½ ï¼Œé‚„å¥½å—ï¼Ÿ",
          desc: "æˆ‘åœ¨é€™è£¡é™ªä½ ã€‚æ‹ä¸€å¼µç…§ç‰‡æˆ–é¸ä¸€å¼µç…§ç‰‡ï¼Œæˆ‘æœƒç”¨æº«æŸ”çš„æ–¹å¼å›æ‡‰ä½ ç•¶ä¸‹çš„æƒ…å¢ƒã€‚",
          showInAppHint: true,
          modeBadge: "Stable v4.4B"
        },
        env: {
          isHttps: false,
          browserLabel: "Unknown",
          inApp: false
        },
        lastImageDataUrl: "",
        lastAnalysis: null,
        records: []
      };

      // ---------- DOM helpers ----------
      const $ = (id)=>document.getElementById(id);

      function safeJsonParse(str, fallback){
        try{
          if(!str) return fallback;
          const v = JSON.parse(str);
          return (v===null || v===undefined) ? fallback : v;
        }catch(_){
          return fallback;
        }
      }

      function toast(msg){
        const el = $("toast");
        el.textContent = msg;
        el.classList.add("show");
        setTimeout(()=>el.classList.remove("show"), 1300);
      }

      function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

      function nowISO(){
        const d=new Date();
        const pad=(x)=>String(x).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      // ---------- Env detect ----------
      function detectEnv(){
        const ua = navigator.userAgent || "";
        const isAndroid = /Android/i.test(ua);
        const isIOS = /iPhone|iPad|iPod/i.test(ua);
        let browser = "Browser";

        if(/Chrome/i.test(ua) && !/Edg/i.test(ua) && !/OPR/i.test(ua)) browser="Chrome";
        if(/Safari/i.test(ua) && !/Chrome/i.test(ua)) browser="Safari";
        if(/Edg/i.test(ua)) browser="Edge";
        if(/OPR|Opera/i.test(ua)) browser="Opera";
        if(/SamsungBrowser/i.test(ua)) browser="Samsung";
        if(isIOS && /CriOS/i.test(ua)) browser="Chrome(iOS)";

        const inApp = /(FBAN|FBAV|Instagram|Line\/|MicroMessenger|WeChat|TikTok|KAKAOTALK|Twitter|Threads|GSA|wv)/i.test(ua);
        const https = (location.protocol === "https:");

        state.env.isHttps = https;
        state.env.browserLabel = browser;
        state.env.inApp = inApp;

        // badges
        $("txtBrowser").textContent = `Browser: ${browser}${inApp ? " (In-App)" : ""}`;
        $("dotBrowser").style.background = inApp ? "var(--warn)" : "var(--good)";
        $("txtHttps").textContent = `HTTPS: ${https ? "OK" : "NO"}`;
        $("dotHttps").style.background = https ? "var(--good)" : "var(--warn)";

        $("pillEnv").textContent = `ç’°å¢ƒï¼š${browser} Â· ${https ? "HTTPS âœ“" : "HTTP"}${inApp ? " Â· In-App" : ""}`;
      }

      // ---------- Persistence ----------
      function loadCfg(){
        const cfg = safeJsonParse(localStorage.getItem(LS_CFG), null);
        if(cfg && typeof cfg === "object"){
          state.cfg = {...state.cfg, ...cfg};
        }
      }

      function saveCfg(){
        localStorage.setItem(LS_CFG, JSON.stringify(state.cfg));
      }

      function loadRecords(){
        // âœ… é€™è£¡å°±æ˜¯ä½ é›»è…¦çˆ†æ‰çš„é»ï¼šrecords å¯èƒ½æ˜¯ null
        const raw = safeJsonParse(localStorage.getItem(LS_KEY), []);
        state.records = Array.isArray(raw) ? raw : [];
      }

      function saveRecords(){
        localStorage.setItem(LS_KEY, JSON.stringify(state.records));
      }

      // ---------- Render ----------
      function renderText(){
        $("appTitle").textContent = state.cfg.appTitle;
        $("appSub").textContent = state.cfg.appSub;
        $("helloText").textContent = state.cfg.hello;
        $("descText").textContent = state.cfg.desc;
        $("hintText").style.display = state.cfg.showInAppHint ? "block" : "none";
      }

      function renderHistory(){
        const list = $("historyList");
        list.innerHTML = "";

        // âœ… é˜²å‘†ï¼šæ°¸é ç¢ºä¿æ˜¯é™£åˆ—
        const arr = Array.isArray(state.records) ? state.records : [];
        if(arr.length === 0){
          const empty = document.createElement("div");
          empty.className = "panelText";
          empty.style.marginTop = "6px";
          empty.textContent = "å°šç„¡ç´€éŒ„ã€‚ä¸Šå‚³ä¸€å¼µç…§ç‰‡å¾Œï¼Œå›è¦†æœƒè¢«å­˜é€²é€™è£¡ã€‚";
          list.appendChild(empty);
          return;
        }

        // æœ€æ–°åœ¨ä¸Š
        const sorted = [...arr].sort((a,b)=> (b.ts||0)-(a.ts||0)).slice(0,30);

        for(const r of sorted){
          const item = document.createElement("div");
          item.className = "item";
          item.onclick = ()=> openResultModal(r);

          const top = document.createElement("div");
          top.className = "itemTop";

          const when = document.createElement("div");
          when.className = "itemWhen";
          when.textContent = r.when || "";

          const tag = document.createElement("div");
          tag.className = "itemTag";
          tag.textContent = (r.tags && r.tags[0]) ? r.tags[0] : "AI å›è¦†";

          top.appendChild(when);
          top.appendChild(tag);

          const txt = document.createElement("div");
          txt.className = "itemText";
          txt.textContent = r.reply || "";

          item.appendChild(top);
          item.appendChild(txt);
          list.appendChild(item);
        }
      }

      function setPreview(dataUrl){
        state.lastImageDataUrl = dataUrl || "";
        const box = $("previewBox");
        const img = $("previewImg");
        if(dataUrl){
          img.src = dataUrl;
          box.classList.add("show");
        }else{
          box.classList.remove("show");
          img.removeAttribute("src");
        }
      }

      // ---------- Image analysis (lightweight, deterministic) ----------
      function analyzeImage(file){
        return new Promise((resolve,reject)=>{
          const reader = new FileReader();
          reader.onerror = ()=>reject(new Error("è®€å–å¤±æ•—"));
          reader.onload = ()=>{
            const dataUrl = String(reader.result || "");
            const img = new Image();
            img.onload = ()=>{
              const w = 220;
              const h = Math.round(img.height * (w / img.width));
              const canvas = document.createElement("canvas");
              canvas.width = w;
              canvas.height = Math.max(1, h);
              const ctx = canvas.getContext("2d", { willReadFrequently: true });
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              const { data } = ctx.getImageData(0, 0, canvas.width, canvas.height);

              let sumL=0, sumS=0, sumC=0;
              let lMin=999, lMax=-999;
              // sample every N pixels for speed
              const step = 4 * 5; // every 5 pixels
              for(let i=0; i<data.length; i+=step){
                const r=data[i], g=data[i+1], b=data[i+2];
                // luminance
                const l = (0.2126*r + 0.7152*g + 0.0722*b) / 255; // 0..1
                // saturation approx
                const max = Math.max(r,g,b), min = Math.min(r,g,b);
                const s = (max===0) ? 0 : (max-min)/max; // 0..1
                sumL += l; sumS += s;

                lMin = Math.min(lMin, l);
                lMax = Math.max(lMax, l);
              }
              const n = Math.max(1, Math.floor(data.length/step));
              const avgL = sumL / n;
              const avgS = sumS / n;
              const contrast = clamp((lMax - lMin), 0, 1);

              // make tags
              const light = avgL < 0.28 ? "åæš—" : (avgL > 0.72 ? "åäº®" : "æŸ”å’Œ");
              const tone = avgS < 0.22 ? "åä¸­æ€§" : (avgS > 0.55 ? "åé®®æ˜" : "åè‡ªç„¶");
              const mood = (avgL < 0.28 && contrast > 0.40) ? "æ²‰éœ" :
                           (avgL > 0.72 && avgS > 0.45) ? "æ˜æœ—" :
                           (tone==="åä¸­æ€§") ? "å¹³ç©©" : "èˆ’å±•";

              const emoji = (mood==="æ˜æœ—") ? "ğŸ˜Š" :
                            (mood==="æ²‰éœ") ? "ğŸ«§" :
                            (mood==="å¹³ç©©") ? "ğŸ™‚" : "ğŸŒ¿";

              resolve({
                dataUrl,
                metrics: { avgL, avgS, contrast },
                tags: [`æ˜æš—ï¼š${light}`, `è‰²èª¿ï¼š${tone}`, `æ°›åœï¼š${mood}`],
                emoji
              });
            };
            img.onerror = ()=>reject(new Error("åœ–ç‰‡è¼‰å…¥å¤±æ•—"));
            img.src = dataUrl;
          };
          reader.readAsDataURL(file);
        });
      }

      // ---------- A+B reply generator ----------
      function genReply(analysis){
        const tags = analysis.tags || [];
        const m = analysis.metrics || {avgL:.5, avgS:.3, contrast:.3};

        const light = tags[0] || "";
        const tone  = tags[1] || "";
        const mood  = tags[2] || "";

        // A = æ„Ÿæ€§ç†è§£
        let A = "";
        if(m.avgL < 0.28){
          A = "æˆ‘æ„Ÿè¦ºä½ æ­¤åˆ»éœ€è¦ä¸€é»å®‰éœèˆ‡è¢«æ¥ä½çš„ç©ºé–“ã€‚ä½ é¡˜æ„æŠŠé€™ä¸€åˆ»äº¤çµ¦æˆ‘ï¼Œä»£è¡¨ä½ å…¶å¯¦å·²ç¶“å¾ˆåŠªåŠ›äº†ã€‚";
        }else if(m.avgL > 0.72){
          A = "æˆ‘çœ‹åˆ°ä¸€ç¨®æ¯”è¼ƒæ˜äº®ã€èƒ½å‘¼å¸çš„æ„Ÿè¦ºã€‚å°±ç®—ä»Šå¤©å¾ˆå¿™ï¼Œä½ ä¹Ÿé‚„é¡˜æ„åœä¸€ä¸‹ï¼Œé€™å¾ˆä¸å®¹æ˜“ã€‚";
        }else{
          A = "é€™å¼µç…§ç‰‡çš„ç‹€æ…‹å¾ˆå¹³è¡¡ï¼Œä¸æ€¥ã€ä¸åµã€‚åƒæ˜¯åœ¨å‘Šè¨´æˆ‘ï¼šä½ æ­£åœ¨æ’ä½æ—¥å¸¸ï¼Œä¹Ÿåœ¨æ‰¾ä¸€å€‹å¯ä»¥æ”¾å¿ƒçš„åœ°æ–¹ã€‚";
        }

        // B = å°æ­¥é©Ÿ
        let B = "";
        if(m.avgL < 0.28){
          B = "æ¥ä¸‹ä¾†ä½ åªè¦åšä¸€ä»¶å¾ˆå°çš„äº‹ï¼šæŠŠè‚©è†€æ”¾é¬†ä¸€æ¬¡ï¼Œæ…¢æ…¢å¸æ°£ 4 ç§’ã€åæ°£ 6 ç§’ï¼Œåš 3 å›åˆå°±å¥½ã€‚ä½ ä¸éœ€è¦ç«‹åˆ»è§£æ±ºä¸€åˆ‡ã€‚";
        }else if(m.avgL > 0.72){
          B = "æ¥ä¸‹ä¾†ä½ åªè¦åšä¸€ä»¶å¾ˆå°çš„äº‹ï¼šå–ä¸€å£æ°´ï¼Œç„¶å¾Œç”¨ä¸€å¥è©±å¯«ä¸‹ã€Œæˆ‘ä»Šå¤©æœ€æƒ³è¢«ç†è§£çš„æ˜¯â€¦ã€ã€‚å¯«å®Œå°±åœï¼Œå‰©ä¸‹æˆ‘é™ªä½ ã€‚";
        }else{
          B = "æ¥ä¸‹ä¾†ä½ åªè¦åšä¸€ä»¶å¾ˆå°çš„äº‹ï¼šé¸ä¸€å€‹ä½ ç¾åœ¨åšå¾—åˆ°çš„å¾®å°ç…§é¡§ï¼ˆè£œæ°´ / ä¼¸å±• 20 ç§’ / æŠŠæ‰‹æ©Ÿæ”¾ä¸‹ 1 åˆ†é˜ï¼‰ã€‚åšåˆ°å°±ç®—è´ã€‚";
        }

        const intro = "æˆ‘åœ¨ã€‚";
        const sense = `æˆ‘çœ‹é€™å¼µç…§ç‰‡ï¼š${light}ã€${tone}ï¼Œæ°›åœæ˜¯${mood.replace("æ°›åœï¼š","")}ã€‚`;
        const closing = "ä»Šå¤©ä¸ç”¨è®Šå¾—å¾ˆå¼·ï¼Œä½ åªè¦è¢«å¥½å¥½å°å¾…å°±å¯ä»¥ã€‚";

        return `${intro}\n\n${sense}\n\n${A}\n\n${B}\n\n${closing}`;
      }

      // ---------- Modal builders ----------
      function openModal(title, bodyNode){
        $("modalTitle").textContent = title;
        const body = $("modalBody");
        body.innerHTML = "";
        body.appendChild(bodyNode);
        $("modalWrap").classList.add("show");
      }
      function closeModal(){
        $("modalWrap").classList.remove("show");
      }

      function settingsModal(){
        const root = document.createElement("div");

        const f1 = document.createElement("div");
        f1.className="field";
        f1.innerHTML = `<div class="label">App æ¨™é¡Œï¼ˆå·¦ä¸Šï¼‰</div><input class="input" id="cfgTitle" />`;
        root.appendChild(f1);

        const f2 = document.createElement("div");
        f2.className="field";
        f2.innerHTML = `<div class="label">å‰¯æ¨™ï¼ˆå·¦ä¸Šï¼‰</div><input class="input" id="cfgSub" />`;
        root.appendChild(f2);

        const f3 = document.createElement("div");
        f3.className="field";
        f3.innerHTML = `<div class="label">é¦–é ä¸»å¥</div><input class="input" id="cfgHello" />`;
        root.appendChild(f3);

        const f4 = document.createElement("div");
        f4.className="field";
        f4.innerHTML = `<div class="label">é¦–é æè¿°</div><input class="input" id="cfgDesc" />`;
        root.appendChild(f4);

        const f5 = document.createElement("div");
        f5.className="field";
        f5.innerHTML = `
          <div class="label">In-App Browser æç¤ºï¼ˆå¯é–‹é—œï¼‰</div>
          <label style="display:flex;align-items:center;gap:10px;color:rgba(255,255,255,.85);font-size:14px;">
            <input type="checkbox" id="cfgHint" style="width:18px;height:18px;" />
            é¡¯ç¤ºã€Œå…§å»ºç€è¦½å™¨å¯èƒ½é™åˆ¶ç›¸æ©Ÿã€æç¤º
          </label>`;
        root.appendChild(f5);

        const row = document.createElement("div");
        row.className="row";
        row.innerHTML = `
          <button class="smallBtn primary" id="btnSaveCfg">å„²å­˜</button>
          <button class="smallBtn" id="btnResetCfg">é‡ç½®</button>
          <button class="smallBtn" id="btnClearAll">æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>`;
        root.appendChild(row);

        const note = document.createElement("div");
        note.className="resultCard";
        note.innerHTML = `
          <div class="panelTitle" style="margin:0 0 6px;">Smart Fallback æœƒæ€éº¼åšï¼Ÿ</div>
          <div class="panelText">
            é»ã€Œæ‹ç…§ã€å…ˆå˜—è©¦å«ç›¸æ©Ÿï¼›è‹¥å…§å»ºç€è¦½å™¨æ””æˆªï¼ˆclick ç„¡åæ‡‰/è¢«é˜»æ“‹ï¼‰ï¼Œæœƒè‡ªå‹•æ”¹å«ã€Œç›¸ç°¿ã€ï¼Œç¢ºä¿ä¸€å®šèƒ½ä¸Šå‚³ã€‚
          </div>`;
        root.appendChild(note);

        openModal("è¨­å®š", root);

        // fill
        $("cfgTitle").value = state.cfg.appTitle;
        $("cfgSub").value = state.cfg.appSub;
        $("cfgHello").value = state.cfg.hello;
        $("cfgDesc").value = state.cfg.desc;
        $("cfgHint").checked = !!state.cfg.showInAppHint;

        $("btnSaveCfg").onclick = ()=>{
          state.cfg.appTitle = $("cfgTitle").value.trim() || "Flux Companion";
          state.cfg.appSub   = $("cfgSub").value.trim()   || "Your Gentle AI Listener";
          state.cfg.hello    = $("cfgHello").value.trim() || "ä»Šå¤©çš„ä½ ï¼Œé‚„å¥½å—ï¼Ÿ";
          state.cfg.desc     = $("cfgDesc").value.trim()  || "æˆ‘åœ¨é€™è£¡é™ªä½ ã€‚æ‹ä¸€å¼µç…§ç‰‡æˆ–é¸ä¸€å¼µç…§ç‰‡ï¼Œæˆ‘æœƒç”¨æº«æŸ”çš„æ–¹å¼å›æ‡‰ä½ ç•¶ä¸‹çš„æƒ…å¢ƒã€‚";
          state.cfg.showInAppHint = $("cfgHint").checked;
          saveCfg();
          renderText();
          toast("å·²å„²å­˜è¨­å®š");
          closeModal();
        };

        $("btnResetCfg").onclick = ()=>{
          localStorage.removeItem(LS_CFG);
          loadCfg();
          renderText();
          toast("å·²é‡ç½®è¨­å®š");
          closeModal();
        };

        $("btnClearAll").onclick = ()=>{
          localStorage.removeItem(LS_KEY);
          state.records = [];
          renderHistory();
          toast("å·²æ¸…ç©ºç´€éŒ„");
          closeModal();
        };
      }

      function openResultModal(record){
        const root = document.createElement("div");

        const card = document.createElement("div");
        card.className = "resultCard";

        const top = document.createElement("div");
        top.className = "resultTop";

        const emo = document.createElement("div");
        emo.className="emoji";
        emo.textContent = record.emoji || "ğŸ™‚";

        const meta = document.createElement("div");
        meta.innerHTML = `
          <div style="font-weight:900">AI å›è¦†</div>
          <div style="color:rgba(255,255,255,.55);font-size:12px;margin-top:2px;">${record.when || ""}</div>
        `;

        top.appendChild(emo);
        top.appendChild(meta);

        const text = document.createElement("div");
        text.className="resultText";
        text.textContent = record.reply || "";

        const pills = document.createElement("div");
        pills.className="pillRow";
        const tags = Array.isArray(record.tags) ? record.tags : [];
        for(const t of tags){
          const p = document.createElement("div");
          p.className="pill";
          p.textContent = t;
          pills.appendChild(p);
        }
        const envP = document.createElement("div");
        envP.className="pill";
        envP.textContent = `ç’°å¢ƒï¼š${state.env.browserLabel} Â· ${state.env.isHttps ? "HTTPS âœ“" : "HTTP"}`;
        pills.appendChild(envP);

        card.appendChild(top);
        card.appendChild(text);
        card.appendChild(pills);

        const footer = document.createElement("div");
        footer.className="footerBtns";
        footer.innerHTML = `
          <button class="smallBtn primary" id="btnCloseR">é—œé–‰</button>
          <button class="smallBtn" id="btnCopyR">è¤‡è£½æ–‡å­—</button>
          <button class="smallBtn" id="btnDeleteR">åˆªé™¤æ­¤ç­†</button>
        `;

        root.appendChild(card);
        root.appendChild(footer);

        openModal("AI å›è¦†", root);

        $("btnCloseR").onclick = closeModal;
        $("btnCopyR").onclick = async ()=>{
          try{
            await navigator.clipboard.writeText(record.reply || "");
            toast("å·²è¤‡è£½");
          }catch(_){
            toast("ç„¡æ³•è¤‡è£½ï¼ˆè«‹æ‰‹å‹•é¸å–ï¼‰");
          }
        };
        $("btnDeleteR").onclick = ()=>{
          const id = record.id;
          state.records = (Array.isArray(state.records) ? state.records : []).filter(r=>r.id!==id);
          saveRecords();
          renderHistory();
          toast("å·²åˆªé™¤");
          closeModal();
        };
      }

      function openAnalyzeModal(analysis, reply){
        const root = document.createElement("div");

        const card = document.createElement("div");
        card.className="resultCard";

        const top = document.createElement("div");
        top.className="resultTop";

        const emo = document.createElement("div");
        emo.className="emoji";
        emo.textContent = analysis.emoji || "ğŸ™‚";

        const meta = document.createElement("div");
        meta.innerHTML = `<div style="font-weight:900">AI å›è¦†</div><div style="color:rgba(255,255,255,.55);font-size:12px;margin-top:2px;">ä¾†æºï¼šç…§ç‰‡ Â· A + B</div>`;

        top.appendChild(emo);
        top.appendChild(meta);

        const text = document.createElement("div");
        text.className="resultText";
        text.textContent = reply;

        const pills = document.createElement("div");
        pills.className="pillRow";
        for(const t of (analysis.tags||[])){
          const p = document.createElement("div");
          p.className="pill";
          p.textContent = t;
          pills.appendChild(p);
        }
        const envP = document.createElement("div");
        envP.className="pill";
        envP.textContent = `ç’°å¢ƒï¼š${state.env.browserLabel} Â· ${state.env.isHttps ? "HTTPS âœ“" : "HTTP"}`;
        pills.appendChild(envP);

        card.appendChild(top);
        card.appendChild(text);
        card.appendChild(pills);

        const footer = document.createElement("div");
        footer.className="footerBtns";
        footer.innerHTML = `
          <button class="smallBtn primary" id="btnSaveRec">å­˜æˆç´€éŒ„</button>
          <button class="smallBtn" id="btnRepick">æ›ä¸€å¼µ</button>
          <button class="smallBtn" id="btnHome">å›é¦–é </button>
        `;

        root.appendChild(card);
        root.appendChild(footer);

        openModal("åˆ†æçµæœ", root);

        $("btnSaveRec").onclick = ()=>{
          const rec = {
            id: crypto && crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2),
            ts: Date.now(),
            when: nowISO(),
            emoji: analysis.emoji || "ğŸ™‚",
            tags: analysis.tags || [],
            reply: reply || "",
            // ä¸å­˜æ•´å¼µåœ–ï¼Œé¿å… localStorage çˆ†æ‰ï¼›è¦å­˜åœ–å¯å†åŠ é¸é …
          };
          state.records = Array.isArray(state.records) ? state.records : [];
          state.records.push(rec);
          saveRecords();
          renderHistory();
          toast("å·²å­˜æˆç´€éŒ„");
        };

        $("btnRepick").onclick = ()=>{
          closeModal();
          // ä½¿ç”¨è€…è‡ªå·±å†é»æ‹ç…§/ç›¸ç°¿
        };

        $("btnHome").onclick = ()=>{
          closeModal();
        };
      }

      // ---------- Smart fallback (camera -> album) ----------
      function openCameraSmart(){
        // å…ˆå˜—è©¦ camera inputï¼›å¦‚æœ 650ms æ²’æœ‰ change äº‹ä»¶ï¼Œå°± fallback åˆ°ç›¸ç°¿
        let changed = false;

        const onChange = ()=>{ changed = true; cleanup(); };
        const cleanup = ()=>{
          $("inCamera").removeEventListener("change", onChange);
        };

        $("inCamera").addEventListener("change", onChange, { once: true });

        try{
          $("inCamera").click();
        }catch(_){
          cleanup();
          $("inAlbum").click();
          return;
        }

        setTimeout(()=>{
          if(!changed){
            cleanup();
            // fallback
            $("inAlbum").click();
          }
        }, 650);
      }

      function openAlbum(){
        $("inAlbum").click();
      }

      // ---------- Handle file selection ----------
      async function handleFile(file){
        if(!file) return;
        try{
          const analysis = await analyzeImage(file);
          setPreview(analysis.dataUrl);
          state.lastAnalysis = analysis;

          const reply = genReply(analysis);
          openAnalyzeModal(analysis, reply);
        }catch(err){
          console.error(err);
          toast("åœ–ç‰‡åˆ†æå¤±æ•—ï¼Œè«‹æ›ä¸€å¼µ");
        }
      }

      // ---------- Init / bind ----------
      function bind(){
        $("btnSettings").onclick = settingsModal;
        $("btnCloseModal").onclick = closeModal;
        $("modalWrap").addEventListener("click", (e)=>{
          if(e.target === $("modalWrap")) closeModal();
        });

        $("btnCamera").onclick = openCameraSmart;
        $("btnAlbum").onclick = openAlbum;

        $("btnUploadCenter").onclick = openAlbum;
        $("tapZone").onclick = (e)=>{
          // é»èƒŒæ™¯ä¹Ÿèƒ½é–‹ç›¸ç°¿ï¼ˆé¿å…é»ä¸åˆ°ï¼‰
          if(e.target === $("tapZone") || e.target.classList.contains("rings")) openAlbum();
        };

        $("inCamera").addEventListener("change", (e)=>{
          const f = e.target.files && e.target.files[0];
          // reset value so selecting same file twice still triggers change
          e.target.value = "";
          handleFile(f);
        });

        $("inAlbum").addEventListener("change", (e)=>{
          const f = e.target.files && e.target.files[0];
          e.target.value = "";
          handleFile(f);
        });
      }

      function init(){
        loadCfg();
        loadRecords();   // âœ… crash ä¿®å¥½ï¼šå³ä½¿æ˜¯ null ä¹Ÿæœƒè®Šæˆ []
        detectEnv();
        renderText();
        renderHistory();

        // å¦‚æœä¸æ˜¯ HTTPSï¼Œæé†’ä½†ä¸é˜»æ­¢
        if(!state.env.isHttps){
          toast("æé†’ï¼šé HTTPS å¯èƒ½å½±éŸ¿ç›¸æ©ŸåŠŸèƒ½");
        }

        // In-app hint (å¯é—œ)
        if(state.env.inApp && state.cfg.showInAppHint){
          $("hintText").style.display = "block";
        }

        bind();
      }

      // âœ… ç¢ºä¿ DOM æº–å‚™å¥½æ‰ initï¼ˆé¿å…äº‹ä»¶ç¶ä¸ä¸Šï¼‰
      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
