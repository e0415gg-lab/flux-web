<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0B1024" />
  <title>Flux Companion</title>
  <style>
    :root{
      --bg1:#070A16;
      --bg2:#0B1024;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.66);
      --muted2:rgba(255,255,255,.46);
      --accent1:#6C63FF;
      --accent2:#3A9DFF;
      --good:#36d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --radius:22px;
      --radius2:16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(108,99,255,.30), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(58,157,255,.22), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100%;
      overflow-x:hidden;
    }

    .wrap{max-width:980px;margin:0 auto;padding:18px 16px 42px}
    .top{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 6px 14px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .dot{
      width:12px;height:12px;border-radius:50%;
      background:linear-gradient(135deg,var(--accent2),var(--accent1));
      box-shadow:0 0 0 6px rgba(108,99,255,.14);
    }
    .brand h1{
      font-size:18px; margin:0; letter-spacing:.2px; font-weight:750;
    }
    .badgeRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      font-size:12px; padding:7px 10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(255,255,255,.78);
      display:inline-flex; align-items:center; gap:6px;
      backdrop-filter: blur(10px);
    }
    .pill .led{width:8px;height:8px;border-radius:50%; background:var(--good)}
    .pill.warn .led{background:var(--warn)}
    .pill.bad .led{background:var(--bad)}

    .iconBtn{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      display:grid; place-items:center;
      cursor:pointer;
      backdrop-filter: blur(10px);
    }
    .iconBtn:active{transform:scale(.98)}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media(min-width:920px){
      .grid{grid-template-columns: 1.15fr .85fr; align-items:start}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hero{
      padding:22px 20px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .hero .today{
      font-size:12px; letter-spacing:.9px;
      color:rgba(255,255,255,.50);
      text-transform:uppercase;
      margin-bottom:10px;
    }
    .hero .title{
      font-size:40px; line-height:1.05; margin:0 0 10px; font-weight:820;
      letter-spacing:.2px;
    }
    .hero .sub{
      margin:0;
      color:rgba(255,255,255,.74);
      line-height:1.6;
      font-size:15px;
    }

    .stage{
      padding:18px 20px 20px;
    }
    .ring{
      height:240px;
      display:grid; place-items:center;
      border-radius:var(--radius);
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(100px 100px at 50% 48%, rgba(255,255,255,.10), transparent 65%),
        radial-gradient(260px 260px at 50% 60%, rgba(108,99,255,.20), transparent 60%),
        radial-gradient(340px 340px at 50% 60%, rgba(58,157,255,.14), transparent 62%);
      border:1px solid rgba(255,255,255,.08);
    }
    .camBtnBig{
      width:86px;height:86px;border-radius:26px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.16);
      display:grid; place-items:center;
    }
    .camBtnBig svg{opacity:.92}

    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    .btn{
      border:none;
      border-radius:16px;
      padding:14px 14px;
      font-size:16px;
      font-weight:750;
      cursor:pointer;
      color:rgba(255,255,255,.92);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--accent1),var(--accent2));
      border:none;
    }
    .btn:active{transform:scale(.99)}
    .hint{
      margin-top:10px;
      color:rgba(255,255,255,.62);
      font-size:13px;
      line-height:1.55;
    }

    .drop{
      margin-top:14px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.18);
      padding:14px;
      color:rgba(255,255,255,.60);
      font-size:13px;
      text-align:center;
      background:rgba(0,0,0,.12);
    }
    .drop strong{color:rgba(255,255,255,.78)}
    .preview{
      margin-top:14px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .thumb{
      width:96px;height:96px;border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      overflow:hidden;
      display:grid; place-items:center;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .meta{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(255,255,255,.76);
    }

    .replyCard{
      margin-top:14px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:20px;
      padding:16px 16px 14px;
    }
    .replyTitle{
      display:flex; align-items:center; gap:10px;
      font-weight:820;
      margin-bottom:10px;
    }
    .heart{
      width:22px;height:22px;border-radius:8px;
      display:grid; place-items:center;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
    }
    .replyText{
      color:rgba(255,255,255,.82);
      line-height:1.75;
      font-size:15px;
      white-space:pre-wrap;
    }
    .footerBtns{
      display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;
    }
    .btn2{
      border-radius:14px;
      padding:12px 14px;
      font-size:15px;
      font-weight:800;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.07);
      color:rgba(255,255,255,.92);
    }
    .btn2.dark{
      background:rgba(0,0,0,.20);
    }

    .side{
      padding:18px;
    }
    .side h2{margin:0 0 10px; font-size:16px; font-weight:850}
    .side p{margin:0 0 14px; color:rgba(255,255,255,.70); line-height:1.6; font-size:13px}
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      border-radius:16px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
    }
    .item:active{transform:scale(.995)}
    .itemThumb{
      width:52px;height:52px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      background:rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .itemThumb img{width:100%;height:100%;object-fit:cover}
    .itemMeta{flex:1; min-width:0}
    .itemMeta .t{font-weight:820; font-size:13px; margin-bottom:2px}
    .itemMeta .d{font-size:12px; color:rgba(255,255,255,.62); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .itemActions{display:flex; gap:8px}
    .mini{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
    }

    .note{
      margin-top:12px;
      color:rgba(255,255,255,.42);
      font-size:12px;
      line-height:1.55;
    }

    /* Modal */
    .modalWrap{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:18px 12px 22px;
      z-index:50;
    }
    .modal{
      width:min(640px, 100%);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead h3{margin:0; font-size:16px; font-weight:900}
    .modalBody{padding:14px}
    .row{display:flex; flex-direction:column; gap:8px; margin-bottom:12px}
    label{font-size:12px; color:rgba(255,255,255,.70)}
    input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.92);
      outline:none;
    }
    .checkRow{display:flex; align-items:center; gap:10px}
    .checkRow input{width:18px;height:18px}
    .modalBtns{display:flex; gap:10px; padding:0 14px 14px}
    .modalBtns .btn{flex:1}

    /* small toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:20px;
      background:rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      display:none;
      z-index:60;
      backdrop-filter: blur(10px);
      max-width:min(560px, calc(100vw - 24px));
    }

    /* hidden inputs */
    input[type="file"]{position:absolute; left:-9999px; width:1px; height:1px; opacity:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1 id="appName">Flux Companion</h1>
          <div style="font-size:12px;color:rgba(255,255,255,.62);margin-top:2px" id="subtitle">Your Gentle AI Listener</div>
        </div>
      </div>
      <div class="badgeRow">
        <span class="pill" id="modePill"><span class="led"></span><span id="modeText">Stable v4.5</span></span>
        <span class="pill" id="browserPill"><span class="led"></span><span id="browserText">Browser: Normal</span></span>
        <span class="pill" id="httpsPill"><span class="led"></span><span id="httpsText">HTTPS: OK</span></span>
        <button class="iconBtn" id="settingsBtn" title="è¨­å®š">
          <!-- gear -->
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M12 15.6a3.6 3.6 0 1 0 0-7.2 3.6 3.6 0 0 0 0 7.2Z" stroke="currentColor" stroke-width="2"/>
            <path d="M19.4 15a8.9 8.9 0 0 0 .1-1l2-1.5-2-3.5-2.4.8a8.5 8.5 0 0 0-.8-.7l-.2-2.5H10l-.2 2.5c-.3.2-.6.4-.8.7l-2.4-.8-2 3.5 2 1.5a8.9 8.9 0 0 0 .1 1l-2 1.5 2 3.5 2.4-.8c.2.3.5.5.8.7L10 22h4l.2-2.5c.3-.2.6-.4.8-.7l2.4.8 2-3.5-2-1.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="grid">
      <!-- Main -->
      <div class="card">
        <div class="hero">
          <div class="today">TODAY</div>
          <h2 class="title" id="greeting">ä»Šå¤©çš„ä½ ï¼Œé‚„å¥½å—ï¼Ÿ</h2>
          <p class="sub" id="greetingSub">æŠŠæ­¤åˆ»äº¤çµ¦æˆ‘ï¼Œæˆ‘æœƒæº«æŸ”ç†è§£ã€‚</p>
        </div>

        <div class="stage">
          <div class="ring" id="dropZone">
            <div class="camBtnBig" aria-hidden="true">
              <!-- camera icon -->
              <svg width="36" height="36" viewBox="0 0 24 24" fill="none">
                <path d="M9 7 10.5 5h3L15 7h3a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h3Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                <path d="M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="white" stroke-width="2"/>
              </svg>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="cameraBtn">æ‹ç…§</button>
            <button class="btn" id="albumBtn">ç›¸ç°¿</button>
          </div>

          <div class="hint" id="inAppHint" style="display:none">
            è‹¥åœ¨æŸäº› App å…§å»ºç€è¦½å™¨å—é™ï¼Œå»ºè­°ç”¨ <strong>Chrome / Safari</strong> é–‹å•Ÿã€‚æœ¬é æœƒè‡ªå‹•æ”¹ç”¨ç›¸ç°¿é¿å…å¡æ­»ã€‚
          </div>

          <div class="drop" id="dropText">
            <strong>ä½ ä¹Ÿå¯ä»¥æŠŠåœ–ç‰‡æ‹–é€²ä¾†</strong>ï¼ˆé›»è…¦æ¸¬è©¦å¾ˆæ–¹ä¾¿ï¼‰<br/>
            ä¸åšé†«ç™‚è¨ºæ–·ï¼Œåªåšã€Œæƒ…å¢ƒæ„Ÿå—ã€é™ªä¼´å›è¦†ã€‚
          </div>

          <div class="preview" id="preview" style="display:none">
            <div class="thumb"><img id="previewImg" alt="é è¦½" /></div>
            <div class="meta">
              <div class="chips" id="chips"></div>
              <div style="font-size:12px;color:rgba(255,255,255,.58)" id="imgMeta"></div>
            </div>
          </div>

          <div class="replyCard" id="replyCard" style="display:none">
            <div class="replyTitle">
              <div class="heart">ğŸ’›</div>
              <div>AI å›è¦†</div>
            </div>
            <div class="replyText" id="replyText"></div>

            <div class="footerBtns">
              <button class="btn2" id="saveBtn">å­˜æˆç´€éŒ„</button>
              <button class="btn2 dark" id="backBtn">å›é¦–é </button>
              <button class="btn2 dark" id="copyBtn">è¤‡è£½æ–‡å­—</button>
            </div>

            <div class="note">
              é€™æ˜¯é™ªä¼´å¼å›è¦†ï¼ˆA:å…±æ„Ÿå‚¾è½ + B:æº«æŸ”æ­£èƒ½é‡å»ºè­°ï¼‰ï¼Œä¸ç­‰æ–¼é†«ç™‚æˆ–å¿ƒç†æ²»ç™‚å»ºè­°ã€‚
            </div>
          </div>

          <!-- Inputs -->
          <input id="cameraInput" type="file" accept="image/*" capture="environment" />
          <input id="albumInput" type="file" accept="image/*" />
        </div>
      </div>

      <!-- Side -->
      <div class="card">
        <div class="side">
          <h2>ä½ çš„ç´€éŒ„</h2>
          <p>æ¯ä¸€ç­†éƒ½æ˜¯ä¸€å€‹ã€Œè¢«ç†è§£çš„ç¬é–“ã€ã€‚é»é–‹å¯å›çœ‹ï¼Œæˆ–åˆªé™¤ã€‚</p>
          <div class="list" id="list"></div>
          <div class="note">
            è³‡æ–™åªå­˜ä½ æ‰‹æ©Ÿ/ç€è¦½å™¨æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚æ›´æ›è£ç½®å°±ä¸æœƒåŒæ­¥ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modalWrap" id="modalWrap">
    <div class="modal">
      <div class="modalHead">
        <h3>è¨­å®š</h3>
        <button class="iconBtn" id="closeModal" title="é—œé–‰">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modalBody">
        <div class="row">
          <label>æ¨¡å¼é¡¯ç¤ºæ–‡å­—ï¼ˆå³ä¸Šè§’æ¨™ç±¤ï¼‰</label>
          <input type="text" id="modeInput" placeholder="ä¾‹å¦‚ï¼šStable v4.5" />
        </div>
        <div class="row">
          <label>å‰¯æ¨™ï¼ˆApp ä»‹ç´¹ï¼‰</label>
          <input type="text" id="subtitleInput" placeholder="ä¾‹å¦‚ï¼šYour Gentle AI Listener" />
        </div>
        <div class="row">
          <div class="checkRow">
            <input type="checkbox" id="hintToggle" />
            <label for="hintToggle">é¡¯ç¤ºã€Œå…§å»ºç€è¦½å™¨å¯èƒ½é™åˆ¶ç›¸æ©Ÿã€æç¤º</label>
          </div>
        </div>
      </div>
      <div class="modalBtns">
        <button class="btn primary" id="saveSettings">å„²å­˜</button>
        <button class="btn" id="resetSettings">é‡ç½®</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  const STORAGE_KEY = "flux_companion_v45";
  const SETTINGS_KEY = "flux_companion_settings_v45";

  const $ = (id) => document.getElementById(id);

  const state = {
    settings: {
      modeText: "Stable v4.5",
      subtitle: "Your Gentle AI Listener",
      showInAppHint: true,
    },
    env: {
      isHttps: location.protocol === "https:",
      isInApp: false,
      browserLabel: "Normal",
    },
    current: {
      imageDataURL: "",
      thumbDataURL: "",
      tags: [],
      meta: "",
      reply: "",
      createdAt: 0,
    },
    records: [],
  };

  // ---------- Utilities ----------
  const nowTs = () => Date.now();
  const fmtTime = (ts) => {
    const d = new Date(ts);
    const pad = (n) => String(n).padStart(2,"0");
    return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  };

  const toast = (msg) => {
    const el = $("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(() => (el.style.display = "none"), 1700);
  };

  const safeJSONParse = (s, fallback) => {
    try { return JSON.parse(s); } catch { return fallback; }
  };

  const persistRecords = () => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.records));
  };

  const persistSettings = () => {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(state.settings));
  };

  const loadAll = () => {
    state.records = safeJSONParse(localStorage.getItem(STORAGE_KEY), []);
    const savedSettings = safeJSONParse(localStorage.getItem(SETTINGS_KEY), null);
    if (savedSettings && typeof savedSettings === "object") {
      state.settings = { ...state.settings, ...savedSettings };
    }
  };

  // ---------- Environment Detection ----------
  const detectInApp = () => {
    const ua = navigator.userAgent || "";
    const isFB = /FBAN|FBAV|FB_IAB/i.test(ua);
    const isIG = /Instagram/i.test(ua);
    const isLine = /Line|LIFF/i.test(ua);
    const isWeChat = /MicroMessenger/i.test(ua);
    const isTikTok = /TikTok/i.test(ua);
    const isGSA = /\bGSA\b/i.test(ua); // Google App
    const isWebView = /(wv|; wv\)|Version\/\d+\.\d+.*Chrome\/\d+.*Mobile Safari\/\d+)/i.test(ua);
    return isFB || isIG || isLine || isWeChat || isTikTok || isGSA || isWebView;
  };

  const detectBrowserLabel = () => {
    const ua = navigator.userAgent || "";
    if (/CriOS/i.test(ua)) return "Chrome(iOS)";
    if (/EdgA|EdgiOS|Edg/i.test(ua)) return "Edge";
    if (/Chrome/i.test(ua) && !/OPR|Edg/i.test(ua)) return "Chrome";
    if (/Safari/i.test(ua) && !/Chrome|CriOS/i.test(ua)) return "Safari";
    return "Normal";
  };

  // ---------- UI Render ----------
  const applySettingsToUI = () => {
    $("modeText").textContent = state.settings.modeText;
    $("subtitle").textContent = state.settings.subtitle;

    $("modeInput").value = state.settings.modeText;
    $("subtitleInput").value = state.settings.subtitle;
    $("hintToggle").checked = !!state.settings.showInAppHint;

    // In-app hint visibility
    const shouldShow = state.settings.showInAppHint && state.env.isInApp;
    $("inAppHint").style.display = shouldShow ? "block" : "none";
  };

  const applyEnvBadges = () => {
    // Browser badge
    $("browserText").textContent = `Browser: ${state.env.browserLabel}`;
    $("browserPill").classList.remove("warn","bad");
    $("browserPill").querySelector(".led").style.background = state.env.isInApp ? "var(--warn)" : "var(--good)";
    if (state.env.isInApp) $("browserPill").classList.add("warn");

    // HTTPS badge
    $("httpsText").textContent = state.env.isHttps ? "HTTPS: OK" : "HTTPS: NO";
    $("httpsPill").classList.remove("warn","bad");
    $("httpsPill").querySelector(".led").style.background = state.env.isHttps ? "var(--good)" : "var(--bad)";
    if (!state.env.isHttps) $("httpsPill").classList.add("bad");
  };

  const renderList = () => {
    const list = $("list");
    list.innerHTML = "";
    if (!state.records.length) {
      const empty = document.createElement("div");
      empty.className = "note";
      empty.textContent = "ç›®å‰é‚„æ²’æœ‰ç´€éŒ„ã€‚ä¸Šå‚³ä¸€å¼µç…§ç‰‡ï¼Œè®“æˆ‘é™ªä½ èªªèªªç•¶ä¸‹ã€‚";
      list.appendChild(empty);
      return;
    }

    state.records
      .slice()
      .sort((a,b) => b.createdAt - a.createdAt)
      .forEach((r) => {
        const item = document.createElement("div");
        item.className = "item";

        const th = document.createElement("div");
        th.className = "itemThumb";
        const img = document.createElement("img");
        img.src = r.thumbDataURL || "";
        img.alt = "thumb";
        th.appendChild(img);

        const meta = document.createElement("div");
        meta.className = "itemMeta";
        const t = document.createElement("div");
        t.className = "t";
        t.textContent = fmtTime(r.createdAt);
        const d = document.createElement("div");
        d.className = "d";
        d.textContent = (r.tags || []).join(" Â· ") || "ï¼ˆç„¡æ¨™ç±¤ï¼‰";
        meta.appendChild(t);
        meta.appendChild(d);

        const acts = document.createElement("div");
        acts.className = "itemActions";

        const openBtn = document.createElement("button");
        openBtn.className = "mini";
        openBtn.title = "æ‰“é–‹";
        openBtn.innerHTML = "â†—";
        openBtn.onclick = (e) => {
          e.stopPropagation();
          openRecord(r.id);
        };

        const delBtn = document.createElement("button");
        delBtn.className = "mini";
        delBtn.title = "åˆªé™¤";
        delBtn.innerHTML = "ğŸ—‘";
        delBtn.onclick = (e) => {
          e.stopPropagation();
          removeRecord(r.id);
        };

        acts.appendChild(openBtn);
        acts.appendChild(delBtn);

        item.appendChild(th);
        item.appendChild(meta);
        item.appendChild(acts);

        item.onclick = () => openRecord(r.id);

        list.appendChild(item);
      });
  };

  const openRecord = (id) => {
    const r = state.records.find(x => x.id === id);
    if (!r) return;
    state.current = {
      imageDataURL: r.imageDataURL,
      thumbDataURL: r.thumbDataURL,
      tags: r.tags,
      meta: r.meta,
      reply: r.reply,
      createdAt: r.createdAt,
    };
    showPreviewAndReply();
    toast("å·²æ‰“é–‹ç´€éŒ„");
  };

  const removeRecord = (id) => {
    state.records = state.records.filter(x => x.id !== id);
    persistRecords();
    renderList();
    toast("å·²åˆªé™¤");
  };

  const showPreviewAndReply = () => {
    $("preview").style.display = "flex";
    $("replyCard").style.display = "block";
    $("previewImg").src = state.current.imageDataURL;

    $("chips").innerHTML = "";
    (state.current.tags || []).forEach(tag => {
      const c = document.createElement("span");
      c.className = "chip";
      c.textContent = tag;
      $("chips").appendChild(c);
    });
    $("imgMeta").textContent = state.current.meta || "";
    $("replyText").textContent = state.current.reply || "";
    $("dropText").style.display = "none";
  };

  const backHome = () => {
    state.current = {
      imageDataURL: "",
      thumbDataURL: "",
      tags: [],
      meta: "",
      reply: "",
      createdAt: 0,
    };
    $("preview").style.display = "none";
    $("replyCard").style.display = "none";
    $("dropText").style.display = "block";
  };

  // ---------- Image Processing (simple + stable) ----------
  const loadImageFromFile = (file) => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(String(reader.result || ""));
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });

  const imgFromDataURL = (dataURL) => new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = dataURL;
  });

  const resizeToThumb = (img, maxSide=256) => {
    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;
    const scale = Math.min(1, maxSide / Math.max(w,h));
    const tw = Math.max(1, Math.round(w * scale));
    const th = Math.max(1, Math.round(h * scale));
    const c = document.createElement("canvas");
    c.width = tw; c.height = th;
    const ctx = c.getContext("2d", { willReadFrequently:true });
    ctx.drawImage(img, 0, 0, tw, th);
    return c.toDataURL("image/jpeg", 0.80);
  };

  const analyzeImage = async (dataURL) => {
    const img = await imgFromDataURL(dataURL);

    // sample down to 64x64 for quick stats
    const c = document.createElement("canvas");
    const sw = 64, sh = 64;
    c.width = sw; c.height = sh;
    const ctx = c.getContext("2d", { willReadFrequently:true });
    ctx.drawImage(img, 0, 0, sw, sh);
    const { data } = ctx.getImageData(0,0,sw,sh);

    let sumL=0, sumR=0, sumG=0, sumB=0;
    let sumL2=0;
    let n=0;

    // luminance & color means
    for (let i=0;i<data.length;i+=4){
      const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
      if (a < 10) continue;
      const l = 0.2126*r + 0.7152*g + 0.0722*b;
      sumL += l;
      sumL2 += l*l;
      sumR += r; sumG += g; sumB += b;
      n++;
    }
    if (!n) n=1;
    const meanL = sumL/n;
    const varL = Math.max(0, (sumL2/n) - (meanL*meanL));
    const stdL = Math.sqrt(varL);

    const meanR = sumR/n, meanG = sumG/n, meanB = sumB/n;

    // warmth approximation: (R - B) and (R+G - 2B) vibe
    const warmth = (meanR - meanB);
    const neutral = Math.abs(meanR-meanG) + Math.abs(meanG-meanB);
    const contrast = stdL;

    // tags (NO scoring)
    const tags = [];

    // brightness
    if (meanL < 65) tags.push("æ˜æš—ï¼šåæš—");
    else if (meanL > 175) tags.push("æ˜æš—ï¼šåäº®");
    else tags.push("æ˜æš—ï¼šæŸ”å’Œ");

    // tone
    if (warmth > 18) tags.push("è‰²èª¿ï¼šåæš–");
    else if (warmth < -18) tags.push("è‰²èª¿ï¼šåå†·");
    else tags.push("è‰²èª¿ï¼šä¸­æ€§");

    // atmosphere
    if (contrast < 28) tags.push("æ°›åœï¼šæº«æŸ”å¹³éœ");
    else if (contrast > 62) tags.push("æ°›åœï¼šæ¸…æ™°æœ‰åŠ›");
    else tags.push("æ°›åœï¼šç©©å®šè‡ªç„¶");

    // simple quality reminder (still allow)
    let reminder = "";
    if (meanL < 55) reminder = "ç…§ç‰‡åæš—ï¼›è‹¥å¯ä»¥ï¼Œæ›åˆ°å…‰ç·šæ›´è¶³çš„åœ°æ–¹æœƒæ›´èˆ’æœã€‚";
    else if (meanL > 190) reminder = "ç…§ç‰‡åäº®ï¼›ç¨å¾®é¿é–‹ç›´å°„å…‰ï¼Œç•«é¢æœƒæ›´æŸ”å’Œã€‚";
    else if (contrast < 22) reminder = "ç•«é¢å°æ¯”åä½ï¼›é è¿‘ä¸€é»æˆ–å°ç„¦æ¸…æ¥šæœƒæ›´æœ‰ç´°ç¯€ã€‚";
    else reminder = "ç…§ç‰‡ç‹€æ…‹ç©©å®šï¼Œå¯ä»¥ç›´æ¥ç”¨é€™å¼µä¾†è¨˜éŒ„ç•¶ä¸‹ã€‚";

    const meta = `${img.naturalWidth || img.width}Ã—${img.naturalHeight || img.height} Â· ${state.env.browserLabel} Â· ${state.env.isHttps ? "HTTPS âœ“" : "HTTPS âœ—"}`;

    return { tags, reminder, meta, img };
  };

  // ---------- A+B Companion Reply ----------
  const pick = (arr, seed) => arr[Math.abs(seed) % arr.length];

  const hashLite = (s) => { // deterministic, tiny hash
    let h = 2166136261;
    for (let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  };

  const buildReplyAB = ({ tags, reminder, dataURL }) => {
    const seed = hashLite((tags||[]).join("|") + "|" + (dataURL ? dataURL.slice(0,80) : ""));
    const tone = (tags||[]).find(t=>t.includes("è‰²èª¿")) || "";
    const light = (tags||[]).find(t=>t.includes("æ˜æš—")) || "";
    const vibe = (tags||[]).find(t=>t.includes("æ°›åœ")) || "";

    // A: å‚¾è½/å…±æ„Ÿ
    const A = [
      "æˆ‘åœ¨ã€‚",
      "æˆ‘æœ‰è½è¦‹ä½ ã€‚",
      "ä½ ä¸ç”¨æ€¥è‘—æŠŠä¸€åˆ‡è¬›æ¸…æ¥šï¼Œæˆ‘æœƒé™ªä½ æ…¢æ…¢ä¾†ã€‚",
      "è¬è¬ä½ æŠŠé€™ä¸€åˆ»äº¤çµ¦æˆ‘ã€‚",
      "ä½ èƒ½ä¾†åˆ°é€™è£¡ï¼Œæœ¬èº«å°±å¾ˆå‹‡æ•¢ã€‚"
    ];

    // B: æ­£èƒ½é‡ + å°è€Œå¯åšçš„å»ºè­°ï¼ˆä¸èªªæ•™ï¼‰
    const B1 = [
      "å¦‚æœä½ é¡˜æ„ï¼Œå…ˆåšä¸€ä»¶å¾ˆå°çš„äº‹ï¼šæ·±å‘¼å¸ä¸‰æ¬¡ï¼Œè®“è‚©è†€æ”¾é¬†ä¸€é»ã€‚",
      "ä»Šå¤©ä¸éœ€è¦å®Œç¾ï¼Œåªè¦æŠŠè‡ªå·±ç…§é¡§å¥½å°±ç®—è´ã€‚",
      "ä½ ä¸å¿…ä¸€å€‹äººæ‰›è‘—ï¼›æŠŠæ„Ÿå—æ”¾ä¸‹ä¾†ï¼Œæˆ‘æœƒæ¥ä½ã€‚",
      "æŠŠæ³¨æ„åŠ›æ‹‰å›ç•¶ä¸‹ï¼šå–ä¸€å£æ°´ã€çœ‹å‘é æ–¹ä¸‰ç§’ï¼Œè®“å¿ƒæ…¢ä¸€é»ã€‚",
      "ä½ å·²ç¶“æ¯”ä½ ä»¥ç‚ºçš„æ›´ç©©äº†ã€‚"
    ];
    const B2 = [
      "ä½ æƒ³æŠŠä»Šå¤©å®šç¾©æˆã€Œä¼‘æ¯æ—¥ã€æˆ–ã€Œé‡æ–°æ•´ç†æ—¥ã€éƒ½å¯ä»¥ã€‚",
      "ä½ å¯ä»¥åªå®Œæˆä¸€ä»¶äº‹ï¼šæŠŠè‡ªå·±æ”¾å›å®‰å…¨çš„ä½ç½®ã€‚",
      "å¦‚æœè…¦è¢‹å¾ˆåµï¼Œå…ˆæŠŠæœ€åœ¨æ„çš„ä¸€å¥è©±å¯«ä¸‹ä¾†å°±å¥½ã€‚",
      "å¦‚æœä½ æƒ³ï¼Œæˆ‘ä¹Ÿå¯ä»¥ç•¶ä½ çš„ã€æ­£èƒ½é‡æœ‹å‹ã€ï¼šä½ èªªï¼Œæˆ‘è½ã€‚",
      "æˆ‘å€‘æŠŠä»Šå¤©æ‹†å°ï¼šå…ˆæ’éé€™ä¸€åˆ»å°±å¥½ã€‚"
    ];

    const a = pick(A, seed);
    const b1 = pick(B1, seed + 11);
    const b2 = pick(B2, seed + 29);

    const describe = `æˆ‘çœ‹é€™å¼µç…§ç‰‡ï¼š${light}ã€${tone}ï¼Œè€Œä¸”${vibe}ã€‚`;
    const gentleNote = `\n\nå°æé†’ï¼š${reminder}`;

    // Final: A + describe + A bridge + B
    return `${a}\n\n${describe}\n\nä½ é¡˜æ„æŠŠé€™ä¸€åˆ»äº¤çµ¦æˆ‘ï¼Œä»£è¡¨ä½ å…¶å¯¦å·²ç¶“å¾ˆåŠªåŠ›äº†ã€‚\n\n${b1}\n${b2}${gentleNote}`;
  };

  // ---------- Smart Fallback Camera ----------
  const smartTriggerCamera = () => {
    const camInput = $("cameraInput");
    const albInput = $("albumInput");

    // attempt camera
    let didBlur = false;
    let timeoutHit = false;

    const onBlur = () => { didBlur = true; };
    window.addEventListener("blur", onBlur, { once:true });

    try { camInput.value = ""; } catch {}
    camInput.click();

    // If no blur within 650ms -> likely blocked; fall back to album
    setTimeout(() => {
      timeoutHit = true;
      window.removeEventListener("blur", onBlur);
      if (!didBlur) {
        try { albInput.value = ""; } catch {}
        albInput.click();
        toast("ç›¸æ©Ÿå—é™ï¼Œå·²æ”¹ç”¨ç›¸ç°¿");
      }
    }, 650);

    // If blur happened, user went to camera; no further action here
    // If they cancel camera, we still won't know; but album button exists
    void timeoutHit;
  };

  // ---------- Handlers ----------
  const handleFile = async (file) => {
    if (!file) return;
    if (!file.type || !file.type.startsWith("image/")) {
      toast("è«‹é¸æ“‡åœ–ç‰‡æª”");
      return;
    }

    const dataURL = await loadImageFromFile(file);
    const { tags, reminder, meta, img } = await analyzeImage(dataURL);
    const thumb = resizeToThumb(img, 256);
    const reply = buildReplyAB({ tags, reminder, dataURL });

    state.current = {
      imageDataURL: dataURL,
      thumbDataURL: thumb,
      tags,
      meta,
      reply,
      createdAt: nowTs(),
    };

    showPreviewAndReply();
  };

  const saveRecord = () => {
    if (!state.current.imageDataURL) return;
    const id = "r_" + state.current.createdAt + "_" + Math.random().toString(16).slice(2);
    state.records.push({
      id,
      createdAt: state.current.createdAt,
      imageDataURL: state.current.imageDataURL,
      thumbDataURL: state.current.thumbDataURL,
      tags: state.current.tags,
      meta: state.current.meta,
      reply: state.current.reply,
    });
    persistRecords();
    renderList();
    toast("å·²å­˜æˆç´€éŒ„");
  };

  const copyReply = async () => {
    const txt = state.current.reply || "";
    if (!txt) return;
    try{
      await navigator.clipboard.writeText(txt);
      toast("å·²è¤‡è£½");
    }catch{
      // fallback
      const ta = document.createElement("textarea");
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("å·²è¤‡è£½");
    }
  };

  // ---------- Settings Modal ----------
  const openModal = () => $("modalWrap").style.display = "flex";
  const closeModal = () => $("modalWrap").style.display = "none";

  const saveSettings = () => {
    const mode = $("modeInput").value.trim() || "Stable v4.5";
    const sub = $("subtitleInput").value.trim() || "Your Gentle AI Listener";
    const show = $("hintToggle").checked;

    state.settings.modeText = mode;
    state.settings.subtitle = sub;
    state.settings.showInAppHint = show;

    persistSettings();
    applySettingsToUI();
    toast("å·²å„²å­˜è¨­å®š");
    closeModal();
  };

  const resetSettings = () => {
    state.settings = {
      modeText: "Stable v4.5",
      subtitle: "Your Gentle AI Listener",
      showInAppHint: true,
    };
    persistSettings();
    applySettingsToUI();
    toast("å·²é‡ç½®");
  };

  // ---------- Drag & Drop ----------
  const bindDrop = () => {
    const dz = $("dropZone");
    const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };

    ["dragenter","dragover","dragleave","drop"].forEach(ev => {
      dz.addEventListener(ev, prevent);
    });

    dz.addEventListener("drop", async (e) => {
      const f = e.dataTransfer?.files?.[0];
      if (f) await handleFile(f);
    });
  };

  // ---------- Init ----------
  const init = () => {
    loadAll();

    state.env.isInApp = detectInApp();
    state.env.browserLabel = detectBrowserLabel();
    applyEnvBadges();
    applySettingsToUI();
    renderList();
    bindDrop();

    // Buttons
    $("settingsBtn").onclick = openModal;
    $("closeModal").onclick = closeModal;
    $("modalWrap").onclick = (e) => { if (e.target === $("modalWrap")) closeModal(); };
    $("saveSettings").onclick = saveSettings;
    $("resetSettings").onclick = resetSettings;

    $("cameraBtn").onclick = smartTriggerCamera;
    $("albumBtn").onclick = () => { try{ $("albumInput").value=""; }catch{} $("albumInput").click(); };

    $("cameraInput").addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      await handleFile(f);
    });
    $("albumInput").addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      await handleFile(f);
    });

    $("saveBtn").onclick = saveRecord;
    $("backBtn").onclick = backHome;
    $("copyBtn").onclick = copyReply;

    // Optional: click the ring opens album (safe)
    $("dropZone").onclick = () => {
      // Keep it gentle: open album (most compatible)
      try{ $("albumInput").value=""; }catch{}
      $("albumInput").click();
    };
  };

  init();
})();
</script>
</body>
</html>
