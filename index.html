<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Flux</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#fff;
      --text:#111;
      --muted:#666;
      --line:rgba(0,0,0,.08);
      --card:#fafafa;
      --btn:#111;
      --btnText:#fff;
      --dangerBg:#fff0f0;
      --danger:#c00;
      --shadow:0 26px 60px rgba(0,0,0,.08);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0b0c;
        --text:#f3f3f3;
        --muted:#b6b6b6;
        --line:rgba(255,255,255,.12);
        --card:rgba(255,255,255,.06);
        --btn:#f3f3f3;
        --btnText:#111;
        --dangerBg:rgba(255,0,0,.08);
        --danger:#ff6b6b;
        --shadow:0 26px 60px rgba(0,0,0,.35);
      }
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }

    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

    .app{ min-height:100vh; position:relative; overflow:hidden; }
    .page{
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      animation:fadeIn .18s ease-out;
    }

    /* Glow background */
    .glowBg{
      position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(210,226,255,0.55), rgba(255,255,255,0) 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(255,220,210,0.45), rgba(255,255,255,0) 55%),
        radial-gradient(900px 700px at 50% 80%, rgba(220,245,235,0.40), rgba(255,255,255,0) 60%);
      opacity:.9;
    }
    @media (prefers-color-scheme: dark){
      .glowBg{ opacity:.35; }
    }

    .topBar{
      height:56px; padding:0 16px;
      display:flex; align-items:center; justify-content:space-between;
      position:relative; z-index:2;
    }
    .brand{ font-size:18px; font-weight:700; letter-spacing:.3px; display:flex; align-items:center; gap:10px; }
    .pill{
      font-size:11px; font-weight:700;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.6);
    }
    @media (prefers-color-scheme: dark){
      .pill{ background:rgba(0,0,0,.35); }
    }

    .iconBtn{
      width:40px;height:40px;border-radius:999px;
      border:1px solid transparent;
      background:transparent;color:var(--text);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;font-size:18px;
    }
    .iconBtn:active{ transform:scale(.98); }

    .content{ flex:1; overflow:auto; padding:24px; padding-bottom:110px; position:relative; z-index:2; }

    /* Home center */
    .center{
      flex:1; display:flex; flex-direction:column; align-items:center;
      padding-top:32px; padding-bottom:24px;
    }
    .todayLabel{ font-size:12px; letter-spacing:1.5px; font-weight:800; color:var(--muted); margin-bottom:8px; }
    .greetingTitle{ font-size:26px; font-weight:800; margin:0 0 6px; text-align:center; padding:0 18px; line-height:1.2; }
    .greetingSub{ font-size:15px; color:var(--muted); margin:0 0 28px; text-align:center; padding:0 18px; line-height:1.6; }

    .bigCircleBtn{
      width:220px;height:220px;border-radius:999px;
      border:1px solid rgba(255,255,255,.75);
      background:rgba(255,255,255,.35);
      box-shadow:var(--shadow);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      position:relative;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    @media (prefers-color-scheme: dark){
      .bigCircleBtn{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); }
    }
    .circleRing{ position:absolute; inset:16px; border-radius:999px; border:1px solid var(--line); pointer-events:none; }
    .camIcon{ opacity:.9; display:flex; align-items:center; justify-content:center; font-size:52px; }
    .spinner{ width:26px;height:26px;border:2px solid rgba(0,0,0,.2); border-top-color:rgba(0,0,0,.7); border-radius:50%; animation:spin 1s linear infinite; }
    @media (prefers-color-scheme: dark){
      .spinner{ border:2px solid rgba(255,255,255,.25); border-top-color:rgba(255,255,255,.85); }
    }
    .cta{ margin-top:18px; font-size:16px; font-weight:800; opacity:.95; }
    .homeHint{ margin-top:8px; font-size:13px; color:var(--muted); opacity:.9; text-align:center; padding:0 18px; line-height:1.5; }

    /* Tabs */
    .tabBar{
      position:absolute; left:0; right:0; bottom:0; height:90px;
      background:rgba(255,255,255,.82);
      border-top:1px solid var(--line);
      backdrop-filter: blur(12px);
      display:flex; align-items:center; justify-content:space-around;
      z-index:3; padding-bottom:22px;
    }
    @media (prefers-color-scheme: dark){
      .tabBar{ background:rgba(0,0,0,.45); }
    }
    .tabItem{
      display:flex; flex-direction:column; align-items:center; gap:4px;
      color:var(--muted); cursor:pointer;
      font-size:10px; font-weight:700; user-select:none;
      padding:8px 10px; border-radius:12px;
      -webkit-tap-highlight-color: transparent;
    }
    .tabItem.active{ color:var(--text); }
    .tabIcon{ font-size:18px; opacity:.95; }
    .tabLabel{ font-size:11px; font-weight:800; }

    /* Nav */
    .navBar{
      height:56px; display:flex; align-items:center; justify-content:space-between;
      padding:0 8px; border-bottom:1px solid var(--line);
      position:relative; z-index:2;
      background:rgba(255,255,255,.85);
      backdrop-filter: blur(12px);
    }
    @media (prefers-color-scheme: dark){
      .navBar{ background:rgba(0,0,0,.45); }
    }
    .navTitle{ font-size:16px; font-weight:800; }

    /* Cards */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
    }
    .cardTitle{
      font-size:12px; font-weight:900; letter-spacing:1px;
      color:var(--muted);
      text-transform:uppercase;
      display:flex; align-items:center; gap:8px;
      margin-bottom:10px;
    }
    .replyText{
      font-size:16px;
      line-height:1.75;
      white-space:pre-wrap;
    }
    .metaRow{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;
      color:var(--muted); font-size:12px;
    }
    .chip{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(255,255,255,.55);
    }
    @media (prefers-color-scheme: dark){
      .chip{ background:rgba(0,0,0,.25); }
    }

    .primaryBtn{
      width:100%; padding:16px; border-radius:16px;
      background:var(--btn); color:var(--btnText);
      font-size:16px; font-weight:800;
      border:none; cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .primaryBtn:active{ transform:scale(.99); }

    .dangerBtn{
      width:100%; padding:14px; border-radius:14px;
      background:var(--dangerBg); color:var(--danger);
      border:1px solid rgba(255,0,0,.18);
      font-size:15px; font-weight:800;
      cursor:pointer;
    }

    .menuItem{
      width:100%;
      display:flex; justify-content:space-between; align-items:center;
      padding:16px 8px; border:none; background:transparent;
      border-bottom:1px solid rgba(0,0,0,.04);
      color:var(--text);
      cursor:pointer;
      font-size:16px; font-weight:700;
      -webkit-tap-highlight-color: transparent;
    }
    @media (prefers-color-scheme: dark){
      .menuItem{ border-bottom:1px solid rgba(255,255,255,.06); }
    }
    .menuLeft{ display:flex; gap:12px; align-items:center; }
    .menuIcon{ width:26px; text-align:center; opacity:.9; }
    .right{ color:var(--muted); font-weight:900; }

    .divider{ height:10px; background:transparent; }
    .sectionLabel{
      font-size:12px; font-weight:900; color:var(--muted);
      margin:10px 0 6px 8px; letter-spacing:1px;
      text-transform:uppercase;
    }

    input.text{
      width:100%; padding:14px; border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.65);
      color:var(--text);
      font-size:16px; outline:none;
    }
    @media (prefers-color-scheme: dark){
      input.text{ background:rgba(0,0,0,.25); }
    }
    .inputHint{ font-size:12px; color:var(--muted); margin-top:8px; line-height:1.5; }

    /* Pick page */
    .pickWrap{
      background:#000;
      color:#fff;
      height:100%;
      display:flex;
      flex-direction:column;
    }
    .pickHero{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    }
    .pickDesc{
      color:rgba(255,255,255,.72);
      text-align:center;
      padding:0 22px;
      line-height:1.6;
      font-size:14px;
      max-width:520px;
    }
    .pickFooter{
      height:170px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#000;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .pickRow{ display:flex; gap:24px; }
    .pickAction{
      display:flex; flex-direction:column; align-items:center; gap:12px;
      background:none; border:none; color:#fff; cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pickIconCircle{
      width:76px; height:76px; border-radius:50%;
      background:#1b1b1b; border:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:center;
      font-size:28px;
    }

    /* Toast */
    .toast{
      position:fixed; bottom:40px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.85); color:#fff;
      padding:10px 18px; border-radius:30px;
      font-size:14px; z-index:99;
      max-width:min(520px, 92vw);
      text-align:center;
    }

    /* History */
    .row{
      display:flex; justify-content:space-between; gap:14px;
      padding:14px 0; border-bottom:1px solid var(--line);
      align-items:flex-start;
    }
    .row:last-child{ border-bottom:none; }
    .rowDate{ font-size:13px; color:var(--muted); margin-bottom:6px; }
    .rowText{
      font-size:14px; line-height:1.55;
      color:var(--text);
      max-width:72ch;
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .empty{ text-align:center; color:var(--muted); padding:60px 0; line-height:1.6; }

    /* Footer bar */
    .footer{
      padding:24px;
      border-top:1px solid var(--line);
      background:rgba(255,255,255,.85);
      backdrop-filter: blur(12px);
    }
    @media (prefers-color-scheme: dark){
      .footer{ background:rgba(0,0,0,.45); }
    }
  </style>
</head>

<body>
  <div id="app" class="app"></div>

  <!-- hidden inputs -->
  <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none" />
  <input id="galleryInput" type="file" accept="image/*" style="display:none" />

  <script>
    /* =========================
       Flux v5 ‚Äî Companion Edition (Single File)
       - Hybrid Input + Smart Fallback
       - No score; AI-like A+B replies for any photo
       - Local history, settings, i18n
    ========================= */

    const LS = {
      LANG: "flux.lang_v5",
      NAME: "flux.name_v5",
      HISTORY: "flux.history_v5",
    };

    const I18N = {
      "zh-TW": {
        APP_NAME: "Flux",
        TODAY: "TODAY",
        HELLO: "Êó©ÂÆâ",
        SUB: "Êää‰ªª‰ΩïÁÖßÁâá‰∏üÁµ¶ÊàëÔºåÊàëÊúÉÁî®Ê∫´Êüî + Ê≠£ËÉΩÈáèÈô™‰Ω†Ëµ∞‰∏ÄÊÆµ„ÄÇ",
        CTA: "‰∏äÂÇ≥‰∏ÄÂºµÁÖßÁâá",
        HINT: "Â¶ÇÊûúÁõ∏Ê©üË¢´ WebView ÈôêÂà∂ÔºåÊàëÊúÉËá™ÂãïÊîπÁî®Áõ∏Á∞øÔºå‰∏çÊúÉÂç°‰Ωè„ÄÇ",
        TAB_TODAY: "‰ªäÂ§©",
        TAB_HISTORY: "Á¥ÄÈåÑ",
        TAB_SETTINGS: "Ë®≠ÂÆö",

        PICK_TITLE: "ÈÅ∏ÊìáÊñπÂºè",
        PICK_DESC: "‰Ω†ÊÉ≥ÊãçÁÖßÔºåÈÇÑÊòØÂæûÁõ∏Á∞øÈÅ∏‰∏ÄÂºµÔºüÔºàÊúâ‰∫õÂÖßÂª∫ÁÄèË¶ΩÂô®ÊúÉÈôêÂà∂Áõ∏Ê©üÔºåÈÄôÊòØÊ≠£Â∏∏ÁöÑÔºâ",
        BTN_CAMERA: "ÊãçÁÖß",
        BTN_GALLERY: "Áõ∏Á∞ø",
        BTN_BACK: "ËøîÂõû",
        BTN_CLOSE: "ÈóúÈñâ",
        BTN_DONE: "ÂÆåÊàê",

        REPLY_TITLE: "AI ÂõûË¶Ü",
        META_LIGHT: "ÊòéÊöó",
        META_COLOR: "Ëâ≤Ë™ø",
        META_MOOD: "Ê∞õÂúç",
        META_ENV: "Áí∞Â¢É",
        BTN_SAVE: "Â≠òÊàêÁ¥ÄÈåÑ",
        BTN_HOME: "ÂõûÈ¶ñÈ†Å",

        HISTORY_TITLE: "ÊàëÁöÑÁ¥ÄÈåÑ",
        HISTORY_EMPTY: "ÁõÆÂâçÈÇÑÊ≤íÊúâÁ¥ÄÈåÑ„ÄÇ\n‰Ω†ÂèØ‰ª•Êãç‰∏ÄÂºµÁÖßÁâáÔºåÊàëÊúÉÂõûË¶Ü‰∏ÄÊÆµÈô™‰º¥ÊñáÂ≠ó„ÄÇ",
        SETTINGS_TITLE: "Ë®≠ÂÆö",
        NAME_TITLE: "Á®±ÂëºÊñπÂºè",
        NAME_DESC: "‰Ω†Â∏åÊúõÊàëÊÄéÈ∫ºÁ®±Âëº‰Ω†Ôºü",
        NAME_PH: "‰æãÂ¶ÇÔºöÂà©Ëìâ",
        NAME_HINT: "Áî®ÊñºÈ¶ñÈ†ÅÂïèÂÄôÔºåÂèØÁïôÁ©∫„ÄÇ",
        LANG_TITLE: "Ë™ûË®Ä / Language",
        PRIV_TITLE: "Èö±ÁßÅËàáË≥áÊñô",
        PRIV_DESC: "ÊâÄÊúâË≥áÊñôÂè™Â≠òÂú®‰Ω†ÁöÑÊâãÊ©üÔºàLocalStorageÔºâ„ÄÇÊàëÂÄë‰∏çÊúÉ‰∏äÂÇ≥‰ªª‰ΩïÁÖßÁâáÊàñÁ¥ÄÈåÑ„ÄÇ",
        CLEAR: "Ê∏ÖÁ©∫ÊâÄÊúâË≥áÊñô",
        CLEAR_CONFIRM: "Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÂóéÔºüÈÄôÊúÉÂà™Èô§ÊâÄÊúâÁ¥ÄÈåÑËàáË®≠ÂÆöÔºåÁÑ°Ê≥ïÂæ©Âéü„ÄÇ",
        CLEARED: "Â∑≤Ê∏ÖÁ©∫",
        ENV_OK: "HTTPS ‚úì",
        ENV_BAD: "Èùû HTTPS",
        WEBVIEW: "WebView",
        BROWSER: "Browser",
        TOAST_CAMERA_FALLBACK: "Áõ∏Ê©üÂèØËÉΩË¢´ÂÖßÂª∫ÁÄèË¶ΩÂô®ÈôêÂà∂ ‚Üí Â∑≤ÊîπÁî®Áõ∏Á∞øÈÅ∏Êìá",
        TOAST_SAVED: "Â∑≤Â≠òÂÖ•Á¥ÄÈåÑ",
        TOAST_READ_FAIL: "ËÆÄÂèñÁÖßÁâáÂ§±ÊïóÔºåË´ãÈáçË©¶"
      },
      en: {
        APP_NAME: "Flux",
        TODAY: "TODAY",
        HELLO: "Good morning",
        SUB: "Drop any photo. I‚Äôll respond with gentle care + positive energy.",
        CTA: "Upload a photo",
        HINT: "If camera is blocked in WebView, I‚Äôll auto-fallback to gallery.",
        TAB_TODAY: "Today",
        TAB_HISTORY: "History",
        TAB_SETTINGS: "Settings",

        PICK_TITLE: "Choose",
        PICK_DESC: "Take a photo or pick from gallery. (Some in-app browsers block camera.)",
        BTN_CAMERA: "Camera",
        BTN_GALLERY: "Gallery",
        BTN_BACK: "Back",
        BTN_CLOSE: "Close",
        BTN_DONE: "Done",

        REPLY_TITLE: "AI Reply",
        META_LIGHT: "Light",
        META_COLOR: "Tone",
        META_MOOD: "Mood",
        META_ENV: "Env",
        BTN_SAVE: "Save to history",
        BTN_HOME: "Home",

        HISTORY_TITLE: "History",
        HISTORY_EMPTY: "No records yet.\nUpload a photo and I‚Äôll reply like a supportive friend.",
        SETTINGS_TITLE: "Settings",
        NAME_TITLE: "Your name",
        NAME_DESC: "How should I call you?",
        NAME_PH: "e.g. Alex",
        NAME_HINT: "Used for greetings. Optional.",
        LANG_TITLE: "Language",
        PRIV_TITLE: "Privacy & Data",
        PRIV_DESC: "All data stays on your device (LocalStorage). No uploads.",
        CLEAR: "Clear all data",
        CLEAR_CONFIRM: "Clear everything? This cannot be undone.",
        CLEARED: "Cleared",
        ENV_OK: "HTTPS ‚úì",
        ENV_BAD: "No HTTPS",
        WEBVIEW: "WebView",
        BROWSER: "Browser",
        TOAST_CAMERA_FALLBACK: "Camera may be blocked ‚Üí switched to gallery",
        TOAST_SAVED: "Saved",
        TOAST_READ_FAIL: "Failed to read image"
      },
      ja: {
        APP_NAME: "Flux",
        TODAY: "TODAY",
        HELLO: "„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô",
        SUB: "„Å©„Çì„Å™ÂÜôÁúü„Åß„ÇÇÂ§ß‰∏àÂ§´„ÄÇ„ÇÑ„Åï„Åó„ÅïÔºãÂâçÂêë„Åç„Åï„ÅßËøî‰∫ã„Åó„Åæ„Åô„ÄÇ",
        CTA: "ÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ",
        HINT: "WebView„Åß„Ç´„É°„É©„ÅåÂà∂Èôê„Åï„Çå„Å¶„ÇÇ„ÄÅ„ÇÆ„É£„É©„É™„Éº„Å´Ëá™ÂãïÂàáÊõø„Åó„Åæ„Åô„ÄÇ",
        TAB_TODAY: "‰ªäÊó•",
        TAB_HISTORY: "Ë®òÈå≤",
        TAB_SETTINGS: "Ë®≠ÂÆö",

        PICK_TITLE: "ÈÅ∏Êäû",
        PICK_DESC: "ÊíÆÂΩ±„Åæ„Åü„ÅØÂÜôÁúü„ÇíÈÅ∏Êäû„ÄÇÔºà„Ç¢„Éó„É™ÂÜÖ„Éñ„É©„Ç¶„Ç∂„ÅØ„Ç´„É°„É©Âà∂Èôê„Åå„ÅÇ„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ",
        BTN_CAMERA: "ÊíÆÂΩ±",
        BTN_GALLERY: "ÂÜôÁúü",
        BTN_BACK: "Êàª„Çã",
        BTN_CLOSE: "Èñâ„Åò„Çã",
        BTN_DONE: "ÂÆå‰∫Ü",

        REPLY_TITLE: "AI Ëøî‰ø°",
        META_LIGHT: "Êòé„Çã„Åï",
        META_COLOR: "Ëâ≤Âë≥",
        META_MOOD: "Èõ∞Âõ≤Ê∞ó",
        META_ENV: "Áí∞Â¢É",
        BTN_SAVE: "Ë®òÈå≤„Å´‰øùÂ≠ò",
        BTN_HOME: "„Éõ„Éº„É†",

        HISTORY_TITLE: "Ë®òÈå≤",
        HISTORY_EMPTY: "„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\nÂÜôÁúü„ÇíÈÅ∏„Å∂„Å®„ÄÅÂØÑ„ÇäÊ∑ª„ÅÜË®ÄËëâ„ÅßËøî‰∫ã„Åó„Åæ„Åô„ÄÇ",
        SETTINGS_TITLE: "Ë®≠ÂÆö",
        NAME_TITLE: "„ÅäÂêçÂâç",
        NAME_DESC: "‰Ωï„Å®„ÅäÂëº„Å≥„Åó„Åæ„Åó„Çá„ÅÜ„ÅãÔºü",
        NAME_PH: "‰æãÔºö„Çä„Çà„ÅÜ",
        NAME_HINT: "Êå®Êã∂„Å´Ë°®Á§∫ÔºàÁúÅÁï•ÂèØÔºâ",
        LANG_TITLE: "Ë®ÄË™û / Language",
        PRIV_TITLE: "„Éó„É©„Ç§„Éê„Ç∑„Éº",
        PRIV_DESC: "„Éá„Éº„Çø„ÅØÁ´ØÊú´ÂÜÖÔºàLocalStorageÔºâ„ÅÆ„Åø„ÄÇ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åõ„Çì„ÄÇ",
        CLEAR: "„Åô„Åπ„Å¶ÂâäÈô§",
        CLEAR_CONFIRM: "Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºüÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ",
        CLEARED: "ÂâäÈô§„Åó„Åæ„Åó„Åü",
        ENV_OK: "HTTPS ‚úì",
        ENV_BAD: "HTTPS „Å™„Åó",
        WEBVIEW: "WebView",
        BROWSER: "Browser",
        TOAST_CAMERA_FALLBACK: "„Ç´„É°„É©„ÅåÂà∂Èôê ‚Üí ÂÜôÁúüÈÅ∏Êäû„Å´ÂàáÊõø",
        TOAST_SAVED: "‰øùÂ≠ò„Åó„Åæ„Åó„Åü",
        TOAST_READ_FAIL: "ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
      }
    };

    function t(key){
      const lang = state.lang;
      return (I18N[lang] && I18N[lang][key]) || (I18N["zh-TW"][key]) || key;
    }

    function safeGet(key, fallback=""){
      try{ return localStorage.getItem(key) ?? fallback; }catch{ return fallback; }
    }
    function safeSet(key, value){
      try{ localStorage.setItem(key, value); }catch{}
    }
    function safeJsonGet(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const v = JSON.parse(raw);
        return v ?? fallback;
      }catch{ return fallback; }
    }
    function safeJsonSet(key, value){
      try{ localStorage.setItem(key, JSON.stringify(value)); }catch{}
    }

    function detectLang(){
      const saved = safeGet(LS.LANG, "");
      if (saved && I18N[saved]) return saved;
      const sys = (navigator.language || "").toLowerCase();
      if (sys.startsWith("en")) return "en";
      if (sys.startsWith("ja")) return "ja";
      return "zh-TW";
    }

    function isProbablyWebView(){
      const ua = navigator.userAgent || "";
      // common webview signals (best-effort)
      const isAndroid = /Android/i.test(ua);
      const hasWv = /\bwv\b/i.test(ua);
      const isInstagram = /Instagram/i.test(ua);
      const isLine = /Line/i.test(ua);
      const isFB = /FBAN|FBAV/i.test(ua);
      const isWebViewiOS = /(iPhone|iPad|iPod)/i.test(ua) && !/Safari/i.test(ua);
      return hasWv || isInstagram || isLine || isFB || (isAndroid && hasWv) || isWebViewiOS;
    }

    function isHttps(){
      return location.protocol === "https:" || location.hostname === "localhost";
    }

    function nowISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function toast(msg){
      state.toast = msg;
      render();
      clearTimeout(state.toastTimer);
      state.toastTimer = setTimeout(()=>{ state.toast=""; render(); }, 2200);
    }

    /* =========================
       Image -> features (light/color)
       Works offline; no upload
    ========================= */

    function loadImageFromBlob(blob){
      return new Promise((resolve, reject)=>{
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img); };
        img.onerror = (e)=>{ URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }

    async function extractFeatures(file){
      // read & downscale for analysis only
      const blob = file;
      const img = await loadImageFromBlob(blob);

      const maxEdge = 240; // small for speed
      const scale = Math.min(1, maxEdge / Math.max(img.width, img.height));
      const w = Math.max(1, Math.round(img.width * scale));
      const h = Math.max(1, Math.round(img.height * scale));

      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d", { willReadFrequently:true });
      if(!ctx) throw new Error("NO_CTX");
      ctx.drawImage(img, 0, 0, w, h);

      const data = ctx.getImageData(0,0,w,h).data;

      let rSum=0,gSum=0,bSum=0, count=0;
      let lumSum=0, lumSq=0;
      for(let i=0;i<data.length;i+=4){
        const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
        if(a<16) continue;
        count++;
        rSum += r; gSum += g; bSum += b;
        // relative luminance (approx)
        const lum = 0.2126*r + 0.7152*g + 0.0722*b;
        lumSum += lum;
        lumSq += lum*lum;
      }
      if(count<50) throw new Error("TOO_EMPTY");

      const rAvg = rSum/count;
      const gAvg = gSum/count;
      const bAvg = bSum/count;
      const lumAvg = lumSum/count; // 0..255
      const lumVar = Math.max(0, lumSq/count - lumAvg*lumAvg);
      const contrast = Math.sqrt(lumVar); // 0..~128

      // saturation approx
      let satSum=0;
      for(let i=0;i<data.length;i+=4){
        const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
        if(a<16) continue;
        const max = Math.max(r,g,b);
        const min = Math.min(r,g,b);
        const sat = max === 0 ? 0 : (max-min)/max; // 0..1
        satSum += sat;
      }
      const satAvg = satSum/count; // 0..1

      // dominant tone
      const tone = dominantTone(rAvg,gAvg,bAvg);
      const lightLabel = labelLight(lumAvg);
      const mood = labelMood({ lumAvg, contrast, satAvg, tone });

      return {
        w,h,
        lumAvg,
        contrast,
        satAvg,
        tone,
        lightLabel,
        mood
      };
    }

    function dominantTone(r,g,b){
      // simple hue-ish mapping
      // return one of: warm/cool/neutral/greenish/purplish
      const rg = r - g;
      const rb = r - b;
      const gb = g - b;

      const max = Math.max(r,g,b);
      const min = Math.min(r,g,b);
      const spread = max - min;

      if(spread < 18) return "neutral";

      if(r > g && r > b){
        // warm or pink
        if(b > g) return "purplish";
        return "warm";
      }
      if(b > r && b > g) return "cool";
      if(g > r && g > b) return "greenish";
      return "neutral";
    }

    function labelLight(lumAvg){
      if(lumAvg < 70) return "dark";
      if(lumAvg < 135) return "soft";
      if(lumAvg < 200) return "bright";
      return "verybright";
    }

    function labelMood({ lumAvg, contrast, satAvg, tone }){
      // heuristic mood labels
      const calm = (contrast < 40 && satAvg < 0.35);
      const vivid = satAvg > 0.55;
      const dramatic = contrast > 65 && lumAvg < 140;
      const airy = lumAvg > 165 && contrast < 55;

      if(dramatic) return "dramatic";
      if(airy) return "airy";
      if(vivid) return "vivid";
      if(calm) return "calm";
      return "balanced";
    }

    /* =========================
       Generate A+B reply (no score)
    ========================= */
    function buildReply(lang, name, feat){
      const who = name ? name : "";
      const n = who ? (lang==="en" ? ` ${who}` : lang==="ja" ? `„ÄÅ${who}„Åï„Çì` : `Ôºå${who}`) : "";

      const scene = describeScene(lang, feat);
      const empathy = empathyLine(lang, feat);
      const boost = boostLine(lang, feat);
      const tinyAction = tinyActionLine(lang, feat);

      // A (gentle) + B (positive)
      if(lang==="en"){
        return [
          `I‚Äôm here${n}.`,
          scene,
          empathy,
          boost,
          tinyAction
        ].join("\n\n");
      }
      if(lang==="ja"){
        return [
          `„Åì„Åì„Å´„ÅÑ„Çã„Çà${n}„ÄÇ`,
          scene,
          empathy,
          boost,
          tinyAction
        ].join("\n\n");
      }
      // zh-TW
      return [
        `ÊàëÂú®${n}„ÄÇ`,
        scene,
        empathy,
        boost,
        tinyAction
      ].join("\n\n");
    }

    function describeScene(lang, feat){
      const { tone, lightLabel, mood } = feat;

      const toneText = {
        "zh-TW": { warm:"ÂÅèÊöñ", cool:"ÂÅèÂÜ∑", neutral:"ÂÅè‰∏≠ÊÄß", greenish:"Â∏∂ÈªûÁ∂†ÊÑè", purplish:"Â∏∂ÈªûÁ¥´Á≤â" },
        "en":    { warm:"warm", cool:"cool", neutral:"neutral", greenish:"a hint of green", purplish:"a hint of purple/pink" },
        "ja":    { warm:"„ÅÇ„Åü„Åü„Åã„ÇÅ", cool:"„Å≤„Çì„ÇÑ„Çä", neutral:"„Éã„É•„Éº„Éà„É©„É´", greenish:"Â∞ë„ÅóÁ∑ë", purplish:"Â∞ë„ÅóÁ¥´/„Éî„É≥„ÇØ" }
      }[lang];

      const lightText = {
        "zh-TW": { dark:"ÂÖâÁ∑öÂÅèÊöó", soft:"ÂÖâÁ∑öÊüîÂíå", bright:"ÂÖâÁ∑öÊòé‰∫Æ", verybright:"ÂÖâÁ∑öÈùûÂ∏∏Êòé‰∫Æ" },
        "en":    { dark:"light feels dim", soft:"light feels soft", bright:"light feels bright", verybright:"light feels very bright" },
        "ja":    { dark:"Â∞ë„ÅóÊöó„ÇÅ", soft:"„ÇÑ„Çè„Çâ„Åã„ÅÑÂÖâ", bright:"Êòé„Çã„ÅÑÂÖâ", verybright:"„Å®„Å¶„ÇÇÊòé„Çã„ÅÑÂÖâ" }
      }[lang];

      const moodText = {
        "zh-TW": { calm:"Êï¥È´îÂæàÂÆâÈùú", vivid:"Ëâ≤ÂΩ©ÂæàÊúâÁîüÂëΩÂäõ", dramatic:"Â∞çÊØîÂº∑ÁÉà„ÄÅÊúâÈõªÂΩ±ÊÑü", airy:"ÂæàÈÄöÈÄè„ÄÅÂÉèÂú®ÂëºÂê∏", balanced:"ÁãÄÊÖãÂπ≥Ë°°„ÄÅËàíÊúç" },
        "en":    { calm:"it feels quiet and calm", vivid:"colors feel alive", dramatic:"high contrast, cinematic", airy:"airy, like breathing space", balanced:"balanced and comfortable" },
        "ja":    { calm:"Èùô„Åã„ÅßËêΩ„Å°ÁùÄ„Åè", vivid:"Ëâ≤„Åå„ÅÑ„Åç„ÅÑ„Åç", dramatic:"„Ç≥„É≥„Éà„É©„Çπ„ÉàÂº∑„ÇÅ„ÅßÊò†Áîª„Å£„ÅΩ„ÅÑ", airy:"Á©∫Ê∞ó„ÅåÈÄö„ÇãÊÑü„Åò", balanced:"„Éê„É©„É≥„Çπ„ÅåËâØ„Åè„Å¶ÂøÉÂú∞„ÅÑ„ÅÑ" }
      }[lang];

      if(lang==="en"){
        return `From this photo, the tone feels **${toneText[tone]}**, ${lightText[lightLabel]}, and ${moodText[mood]}.`;
      }
      if(lang==="ja"){
        return `„Åì„ÅÆÂÜôÁúü„ÅØ„ÄÅËâ≤Âë≥„Åå**${toneText[tone]}**„Åß„ÄÅ${lightText[lightLabel]}„ÄÇÂÖ®‰Ωì„ÅØ${moodText[mood]}ÊÑü„Åò„ÄÇ`;
      }
      return `ÊàëÁúãÈÄôÂºµÁÖßÁâáÔºöËâ≤Ë™ø**${toneText[tone]}**„ÄÅ${lightText[lightLabel]}ÔºåËÄå‰∏î${moodText[mood]}„ÄÇ`;
    }

    function empathyLine(lang, feat){
      const { mood, lightLabel } = feat;

      const zh = [
        "‰Ω†È°òÊÑèÊääÈÄô‰∏ÄÂàª‰∫§Áµ¶ÊàëÔºå‰ª£Ë°®‰Ω†ÂÖ∂ÂØ¶Â∑≤Á∂ìÂæàÂä™Âäõ‰∫Ü„ÄÇ",
        "Êàë‰∏çÊÄ•Ëëó‰∏ãÁµêË´ñÔºåÊàëÂÄëÂÖà‰∏ÄËµ∑ÊääÊÉÖÁ∑íÊîæÂú®Ê°å‰∏ä„ÄÅÊÖ¢ÊÖ¢ÁúãÊ∏ÖÊ•ö„ÄÇ",
        "Â∞±ÁÆó‰ªäÂ§©ÊúâÈªû‰∫ÇÔºå‰πüÊ≤íÈóú‰øÇÔºå‰Ω†‰∏çÁî®‰∏ÄÂÄã‰∫∫Êâõ„ÄÇ"
      ];

      const en = [
        "Thank you for sharing this moment with me. You‚Äôre already trying, and that matters.",
        "We don‚Äôt need a verdict‚Äîlet‚Äôs just hold the feeling gently and look at it together.",
        "Even if today is messy, you don‚Äôt have to carry it alone."
      ];

      const ja = [
        "„Åì„ÅÆÁû¨Èñì„ÇíË¶ã„Åõ„Å¶„Åè„Çå„Å¶„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÇ„ÅÇ„Å™„Åü„ÅØÂçÅÂàÜ„Å´È†ëÂºµ„Å£„Å¶„Çã„ÄÇ",
        "ÁµêË´ñ„ÇíÊÄ•„Åå„Å™„Åè„Å¶„ÅÑ„ÅÑ„Çà„ÄÇÊ∞óÊåÅ„Å°„Çí„Åù„Å£„Å®ÁΩÆ„ÅÑ„Å¶„ÄÅ‰∏ÄÁ∑í„Å´Áú∫„ÇÅ„Çà„ÅÜ„ÄÇ",
        "‰ªäÊó•„ÅØÂ∞ë„Åó‰π±„Çå„Å¶„ÅÑ„Å¶„ÇÇÂ§ß‰∏àÂ§´„ÄÇ„Å≤„Å®„Çä„ÅßÊä±„Åà„Å™„Åè„Å¶„ÅÑ„ÅÑ„ÄÇ"
      ];

      const pick = (arr)=>arr[(hashSeed(feat) % arr.length)];

      // slight adaptation by mood
      if(lang==="en"){
        if(mood==="dramatic" || lightLabel==="dark") return pick(en);
        return pick(en);
      }
      if(lang==="ja"){
        return pick(ja);
      }
      return pick(zh);
    }

    function boostLine(lang, feat){
      const { mood, tone } = feat;

      const zhByMood = {
        calm: [
          "ÈÄôÁ®ÆÂÆâÈùú‰∏çÊòØÁ©∫ÁôΩÔºåÂÆÉÊòØÂú®Âπ´‰Ω†ÊääÂøÉÊî∂Âõû‰æÜ„ÄÇ",
          "‰Ω†ÁöÑÁØÄÂ•èÊ≠£Âú®ÂõûÂà∞‰Ω†Ëá™Â∑±Ë∫´‰∏äÔºåÈÄôÂæàÁèçË≤¥„ÄÇ"
        ],
        vivid: [
          "‰Ω†Ë∫´‰∏äÂÖ∂ÂØ¶ÊúâÂæàÂ§öËÉΩÈáèÔºåÂè™ÊòØÊúâÊôÇÂÄôË¢´ÁîüÊ¥ªËìã‰Ωè‰∫Ü„ÄÇ",
          "ÈÄôÂºµÁÖßÁâáÁöÑÁîüÂëΩÂäõÂæàÂº∑ÔºåÂÉèÊòØÂú®ÊèêÈÜí‰Ω†Ôºö‰Ω†‰πüÂèØ‰ª•ÈáçÊñ∞Áôº‰∫Æ„ÄÇ"
        ],
        dramatic: [
          "ÊúâÈõªÂΩ±ÊÑü‰∏ç‰ª£Ë°®Âç±Èö™ÔºåÂèçËÄåÂÉèÊòØ‰∏ÄÁ®Æ„Äé‰Ω†Ê≠£Âú®ËõªËÆä„ÄèÁöÑ‰ø°Ëôü„ÄÇ",
          "‰Ω†ÁèæÂú®ÁöÑÂÖßÂú®ÂºµÂäõÂæàÂ§ßÔºå‰ΩÜÈÇ£‰πüÊòØ‰Ω†Ëµ∞ÂêëÊõ¥Âº∑ÁöÑÂÖ•Âè£„ÄÇ"
        ],
        airy: [
          "ÈÄôÁ®ÆÈÄöÈÄèÊÑüÂæàÂÉèÔºö‰Ω†ÈñãÂßãÂÖÅË®±Ëá™Â∑±ÂëºÂê∏„ÄÅÊîæÈ¨Ü„ÄÅË¢´ÁÖßÈ°ß„ÄÇ",
          "‰Ω†Âú®ÂæÄÊõ¥ËºïÁöÑÂú∞ÊñπËµ∞ÔºåÊÖ¢ÊÖ¢‰æÜÂ∞±Â•Ω„ÄÇ"
        ],
        balanced: [
          "‰Ω†ÂÖ∂ÂØ¶ÊØî‰Ω†‰ª•ÁÇ∫ÁöÑÊõ¥Á©©ÔºåÈÄôÂ∞±ÊòØ‰Ω†ÁöÑÂ∫ïÊ∞£„ÄÇ",
          "‰Ω†Ê≠£Âú®ÊääÁîüÊ¥ªÈáçÊñ∞Êï¥ÁêÜÂõûÂèØÊéßÁöÑÊ®£Â≠ê„ÄÇ"
        ]
      };

      const enByMood = {
        calm: [
          "Quiet doesn‚Äôt mean empty‚Äîit‚Äôs your mind coming back home.",
          "Your pace is returning to you. That‚Äôs something to protect."
        ],
        vivid: [
          "You have a lot of energy inside‚Äîsometimes life just covers it up.",
          "This photo feels alive, like a reminder that you can shine again."
        ],
        dramatic: [
          "Cinematic doesn‚Äôt mean dangerous. It can be a sign you‚Äôre transforming.",
          "The tension you feel can be the doorway to your next stronger self."
        ],
        airy: [
          "This openness feels like permission to breathe, soften, and be cared for.",
          "You‚Äôre moving toward something lighter. Take it slow."
        ],
        balanced: [
          "You‚Äôre steadier than you think‚Äîthat‚Äôs your foundation.",
          "You‚Äôre quietly putting life back into something you can hold."
        ]
      };

      const jaByMood = {
        calm: [
          "Èùô„Åë„Åï„ÅØÁ©∫„Å£„ÅΩ„Åò„ÇÉ„Å™„ÅÑ„ÄÇÂøÉ„ÅåÂÆ∂„Å´Êàª„Å£„Å¶„Åç„Å¶„Çã„ÄÇ",
          "„ÅÇ„Å™„Åü„ÅÆ„Éö„Éº„Çπ„Åå„ÅÇ„Å™„Åü„Å´Êàª„Å£„Å¶„Çã„ÄÇ„Åù„Çå„ÅØÂÆà„Çã‰æ°ÂÄ§„Åå„ÅÇ„Çã„ÄÇ"
        ],
        vivid: [
          "„ÅÇ„Å™„Åü„ÅÆ‰∏≠„Å´„ÅØ„Ç®„Éç„É´„ÇÆ„Éº„Åå„ÅÇ„Çã„ÄÇÁîüÊ¥ª„ÅåÈö†„Åó„Å¶„Åó„Åæ„ÅÜ„Å†„Åë„ÄÇ",
          "„Åì„ÅÆÂÜôÁúü„ÅØÁîü„ÅçÁîü„Åç„Åó„Å¶„Çã„ÄÇ„ÅÇ„Å™„Åü„ÇÇ„Åæ„ÅüËºù„Åë„Çã„Çà„ÄÇ"
        ],
        dramatic: [
          "Êò†Áîª„Å£„ÅΩ„Åï„ÅØÂç±Èô∫„Åò„ÇÉ„Å™„ÅÑ„ÄÇÂ§âÂåñ„ÅÆ„Çµ„Ç§„É≥„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„ÄÇ",
          "‰ªä„ÅÆÂºµ„Çä„Å§„ÇÅ„ÅØ„ÄÅÊ¨°„ÅÆÂº∑„Åï„Å∏„ÅÆÂÖ•Âè£„Å´„Å™„Çå„Çã„ÄÇ"
        ],
        airy: [
          "„Åì„ÅÆÈñãÊîæÊÑü„ÅØ„ÄÅÊÅØ„Çí„Åó„Å¶„ÅÑ„ÅÑ„Çà„Å£„Å¶„ÅÑ„ÅÜË®±ÂèØ„Åø„Åü„ÅÑ„ÄÇ",
          "ËªΩ„ÅÑ„Åª„ÅÜ„Å∏Âêë„Åã„Å£„Å¶„Çã„ÄÇ„ÇÜ„Å£„Åè„Çä„ÅßÂ§ß‰∏àÂ§´„ÄÇ"
        ],
        balanced: [
          "„ÅÇ„Å™„Åü„ÅØÊÄù„Å£„Å¶„Çã‰ª•‰∏ä„Å´ÂÆâÂÆö„Åó„Å¶„Çã„ÄÇ„Åù„Çå„ÅåÂúüÂè∞„ÄÇ",
          "Â∞ë„Åó„Åö„Å§ÁîüÊ¥ª„ÇíÊä±„ÅàÁõ¥„Åó„Å¶„ÇãÊÑü„Åò„Åå„Åô„Çã„ÄÇ"
        ]
      };

      const table = (lang==="en") ? enByMood : (lang==="ja") ? jaByMood : zhByMood;
      const arr = table[mood] || table.balanced;

      // small tone nuance
      const seed = hashSeed(feat) + (tone==="warm"?7:tone==="cool"?13:3);
      return arr[Math.abs(seed)%arr.length];
    }

    function tinyActionLine(lang, feat){
      const { lightLabel, mood } = feat;

      const zh = [
        "Â¶ÇÊûú‰Ω†È°òÊÑèÔºöÁèæÂú®Âñù‰∏ÄÂè£Ê∞¥„ÄÅÊ∑±ÂëºÂê∏‰∏âÊ¨°ÔºåÁÑ∂ÂæåË∑üÊàëË™™„ÄåÊàëÈÇÑÂú®„Äç„ÄÇ",
        "‰Ω†ÂèØ‰ª•ÂÅö‰∏ÄÂÄãÂæàÂ∞èÁöÑÂãï‰ΩúÔºöÊääËÇ©ËÜÄÊîæÈ¨Ü 3 ÁßíÔºåËÆìË∫´È´îÂÖàÂÆâÂÖ®„ÄÇ",
        "‰ªäÂ§©‰∏çÈúÄË¶ÅÊää‰∏ÄÂàáËß£Ê±∫ÔºåÂè™Ë¶ÅÊääËá™Â∑±ÁÖßÈ°ßÂ•ΩÂ∞±ÁÆóË¥è„ÄÇ"
      ];
      const en = [
        "If you want: take one sip of water, breathe three times, and tell me: ‚ÄúI‚Äôm still here.‚Äù",
        "Try a tiny action: soften your shoulders for 3 seconds‚Äîlet your body feel safe first.",
        "You don‚Äôt have to solve everything today. Caring for yourself is already a win."
      ];
      const ja = [
        "„Çà„Åã„Å£„Åü„ÇâÔºöÊ∞¥„Çí„Å≤„Å®Âè£„ÄÅÊ∑±ÂëºÂê∏„Çí3Âõû„Åó„Å¶„ÄåÁßÅ„ÅØ„Åì„Åì„Å´„ÅÑ„Çã„Äç„Å®Ë®Ä„Å£„Å¶„Åø„Å¶„ÄÇ",
        "Â∞è„Åï„Å™Ë°åÂãïÔºöËÇ©„ÅÆÂäõ„Çí3Áßí„Å†„ÅëÊäú„ÅÑ„Å¶„ÄÅ„Åæ„Åö‰Ωì„ÇíÂÆâÂøÉ„Åï„Åõ„Çà„ÅÜ„ÄÇ",
        "‰ªäÊó•„ÅØÂÖ®ÈÉ®Ëß£Ê±∫„Åó„Å™„Åè„Å¶„ÅÑ„ÅÑ„ÄÇËá™ÂàÜ„Çí„Ç±„Ç¢„Åß„Åç„Åü„ÇâÂçÅÂàÜ„ÄÇ"
      ];

      const seed = hashSeed(feat) + (lightLabel==="dark"?9:2) + (mood==="dramatic"?5:0);
      const pick = (arr)=>arr[Math.abs(seed)%arr.length];

      if(lang==="en") return pick(en);
      if(lang==="ja") return pick(ja);
      return pick(zh);
    }

    function hashSeed(feat){
      // deterministic seed from numeric features (stable)
      const a = Math.round(feat.lumAvg * 10);
      const b = Math.round(feat.contrast * 10);
      const c = Math.round(feat.satAvg * 1000);
      const t = (feat.tone==="warm"?11:feat.tone==="cool"?23:feat.tone==="greenish"?37:feat.tone==="purplish"?41:7);
      return (a*2654435761 ^ b*1597334677 ^ c*3812015801 ^ t) >>> 0;
    }

    /* =========================
       State
    ========================= */
    const state = {
      page: "home", // home | pick | reply | history | settings | name | language | privacy
      lang: detectLang(),
      name: safeGet(LS.NAME, ""),
      history: safeJsonGet(LS.HISTORY, []),
      analyzing: false,
      lastReply: null, // { replyText, meta, at }
      toast: "",
      toastTimer: null,
      env: {
        https: isHttps(),
        webview: isProbablyWebView()
      }
    };

    function persist(){
      safeSet(LS.LANG, state.lang);
      safeSet(LS.NAME, state.name);
      safeJsonSet(LS.HISTORY, state.history);
    }

    /* =========================
       Hybrid input + Smart fallback
    ========================= */
    const cameraInput = document.getElementById("cameraInput");
    const galleryInput = document.getElementById("galleryInput");

    cameraInput.addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      e.target.value = "";
      if(file) handleFile(file);
    });

    galleryInput.addEventListener("change", (e)=>{
      const file = e.target.files && e.target.files[0];
      e.target.value = "";
      if(file) handleFile(file);
    });

    function openGallery(){
      // always works
      galleryInput.click();
    }

    function openCameraSmart(){
      // We try camera first. If it doesn't open (common in in-app browsers),
      // auto fallback to gallery after a short delay.
      let opened = false;
      const start = Date.now();

      // When file picker opens, JS pauses in many browsers.
      // We'll schedule a fallback check.
      try{
        cameraInput.click();
        opened = true;
      }catch{
        opened = false;
      }

      // Fallback: if nothing happened after ~700ms, open gallery.
      setTimeout(()=>{
        // If user didn't pick anything and we are still on pick/home, fallback.
        // This is best-effort: can't truly detect picker open; we ensure user has a path.
        const elapsed = Date.now() - start;
        const stillNoReply = !state.analyzing && state.page !== "reply";
        if(stillNoReply && elapsed >= 650){
          toast(t("TOAST_CAMERA_FALLBACK"));
          openGallery();
        }
      }, 720);
    }

    async function handleFile(file){
      state.analyzing = true;
      state.page = "home";
      render();

      try{
        // tiny delay for UX
        await new Promise(r=>setTimeout(r, 220));
        const feat = await extractFeatures(file);

        const replyText = buildReply(state.lang, state.name, feat);
        const meta = buildMeta(state.lang, feat);

        state.lastReply = {
          id: Date.now(),
          at: nowISO(),
          replyText,
          meta
        };
        state.page = "reply";
      }catch(err){
        console.error(err);
        toast(t("TOAST_READ_FAIL"));
        state.page = "home";
      }finally{
        state.analyzing = false;
        render();
      }
    }

    function buildMeta(lang, feat){
      const lightMap = {
        "zh-TW": { dark:"ÂÅèÊöó", soft:"ÊüîÂíå", bright:"Êòé‰∫Æ", verybright:"Âæà‰∫Æ" },
        "en":    { dark:"dim", soft:"soft", bright:"bright", verybright:"very bright" },
        "ja":    { dark:"Êöó„ÇÅ", soft:"„ÇÑ„Çè„Çâ„Åã„ÅÑ", bright:"Êòé„Çã„ÅÑ", verybright:"„Åã„Å™„ÇäÊòé„Çã„ÅÑ" }
      }[lang];

      const toneMap = {
        "zh-TW": { warm:"ÂÅèÊöñ", cool:"ÂÅèÂÜ∑", neutral:"‰∏≠ÊÄß", greenish:"Á∂†ÊÑè", purplish:"Á¥´Á≤â" },
        "en":    { warm:"warm", cool:"cool", neutral:"neutral", greenish:"greenish", purplish:"purple/pink" },
        "ja":    { warm:"„ÅÇ„Åü„Åü„Åã„ÇÅ", cool:"„Å≤„Çì„ÇÑ„Çä", neutral:"„Éã„É•„Éº„Éà„É©„É´", greenish:"Á∑ë„Å£„ÅΩ„ÅÑ", purplish:"Á¥´/„Éî„É≥„ÇØ" }
      }[lang];

      const moodMap = {
        "zh-TW": { calm:"ÂÆâÈùú", vivid:"ÊúâÁîüÂëΩÂäõ", dramatic:"ÈõªÂΩ±ÊÑü", airy:"ÈÄöÈÄè", balanced:"ËàíÊúçÂπ≥Ë°°" },
        "en":    { calm:"calm", vivid:"vivid", dramatic:"cinematic", airy:"airy", balanced:"balanced" },
        "ja":    { calm:"ËêΩ„Å°ÁùÄ„Åè", vivid:"„ÅÑ„Åç„ÅÑ„Åç", dramatic:"Êò†Áîª„Å£„ÅΩ„ÅÑ", airy:"ÈÄö„ÇãÊÑü„Åò", balanced:"„Éê„É©„É≥„ÇπËâØ„ÅÑ" }
      }[lang];

      const envLabel = state.env.webview ? t("WEBVIEW") : t("BROWSER");
      const httpsLabel = state.env.https ? t("ENV_OK") : t("ENV_BAD");

      return {
        light: lightMap[feat.lightLabel],
        tone: toneMap[feat.tone],
        mood: moodMap[feat.mood],
        env: `${envLabel} ¬∑ ${httpsLabel}`
      };
    }

    function saveToHistory(){
      if(!state.lastReply) return;
      const rec = {
        id: state.lastReply.id,
        at: state.lastReply.at,
        lang: state.lang,
        replyText: state.lastReply.replyText,
        meta: state.lastReply.meta
      };
      state.history = [rec, ...state.history].slice(0, 200);
      persist();
      toast(t("TOAST_SAVED"));
      render();
    }

    function clearAll(){
      const ok = confirm(t("CLEAR_CONFIRM"));
      if(!ok) return;
      try{
        Object.keys(localStorage).forEach(k=>{
          if(k.startsWith("flux.")) localStorage.removeItem(k);
        });
      }catch{}
      state.name = "";
      state.lang = detectLang();
      state.history = [];
      state.lastReply = null;
      persist();
      toast(t("CLEARED"));
      state.page = "home";
      render();
    }

    /* =========================
       UI render
    ========================= */
    function icon(name){
      // simple emoji icons (no external libs)
      const map = {
        gear:"‚öôÔ∏è",
        back:"‚Üê",
        close:"‚úï",
        camera:"üì∏",
        gallery:"üñºÔ∏è",
        spark:"‚ú®",
        user:"üë§",
        globe:"üåê",
        shield:"üõ°Ô∏è",
        trash:"üóëÔ∏è",
        history:"üóìÔ∏è",
        home:"ü™Ñ",
        heart:"üíõ"
      };
      return map[name] || "‚Ä¢";
    }

    function setPage(p){ state.page = p; render(); }

    function greeting(){
      const base = t("HELLO");
      if(!state.name) return base;
      if(state.lang==="en") return `${base}, ${state.name}.`;
      if(state.lang==="ja") return `${base}„ÄÅ${state.name}„Åï„Çì„ÄÇ`;
      return `${base}Ôºå${state.name}„ÄÇ`;
    }

    function topPill(){
      const env = state.env.webview ? t("WEBVIEW") : t("BROWSER");
      const https = state.env.https ? t("ENV_OK") : t("ENV_BAD");
      return `${env} ¬∑ ${https}`;
    }

    function homeView(){
      return `
        <div class="page">
          <div class="glowBg"></div>
          <div class="topBar">
            <div class="brand">
              <span>${t("APP_NAME")}</span>
              <span class="pill">${topPill()}</span>
            </div>
            <button class="iconBtn" id="goSettings" aria-label="settings">${icon("gear")}</button>
          </div>

          <div class="content">
            <div class="center">
              <div class="todayLabel">${t("TODAY")}</div>
              <h1 class="greetingTitle">${escapeHtml(greeting())}</h1>
              <p class="greetingSub">${escapeHtml(t("SUB"))}</p>

              <div class="bigCircleBtn" id="bigCapture" aria-label="capture">
                <div class="circleRing"></div>
                <div class="camIcon">
                  ${state.analyzing ? `<div class="spinner"></div>` : `${icon("camera")}`}
                </div>
              </div>

              <div class="cta">${state.analyzing ? "..." : escapeHtml(t("CTA"))}</div>
              <div class="homeHint">${escapeHtml(t("HINT"))}</div>
            </div>
          </div>

          <div class="tabBar">
            <div class="tabItem active" id="tabHome">
              <div class="tabIcon">${icon("home")}</div>
              <div class="tabLabel">${t("TAB_TODAY")}</div>
            </div>
            <div class="tabItem" id="tabHistory">
              <div class="tabIcon">${icon("history")}</div>
              <div class="tabLabel">${t("TAB_HISTORY")}</div>
            </div>
            <div class="tabItem" id="tabSettings">
              <div class="tabIcon">${icon("spark")}</div>
              <div class="tabLabel">${t("TAB_SETTINGS")}</div>
            </div>
          </div>
        </div>
      `;
    }

    function pickView(){
      return `
        <div class="page">
          <div class="pickWrap">
            <div class="navBar" style="border-bottom:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.55);">
              <button class="iconBtn" id="pickBack" aria-label="back" style="color:#fff">${icon("close")}</button>
              <div class="navTitle" style="color:#fff">${t("PICK_TITLE")}</div>
              <div style="width:40px;"></div>
            </div>

            <div class="pickHero">
              <div class="pickDesc">
                ${escapeHtml(t("PICK_DESC"))}
              </div>
            </div>

            <div class="pickFooter">
              <div class="pickRow">
                <button class="pickAction" id="pickCamera" aria-label="camera">
                  <div class="pickIconCircle">${icon("camera")}</div>
                  <div style="font-weight:800">${t("BTN_CAMERA")}</div>
                </button>

                <button class="pickAction" id="pickGallery" aria-label="gallery">
                  <div class="pickIconCircle">${icon("gallery")}</div>
                  <div style="font-weight:800">${t("BTN_GALLERY")}</div>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function replyView(){
      if(!state.lastReply) return homeView();
      const r = state.lastReply;

      return `
        <div class="page">
          <div class="navBar">
            <button class="iconBtn" id="replyBack" aria-label="back">${icon("back")}</button>
            <div class="navTitle">${t("REPLY_TITLE")}</div>
            <button class="iconBtn" id="replyClose" aria-label="close">${icon("close")}</button>
          </div>

          <div class="content">
            <div class="card">
              <div class="cardTitle">${icon("heart")} ${t("REPLY_TITLE")}</div>
              <div class="replyText">${escapeHtml(r.replyText)}</div>

              <div class="metaRow">
                <span class="chip">${t("META_LIGHT")}: ${escapeHtml(r.meta.light)}</span>
                <span class="chip">${t("META_COLOR")}: ${escapeHtml(r.meta.tone)}</span>
                <span class="chip">${t("META_MOOD")}: ${escapeHtml(r.meta.mood)}</span>
                <span class="chip">${t("META_ENV")}: ${escapeHtml(r.meta.env)}</span>
              </div>

              <div style="height:14px"></div>
              <button class="primaryBtn" id="saveHistory">${t("BTN_SAVE")}</button>
              <div style="height:10px"></div>
              <button class="dangerBtn" id="goHome">${t("BTN_HOME")}</button>
            </div>
          </div>
        </div>
      `;
    }

    function historyView(){
      const list = state.history || [];
      const body = list.length ? list.map(item=>{
        return `
          <div class="row">
            <div style="flex:1">
              <div class="rowDate">${escapeHtml(item.at)}</div>
              <div class="rowText">${escapeHtml(item.replyText)}</div>
            </div>
            <div class="right">‚Ä∫</div>
          </div>
        `;
      }).join("") : `<div class="empty">${escapeHtml(t("HISTORY_EMPTY"))}</div>`;

      return `
        <div class="page">
          <div class="navBar">
            <button class="iconBtn" id="histBack" aria-label="back">${icon("back")}</button>
            <div class="navTitle">${t("HISTORY_TITLE")}</div>
            <div style="width:40px"></div>
          </div>

          <div class="content">
            <div class="card">${body}</div>
          </div>
        </div>
      `;
    }

    function settingsView(){
      return `
        <div class="page">
          <div class="navBar">
            <button class="iconBtn" id="setBack" aria-label="back">${icon("back")}</button>
            <div class="navTitle">${t("SETTINGS_TITLE")}</div>
            <div style="width:40px"></div>
          </div>

          <div class="content">
            <div class="card">
              <button class="menuItem" id="goName">
                <div class="menuLeft">
                  <div class="menuIcon">${icon("user")}</div>
                  <div>${t("NAME_TITLE")}</div>
                </div>
                <div class="right">‚Ä∫</div>
              </button>

              <button class="menuItem" id="goLang">
                <div class="menuLeft">
                  <div class="menuIcon">${icon("globe")}</div>
                  <div>${t("LANG_TITLE")}</div>
                </div>
                <div class="right">‚Ä∫</div>
              </button>

              <button class="menuItem" id="goPrivacy">
                <div class="menuLeft">
                  <div class="menuIcon">${icon("shield")}</div>
                  <div>${t("PRIV_TITLE")}</div>
                </div>
                <div class="right">‚Ä∫</div>
              </button>
            </div>

            <div class="divider"></div>
            <div class="sectionLabel">${t("PRIV_TITLE")}</div>

            <div class="card">
              <div style="color:var(--muted); line-height:1.7">${escapeHtml(t("PRIV_DESC"))}</div>
              <div style="height:14px"></div>
              <button class="dangerBtn" id="clearAll">${icon("trash")} ${t("CLEAR")}</button>
            </div>
          </div>
        </div>
      `;
    }

    function nameView(){
      return `
        <div class="page">
          <div class="navBar">
            <button class="iconBtn" id="nameBack" aria-label="back">${icon("back")}</button>
            <div class="navTitle">${t("NAME_TITLE")}</div>
            <div style="width:40px"></div>
          </div>

          <div class="content">
            <div class="card">
              <div style="font-weight:900; margin-bottom:10px">${t("NAME_DESC")}</div>
              <input class="text" id="nameInput" value="${escapeAttr(state.name)}" placeholder="${escapeAttr(t("NAME_PH"))}" />
              <div class="inputHint">${escapeHtml(t("NAME_HINT"))}</div>
              <div style="height:14px"></div>
              <button class="primaryBtn" id="nameSave">${t("BTN_DONE")}</button>
            </div>
          </div>
        </div>
      `;
    }

    function languageView(){
      const item = (code,label)=>`
        <button class="menuItem" data-lang="${code}">
          <div class="menuLeft">
            <div class="menuIcon">${state.lang===code ? "‚úÖ" : "‚ñ´Ô∏è"}</div>
            <div>${label}</div>
          </div>
          <div class="right">‚Ä∫</div>
        </button>
      `;
      return `
        <div class="page">
          <div class="navBar">
            <button class="iconBtn" id="langBack" aria-label="back">${icon("back")}</button>
            <div class="navTitle">${t("LANG_TITLE")}</div>
            <div style="width:40px"></div>
          </div>

          <div class="content">
            <div class="card" id="langList">
              ${item("zh-TW","ÁπÅÈ´î‰∏≠Êñá")}
              ${item("en","English")}
              ${item("ja","Êó•Êú¨Ë™û")}
            </div>
          </div>
        </div>
      `;
    }

    function privacyView(){
      return `
        <div class="page">
          <div class="navBar">
            <button class="iconBtn" id="privBack" aria-label="back">${icon("back")}</button>
            <div class="navTitle">${t("PRIV_TITLE")}</div>
            <div style="width:40px"></div>
          </div>

          <div class="content">
            <div class="card">
              <div style="line-height:1.7; color:var(--muted)">${escapeHtml(t("PRIV_DESC"))}</div>
              <div style="height:14px"></div>
              <div class="metaRow">
                <span class="chip">${escapeHtml(topPill())}</span>
              </div>
              <div style="height:14px"></div>
              <button class="dangerBtn" id="clearAll2">${icon("trash")} ${t("CLEAR")}</button>
            </div>
          </div>
        </div>
      `;
    }

    function render(){
      const app = document.getElementById("app");
      let html = "";
      switch(state.page){
        case "home": html = homeView(); break;
        case "pick": html = pickView(); break;
        case "reply": html = replyView(); break;
        case "history": html = historyView(); break;
        case "settings": html = settingsView(); break;
        case "name": html = nameView(); break;
        case "language": html = languageView(); break;
        case "privacy": html = privacyView(); break;
        default: html = homeView();
      }
      app.innerHTML = html + (state.toast ? `<div class="toast">${escapeHtml(state.toast)}</div>` : "");

      bindEvents();
    }

    function bindEvents(){
      // Home
      const goSettings = document.getElementById("goSettings");
      if(goSettings) goSettings.onclick = ()=>setPage("settings");

      const bigCapture = document.getElementById("bigCapture");
      if(bigCapture) bigCapture.onclick = ()=>setPage("pick");

      const tabHistory = document.getElementById("tabHistory");
      if(tabHistory) tabHistory.onclick = ()=>setPage("history");

      const tabSettings = document.getElementById("tabSettings");
      if(tabSettings) tabSettings.onclick = ()=>setPage("settings");

      // Pick
      const pickBack = document.getElementById("pickBack");
      if(pickBack) pickBack.onclick = ()=>setPage("home");

      const pickCamera = document.getElementById("pickCamera");
      if(pickCamera) pickCamera.onclick = ()=>openCameraSmart();

      const pickGallery = document.getElementById("pickGallery");
      if(pickGallery) pickGallery.onclick = ()=>openGallery();

      // Reply
      const replyBack = document.getElementById("replyBack");
      if(replyBack) replyBack.onclick = ()=>setPage("home");

      const replyClose = document.getElementById("replyClose");
      if(replyClose) replyClose.onclick = ()=>setPage("home");

      const saveHistoryBtn = document.getElementById("saveHistory");
      if(saveHistoryBtn) saveHistoryBtn.onclick = ()=>saveToHistory();

      const goHomeBtn = document.getElementById("goHome");
      if(goHomeBtn) goHomeBtn.onclick = ()=>setPage("home");

      // History
      const histBack = document.getElementById("histBack");
      if(histBack) histBack.onclick = ()=>setPage("home");

      // Settings
      const setBack = document.getElementById("setBack");
      if(setBack) setBack.onclick = ()=>setPage("home");

      const goName = document.getElementById("goName");
      if(goName) goName.onclick = ()=>setPage("name");

      const goLang = document.getElementById("goLang");
      if(goLang) goLang.onclick = ()=>setPage("language");

      const goPrivacy = document.getElementById("goPrivacy");
      if(goPrivacy) goPrivacy.onclick = ()=>setPage("privacy");

      const clearAllBtn = document.getElementById("clearAll");
      if(clearAllBtn) clearAllBtn.onclick = ()=>clearAll();

      // Name
      const nameBack = document.getElementById("nameBack");
      if(nameBack) nameBack.onclick = ()=>setPage("settings");

      const nameSave = document.getElementById("nameSave");
      if(nameSave){
        nameSave.onclick = ()=>{
          const input = document.getElementById("nameInput");
          state.name = (input && input.value || "").trim();
          persist();
          setPage("settings");
        };
      }

      // Language
      const langBack = document.getElementById("langBack");
      if(langBack) langBack.onclick = ()=>setPage("settings");

      const langList = document.getElementById("langList");
      if(langList){
        langList.querySelectorAll("button[data-lang]").forEach(btn=>{
          btn.onclick = ()=>{
            const code = btn.getAttribute("data-lang");
            if(I18N[code]){
              state.lang = code;
              persist();
              render();
            }
          };
        });
      }

      // Privacy
      const privBack = document.getElementById("privBack");
      if(privBack) privBack.onclick = ()=>setPage("settings");

      const clearAll2 = document.getElementById("clearAll2");
      if(clearAll2) clearAll2.onclick = ()=>clearAll();
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){ return escapeHtml(str).replaceAll("\n"," "); }

    // Initial render
    persist();
    render();
  </script>
</body>
</html>
